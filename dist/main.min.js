(function(){
(()=>{const a=({pos:l,prevPos:m})=>l!==m,b=({minScale:l,maxScale:m,scale:n})=>n<=m&&n>=l,c=({minScale:l,maxScale:m,scale:n})=>({pos:p,prevPos:r,translate:q})=>b({minScale:l,maxScale:m,scale:n})&&a({pos:p,prevPos:r})?q+(p-r*n)*(1-1/n):q,d=({scale:l,minScale:m,maxScale:n,scaleSensitivity:p,deltaScale:r})=>[l,Math.max(m,Math.min(l+r/(p/l),n))],e=({scale:l,translateX:m,translateY:n})=>`matrix(${l}, 0, 0, ${l}, ${m}, ${n})`,g=({state:l,originX:m,originY:n})=>{l.transformation.translateX+=m;l.transformation.translateY+=
n;l.element.style.transform=e({scale:l.transformation.scale,translateX:l.transformation.translateX,translateY:l.transformation.translateY})},f=l=>({panBy:({originX:m,originY:n})=>g({state:l,originX:m,originY:n}),panTo:({originX:m,originY:n,scale:p})=>{l.transformation.scale=p;g({state:l,originX:m-l.transformation.translateX,originY:n-l.transformation.translateY})}}),h=l=>({zoom:({x:m,y:n,deltaScale:p,scaleSensitivity:r})=>{const {left:q,top:z}=l.element.getBoundingClientRect(),{minScale:A,maxScale:y,
defaultScaleSensitivity:t}=l,[w,u]=d({scale:l.transformation.scale,deltaScale:p,minScale:A,maxScale:y,scaleSensitivity:r||t});p=m-q;r=n-z;n=p/w;m=r/w;const x=c({scale:w,minScale:A,maxScale:y});p=x({pos:p,prevPos:l.transformation.originX,translate:l.transformation.translateX});r=x({pos:r,prevPos:l.transformation.originY,translate:l.transformation.translateY});l.element.style.transformOrigin=`${n/l.containerScale}px ${m/l.containerScale}px`;l.element.style.transform=e({scale:u,translateX:p/l.containerScale,
translateY:r/l.containerScale});l.transformation={originX:n,originY:m,translateX:p,translateY:r,scale:u}}}),k=l=>({getScale:()=>+l.transformation.scale,setScale:m=>{l.transformation.scale=+m},getScaleSensitivity:()=>+l.defaultScaleSensitivity,setScaleSensitivity:m=>{l.defaultScaleSensitivity=+m},setMinScale:m=>{l.minScale=+m},setMaxScale:m=>{l.maxScale=+m},getMinScale:()=>+l.minScale,getMaxScale:()=>+l.maxScale,setContainerScale:m=>{l.containerScale=+m},reset:()=>{g({state:l,originX:0-l.transformation.translateX,
originY:0-l.transformation.translateY});l.element.style.transformOrigin="";l.element.style.transform="";l.transformation={originX:0,originY:0,translateX:0,translateY:0,scale:1}},setState:({transformation:m,style:n})=>{l.transformation=Object.assign({},m);l.element.style.transformOrigin=n.transformOrigin;l.element.style.transform=n.transform},getState:()=>({transformation:Object.assign({},l.transformation),style:{transformOrigin:l.element.style.transformOrigin,transform:l.element.style.transform}})});
window.renderer=({minScale:l,maxScale:m,element:n,containerScale:p=1,scaleSensitivity:r=10})=>{l={element:n,minScale:l,maxScale:m,defaultScaleSensitivity:r,containerScale:p,transformation:{originX:0,originY:0,translateX:0,translateY:0,scale:1}};return Object.assign({},h(l),f(l),k(l))}})();(()=>{function a(d,e,g){c.ws=d;c.mm=new GPModulesManager_(e,g);c.sm=c.mm.getSettingsManager();c.app=b;c.mm.setModules([{id:0,name:"GPProxy_",required:!0,hidden:!0},{id:6,name:"GPAbout_",required:!0,hidden:!0},{id:9,name:"GPActivation_",required:!0,hidden:!0},{id:10,name:"GPAvatars_",required:!0,hiddenSettings:!0},{id:2,name:"GPPlayersManager_"},{id:8,name:"GPReference_"},{id:4,name:"GPPainter_"}],this,c)}const b={author:"liliezzzz",name:"gp-mod",version:"10.2",changelogURL:"https://discord.com/channels/929715202600095775/953145081471324270/1105901535721963541",
summaryURL:"",updateNoticeFlag:"false",updateNoticeText:"",discordURL:"https://discord.gg/hynZCVZyzN",donateURL:"https://boosty.to/gpmod"};if(function(){return navigator.userAgentData?.brands.some(d=>"Chromium"===d.brand)}()){var c={ws:null,gpproxy:null,reference:null,act:null,av:null,abt:null};document.addEventListener("_ws",({detail:{ws:d,authData:e,l10n:g}})=>{c.gpproxy?c.gpproxy.setWebSocket(d):a(d,e,g);window.ws=d});(function(){var d;if(null!=(d=document.getElementById("__next"))){d=d.classList;
var e=d.toggle;var g=!!document.querySelector("#__next > .side > div")?.firstElementChild?.getBoundingClientRect().height;e.call(d,"gp-ad-not-found_",!g)}})();console.log("gpmod: loaded")}else console.error(`${b.name}: Browser not supported`)})();class GPAbout_{static HEADER_MIN_SCALE=.625;static UPDATE_NOTICE_STORAGE="gp_update";static NOTICE_TYPE={SCRIPTS:"scripts",UPDATE:"update",TWITCH_TOKEN:"twitch_token",RAID:"raid",NORMAL:"normal"};static NOTICE={[this.NOTICE_TYPE.SCRIPTS]:{priority:1,unique:!0},[this.NOTICE_TYPE.UPDATE]:{priority:2,unique:!0},[this.NOTICE_TYPE.TWITCH_TOKEN]:{priority:3,unique:!0},[this.NOTICE_TYPE.RAID]:{priority:4,unique:!0},[this.NOTICE_TYPE.NORMAL]:{priority:5,unique:!1}};static MODULE={title:"About"};static INIT(a,
b){a.abt=new GPAbout_(a.app,b)}constructor({name:a,author:b,version:c,changelogURL:d,summaryURL:e,updateNoticeFlag:g,updateNoticeText:f,discordURL:h,donateURL:k},l){this.l=l;this.version=c;this.changelogURL=d;this.summaryURL=e||d;this.updateNoticeFlag=JSON.parse(g);this.updateNoticeText=f;this.notificationQueue=[];this.notificationId=0;this.currentNotice=null;this.closeNotice=this.closeNotice.bind(this);window.addEventListener("resize",this.resizeHandler.bind(this));document.addEventListener("_gp_notice",
({detail:m})=>{this.addNotice(m)});document.addEventListener("_outdated-scripts",({detail:{outdatedScripts:m}})=>{m.size&&(this.printOutdatedScripts(m),this.addNotice({type:GPAbout_.NOTICE_TYPE.SCRIPTS,scripts:m}))});this.render(a,b,c,d,h,k);this.resizeHandler();this.shouldUpdateNoticeBeShown()&&this.addNotice({type:GPAbout_.NOTICE_TYPE.UPDATE,text:this.updateNoticeText,url:this.summaryURL});this.requestOutdatedScripts()}render(a,b,c,d,e,g){this.container=document.createElement("div");this.container.className=
"gp-about_";this.container.innerHTML=`${a} <span>v<span class="version_"><a class="changelog-link_" target="_blank" href="${d}" title="${this.l.CHANGELOG_TTL}">${c}</a></span></span>`;this.versionElem=this.container.querySelector(".version_");e&&(a=document.createTextNode("\u00a0\u00a0|\u00a0\u00a0"),this.container.appendChild(a),a=document.createElement("a"),a.className="discord-link_",a.target="_blank",a.href=e,a.title=this.l.DISCORD_LINK_TTL,a.textContent=e.split("//")[1],this.container.appendChild(a));
g&&(e=document.createTextNode("\u00a0\u00a0|\u00a0\u00a0"),this.container.appendChild(e),e=document.createElement("a"),e.className="donate-link_",e.target="_blank",e.href=g,e.title=this.l.DONATE_LINK_TTL,e.textContent=this.l.DONATE_LINK,this.container.appendChild(e));document.body.appendChild(this.container)}resizeHandler(a){a=Math.max(GPAbout_.HEADER_MIN_SCALE,this.getContainerScale());this.container.style.fontSize=`${16*a}px`;this.container.style.lineHeight=`${28*a}px`;this.updateUpdateNoticePos()}getContainerScale(){let a=
(window.innerWidth-180)/1150;766*a>window.innerHeight&&(a=window.innerHeight/766);return a}shouldUpdateNoticeBeShown(){if(!this.updateNoticeFlag)return!1;const a=window.localStorage.getItem(GPAbout_.UPDATE_NOTICE_STORAGE)||"0.0";return this.isNewVersion(this.version,a,2)}isNewVersion(a,b,c=0){const [d,e]=[a,b].map(g=>g.split(".").map(f=>+f));a=Math.max(d.length,e.length);a=c&&Math.min(a,c)||a;for(c=0;c<a;c++){b=d[c]??0;const g=e[c]??0;if(b!==g)return b>g}return!1}updateUpdateNoticePos(){if(this.notice){var {width:a}=
this.versionElem.getBoundingClientRect(),{width:b}=this.notice.getBoundingClientRect();this.notice.style.left=`calc(-${Math.floor((b-a)/2)}px)`}}requestOutdatedScripts(){document.dispatchEvent(new Event("_get-outdated-scripts"))}printOutdatedScripts(a){a.size&&console.warn(`Outdated Scripts:\n${[...a.values()].map(b=>`${b.name} (${b.version} \u2794 ${b.latestVersion}): ${b.url}?${Date.now()}.user.js`).join("\n")}`)}updateScript(a){document.dispatchEvent(new CustomEvent("_update-script",{detail:{name:a}}))}addNotice(a){const b=
Object.assign({},a,{id:++this.notificationId});GPAbout_.NOTICE[b.type].unique&&(this.currentNotice?.type===b.type?this.closeNotice():(a=this.notificationQueue.findIndex(c=>c.type===b.type),~a&&this.notificationQueue.splice(a,1)));this.notificationQueue.push(b);this.notificationQueue.sort((c,d)=>GPAbout_.NOTICE[c.type].priority-GPAbout_.NOTICE[d.type].priority);this.currentNotice&&GPAbout_.NOTICE[this.currentNotice.type].priority===GPAbout_.NOTICE[this.notificationQueue[0].type].priority||this.showNotice(this.notificationQueue[0])}showNotice(a){this.currentNotice=
a;this.notice?.remove();this.notice=document.createElement(a.url?"a":"div");this.notice.className="gp-update-notice_";this.notice.dataset.type=a.type;this.notice.innerHTML=this.buildNoticeMessage(a.text||(a.type===GPAbout_.NOTICE_TYPE.UPDATE?this.l.UPDATE_NOTICE:""));if(a.style)for(var b in a.style)this.notice.style[b]=a.style[b];a.url&&(this.notice.href=a.url,this.notice.target="_blank",this.notice.title=this.l.NOTICE_URL_TTL);a.onClick&&this.notice.addEventListener("click",a.onClick);(a.url||a.onClick)&&
this.notice.addEventListener("click",this.closeNotice);a.scripts&&(b=this.buildScripts(a.scripts),this.notice.appendChild(b));b=document.createElement("div");b.className="close-btn_";b.textContent="\u2716";b.title="";b.addEventListener("click",c=>{c.preventDefault();c.stopPropagation();this.closeNotice(c);if(a.onClose)a.onClose()});this.notice.appendChild(b);this.versionElem.appendChild(this.notice);this.updateUpdateNoticePos()}closeNotice(a){this.currentNotice.type===GPAbout_.NOTICE_TYPE.UPDATE&&
window.localStorage.setItem(GPAbout_.UPDATE_NOTICE_STORAGE,this.version);this.notice.remove();this.notice=null;a=this.notificationQueue.indexOf(this.currentNotice);~a&&this.notificationQueue.splice(a,1);this.currentNotice=null;this.showNextNotice()}showNextNotice(){this.notificationQueue.length&&this.showNotice(this.notificationQueue[0])}buildNoticeMessage(a){return a?a.split("\n").map(b=>`<div class="text">${b}</div>`).join(""):""}buildScripts(a){const b=document.createElement("div");b.className=
"scripts_";var c=document.createElement("div");c.className="title_";c.textContent="\u041e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u044f \u0441\u043a\u0440\u0438\u043f\u0442\u043e\u0432";b.appendChild(c);const d=document.createElement("div");d.className="reload-row_";c=document.createElement("a");c.className="reload-btn_";c.href="/";c.textContent="\u041f\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443";c.addEventListener("click",
g=>{g.preventDefault();window.onbeforeunload=null;location.reload()});c.addEventListener("auxclick",g=>{g.preventDefault()});d.appendChild(c);const e=new Set;Array.from(a.values()).forEach((g,f)=>{var h=`${g.url}?${Date.now()}.user.js`;const k=document.createElement("div");k.className="oudated-script_";var l=document.createElement("div");l.textContent=g.name;k.appendChild(l);l=document.createElement("div");l.textContent=`${g.version} \u2794 ${g.latestVersion}`;k.appendChild(l);g=document.createElement("div");
k.appendChild(g);const m=document.createElement("a");m.className="script-update-link_";m.href=h;m.target="_blank";m.textContent="\u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c";h=n=>{e.add(f);e.size>=a.size&&d.classList.add("shown_");m.closest(".oudated-script_").classList.add("clicked_")};m.addEventListener("click",h);m.addEventListener("auxclick",h);g.appendChild(m);b.appendChild(k)});b.appendChild(d);return b}}window.GPAbout_=GPAbout_;class GPActivation_ extends EventTarget{static AUTH_FILENAME_STORAGE="gp_auth-filename";static ACTIVATION_KEY_PATTERN=/^[a-zA-Z0-9]{32}:\d{14,16}$/;static DEFAULT_SETTINGS={activationKey:"",publicKey:"",filename:""};static SETTINGS_UI={activationKey:{type:"input",args:{hidden:!0},description:"\u041a\u043b\u044e\u0447 \u0430\u043a\u0442\u0438\u0432\u0430\u0446\u0438\u0438"}};static MODULE={title:"Activation",settings:{storage:"gp_activation",defaultSettings:this.DEFAULT_SETTINGS,ui:this.SETTINGS_UI}};static INIT(a){a.act=
new GPActivation_(a.sm)}constructor(a){super();this.s=a.setSettings(this,this.updateSettings);this.subsStatus=!1;this.keyMark=null;this.updateSubsStatus=this.updateSubsStatus.bind(this);this.broadcastSubsStatus=this.broadcastSubsStatus.bind(this);this.setActivationKey=this.setActivationKey.bind(this);document.addEventListener("_auth_perms",this.updateSubsStatus);this.initAuthFilenameStorage();this.updateKeyMark();this.broadcastPublicKey();document.dispatchEvent(new CustomEvent("_act_init",{detail:{pasteKey:this.setActivationKey}}))}initAuthFilenameStorage(){localStorage.setItem(GPActivation_.AUTH_FILENAME_STORAGE,
this.s.filename)}broadcastPublicKey(){document.dispatchEvent(new CustomEvent("_auth_key",{detail:{publicKey:this.s.publicKey}}))}updateKeyMark(){this.keyMark=this.km(this.s.publicKey)}getKeyMark(){return this.keyMark}km(a){let b=-559038737,c=1103547991;for(let d=0,e;d<a.length;d++)e=a.charCodeAt(d),b=Math.imul(b^e,2654435761),c=Math.imul(c^e,1597334677);b=Math.imul(b^b>>>16,2246822507)^Math.imul(c^c>>>13,3266489909);c=Math.imul(c^c>>>16,2246822507)^Math.imul(b^b>>>13,3266489909);return 4294967296*
(2097151&c)+(b>>>0)}updateSubsStatus({detail:{ps:a}}){this.subsStatus=!!(256&a);this.broadcastSubsStatus(a)}broadcastSubsStatus(a){document.dispatchEvent(new CustomEvent("_subs_status",{detail:{status:this.subsStatus,ps:a}}))}setActivationKey(a){return GPActivation_.ACTIVATION_KEY_PATTERN.test(a)?(this.s.activationKey=a,!0):!1}updateSettings({detail:{settings:a}}){if("activationKey"in a){const [b,c]=a.activationKey.split(":");this.s.publicKey=b??"";this.s.filename=c??"";this.initAuthFilenameStorage();
this.updateKeyMark();this.broadcastPublicKey();document.dispatchEvent(new Event("_auth_key_changed"))}}}window.GPActivation_=GPActivation_;class GPAvatarEditor_ extends EventTarget{static AVATAR_WIDTH=42;static AVATAR_HEIGHT=50;static AVATAR_PADDING=1;static AVATAR_SMOOTH_DENSITY=2;static AVATAR_DENSITY=3;static AVATAR_FRAME_WIDTH=46;static AVATAR_FRAME_BORDER_WIDTH=2;static VIEWFINDER_WIDTH=374;static VIEWFINDER_HEIGHT=240;static OVERFLOWING_AREA_BORDER_WIDTH=2;static COLOR_PICKER_UPDATE_INTERVAL=50;static LIVE_PREVIEW_ENABLED=!0;static ZOOM_SENSITIVITY=1.03;static IMAGE_SMOOTHING_ENABLED=!0;static HAS_FOREGROUND=!0;static BACKGROUND_COLOR="#eaf1fd";static AVATAR_TYPE="image/webp";static AVATAR_QUALITY=1;static IMAGE_TYPES=new Set("image/jpeg image/png image/gif image/webp image/svg+xml image/bmp".split(" "));static IMAGE_TYPES_WITHOUT_TRANSPARENCY=["image/jpeg"];constructor(a,
b,c,d,e,g){super();this.l=g;this.updatePreview=this.updatePreview.bind(this);this.updatePreviewHandler=this.updatePreviewHandler.bind(this);this.handleFile=this.handleFile.bind(this);this.livePreviewEnabled=a??GPAvatarEditor_.LIVE_PREVIEW_ENABLED;this.zoomSensitivity=b??GPAvatarEditor_.ZOOM_SENSITIVITY;this.imageSmoothingEnabled=c??GPAvatarEditor_.IMAGE_SMOOTHING_ENABLED;this.hasForeground=d??GPAvatarEditor_.HAS_FOREGROUND;this.backgroundColor=e??GPAvatarEditor_.BACKGROUND_COLOR;this.isChanged=this.isDragging=
!1;this.render();this.updateAvatarViews()}getElement(){return this.container}render(){this.container=document.createElement("div");this.container.className="avatar-editor";this.container.classList.toggle("has-foreground",this.hasForeground);this.container.style.setProperty("--av-editor-viewfinder-width",`${GPAvatarEditor_.VIEWFINDER_WIDTH}px`);this.container.style.setProperty("--av-editor-viewfinder-height",`${GPAvatarEditor_.VIEWFINDER_HEIGHT}px`);this.container.style.setProperty("--av-editor-focus-width",
`${GPAvatarEditor_.AVATAR_WIDTH*GPAvatarEditor_.AVATAR_DENSITY}px`);this.container.style.setProperty("--av-editor-focus-height",`${GPAvatarEditor_.AVATAR_HEIGHT*GPAvatarEditor_.AVATAR_DENSITY}px`);this.container.style.setProperty("--av-editor-focus-frame-width",`${GPAvatarEditor_.AVATAR_FRAME_WIDTH*GPAvatarEditor_.AVATAR_DENSITY}px`);this.container.style.setProperty("--av-editor-focus-frame-border-width",`${GPAvatarEditor_.AVATAR_FRAME_BORDER_WIDTH*GPAvatarEditor_.AVATAR_DENSITY}px`);this.container.style.setProperty("--av-editor-focus-frame-shadow-radius",
`${(Math.ceil(Math.sqrt(GPAvatarEditor_.VIEWFINDER_WIDTH**2+GPAvatarEditor_.VIEWFINDER_HEIGHT**2))-GPAvatarEditor_.AVATAR_FRAME_WIDTH)/2}px`);this.container.style.setProperty("--av-editor-overflowing-area-width",`${GPAvatarEditor_.AVATAR_WIDTH*GPAvatarEditor_.AVATAR_DENSITY+2*GPAvatarEditor_.OVERFLOWING_AREA_BORDER_WIDTH}px`);this.container.style.setProperty("--av-editor-overflowing-area-height",`${(GPAvatarEditor_.AVATAR_HEIGHT-GPAvatarEditor_.AVATAR_WIDTH/2)*GPAvatarEditor_.AVATAR_DENSITY+2*GPAvatarEditor_.OVERFLOWING_AREA_BORDER_WIDTH}px`);
this.container.style.setProperty("--av-editor-overflowing-area-border-width",`${GPAvatarEditor_.OVERFLOWING_AREA_BORDER_WIDTH}px`);this.container.style.setProperty("--av-editor-avatar-background",this.backgroundColor);this.viewfinder=document.createElement("div");this.viewfinder.className="viewfinder";this.container.appendChild(this.viewfinder);this.viewfinder.addEventListener("dropenter",()=>{},!0);this.viewfinder.addEventListener("dropleave",()=>{},!0);this.viewfinder.addEventListener("pointerdown",
e=>{0!==e.button||e.ctrlKey?(1===e.button||0===e.button&&e.ctrlKey)&&this.saveCanvas(this.buildAvatar()):(this.isDragging=!0,this.livePreviewEnabled||(this.clearViewfinderFocus(),this.focusFrame.classList.remove("rendered")),this.viewfinder.addEventListener("pointerup",g=>{this.isDragging=!1;this.updatePreviewHandler(g)},{once:!0}))});this.viewfinder.addEventListener("wheel",e=>{this.updatePreviewHandler(e);!this.livePreviewEnabled&&this.isDragging&&this.clearViewfinderFocus()});this.viewfinder.addEventListener("drop",
this.handleFile,!0);this.viewfinder.addEventListener("dragover",e=>{e.preventDefault();e.dataTransfer.dropEffect="move"},!0);this.source=document.createElement("canvas");this.source.className="source";this.source.width=GPAvatarEditor_.VIEWFINDER_WIDTH;this.source.height=GPAvatarEditor_.VIEWFINDER_HEIGHT;this.viewfinder.appendChild(this.source);this.sourceCtx=this.source.getContext("2d");this.zoomer=new GPCanvasZoomer_(this.source,null,this.zoomSensitivity);this.zoomer.addEventListener("change",this.updatePreviewHandler);
var a=document.createElement("div");a.className="blackout";this.viewfinder.appendChild(a);a=document.createElement("div");a.className="overflowing-area";this.viewfinder.appendChild(a);this.focusFrame=document.createElement("div");this.focusFrame.className="focus-frame";this.viewfinder.appendChild(this.focusFrame);this.focus=document.createElement("canvas");this.focus.className="focus";this.focus.width=GPAvatarEditor_.AVATAR_WIDTH*GPAvatarEditor_.AVATAR_DENSITY*2;this.focus.height=GPAvatarEditor_.AVATAR_HEIGHT*
GPAvatarEditor_.AVATAR_DENSITY*2;this.viewfinder.appendChild(this.focus);this.focusCtx=this.focus.getContext("2d");this.focusCtx.imageSmoothingEnabled=this.imageSmoothingEnabled;this.focusCtx.imageSmoothingQuality="high";this.preview=document.createElement("div");this.preview.className="preview";this.preview.innerHTML='<div class="user"><div class="avatar"><div class="icon"></div></div></div>';this.container.appendChild(this.preview);this.previewAvatar=this.preview.querySelector(".icon");a=document.createElement("div");
a.className="buttons";this.fgModeBtn=document.createElement("div");this.fgModeBtn.className="fg-mode btn";this.fgModeBtn.title=this.l.FG_MODE_BTN_TTL;this.fgModeBtn.addEventListener("click",this.toggleForegroundMode.bind(this));a.appendChild(this.fgModeBtn);var b=document.createElement("div");b.className="mirror btn";b.title=this.l.MIRROR_BTN_TTL;b.addEventListener("click",e=>{this.mirror()});a.appendChild(b);const c=document.createElement("input");c.className="bg-color-input";c.type="color";c.addEventListener("input",
e=>{this.container.style.setProperty("--av-editor-avatar-background",e.target.value);clearTimeout(this.bgColorTimer);this.bgColorTimer=setTimeout(()=>{this.setBackground(e.target.value)},GPAvatarEditor_.COLOR_PICKER_UPDATE_INTERVAL)});c.addEventListener("change",e=>{clearTimeout(this.bgColorTimer);this.setBackground(e.target.value)});b=document.createElement("div");b.className="bg-color btn";b.title=this.l.BG_COLOR_BTN_TTL;b.appendChild(c);b.addEventListener("click",e=>{c.showPicker()});a.appendChild(b);
const d=document.createElement("input");d.className="open-image-input";d.type="file";d.accept=[...GPAvatarEditor_.IMAGE_TYPES].join();d.addEventListener("change",this.handleFile);b=document.createElement("div");b.className="open-image btn";b.title=this.l.OPEN_IMAGE_BTN_TTL;b.addEventListener("click",e=>{d.click()});a.appendChild(b);this.container.appendChild(a)}buildAvatar(){const a=GPAvatarEditor_.AVATAR_SMOOTH_DENSITY;var b=GPAvatarEditor_.AVATAR_WIDTH*GPAvatarEditor_.AVATAR_DENSITY*a,c=GPAvatarEditor_.AVATAR_HEIGHT*
GPAvatarEditor_.AVATAR_DENSITY*a;const d=b/2,e=document.createElement("canvas");e.width=b;e.height=c;var g=e.getContext("2d");g.beginPath();g.arc(d,c-d,d,0,2*Math.PI);g.fill();this.hasForeground&&g.fillRect(0,0,b,c-b/2);g=document.createElement("canvas");g.width=b;g.height=c;const f=g.getContext("2d");f.fillStyle=this.backgroundColor;f.beginPath();f.arc(d,c-d,d,0,2*Math.PI);f.fill();f.drawImage(this.source,(GPAvatarEditor_.VIEWFINDER_WIDTH-b/a)/2,(GPAvatarEditor_.VIEWFINDER_HEIGHT-(c/a*2-b/a))/2,
b/a,c/a,0,0,b,c);f.globalCompositeOperation="destination-in";f.drawImage(e,0,0);b=document.createElement("canvas");b.width=g.width/a+2*GPAvatarEditor_.AVATAR_PADDING*GPAvatarEditor_.AVATAR_DENSITY;b.height=g.height/a;c=b.getContext("2d");c.imageSmoothingEnabled=this.imageSmoothingEnabled;c.imageSmoothingQuality="high";c.drawImage(g,GPAvatarEditor_.AVATAR_PADDING*GPAvatarEditor_.AVATAR_DENSITY,0,g.width/a,g.height/a);return b}saveCanvas(a){const b=document.createElement("canvas");b.width=a.width;b.height=
a.height;b.getContext("2d").drawImage(a,0,0,a.width,a.height);a=document.createElement("a");a.href=b.toDataURL(GPAvatarEditor_.AVATAR_TYPE,GPAvatarEditor_.AVATAR_QUALITY);a.download=`gp-avatar.${GPAvatarEditor_.AVATAR_TYPE.split("/")[1]}`;a.click()}updatePreviewHandler(a){if("change"===a.type||0===a.button)if(this.livePreviewEnabled||"pointerup"===a.type||"wheel"===a.type)this.updateAvatarViews(),"pointerup"===a.type&&this.dispatchChange()}updateAvatarViews(){this.updateViewfinderFocus();this.updatePreview()}updatePreview(){const a=
this.buildAvatar().toDataURL(GPAvatarEditor_.AVATAR_TYPE,GPAvatarEditor_.AVATAR_QUALITY);this.previewAvatar.style.backgroundImage=`url(${a})`}updateViewfinderFocus(){this.focusFrame.classList.add("rendered");this.focusCtx.save();const a=GPAvatarEditor_.AVATAR_WIDTH*GPAvatarEditor_.AVATAR_DENSITY*2,b=GPAvatarEditor_.AVATAR_HEIGHT*GPAvatarEditor_.AVATAR_DENSITY*2,c=a/2,d=document.createElement("canvas");d.width=a;d.height=b;const e=d.getContext("2d");e.beginPath();e.arc(c,b-c,c,0,2*Math.PI);e.fill();
this.hasForeground&&e.fillRect(0,0,a,b-a/2);this.focusCtx.clearRect(0,0,a,b);this.focusCtx.fillStyle=this.backgroundColor;this.focusCtx.beginPath();this.focusCtx.arc(c,b-c,c,0,2*Math.PI);this.focusCtx.fill();this.focusCtx.drawImage(this.source,(GPAvatarEditor_.VIEWFINDER_WIDTH-a/2)/2,(GPAvatarEditor_.VIEWFINDER_HEIGHT-(b/2*2-a/2))/2,a/2,b/2,0,0,a,b);this.focusCtx.globalCompositeOperation="destination-in";this.focusCtx.drawImage(d,0,0);this.focusCtx.restore()}clearViewfinderFocus(){this.focusCtx.clearRect(0,
0,this.focus.width,this.focus.height)}setSource(a){const b=new Image;b.src=a;b.decode().then(()=>{this.zoomer.setImage(b);this.clearViewfinderFocus();this.isChanged=!0;this.dispatchChange()})}async imageCantHaveAlphaChannel(a){return GPAvatarEditor_.IMAGE_TYPES_WITHOUT_TRANSPARENCY.includes(a.type)?!0:!1}pngHasAlpha(a){a=new DataView(a);if(2303741511===a.getUint32(0)&&218765834===a.getUint32(4))return a=a.getUint8(25),4===a||6===a}async handleFile(a){a.preventDefault();a=a.target.files||a.dataTransfer.files;
if(a?.length&&(a=Array.from(a).find(b=>GPAvatarEditor_.IMAGE_TYPES.has(b.type)))){const b=await this.imageCantHaveAlphaChannel(a);b&&this.setForegroundState(!1);this.changeFgModeBtnState(b);const c=new FileReader;c.addEventListener("loadend",d=>{this.setSource(c.result)});c.readAsDataURL(a)}}dispatchChange(){this.isChanged&&this.dispatchEvent(new Event("change"))}setLivePreview(a){this.livePreviewEnabled=!!a}setBackground(a){this.backgroundColor=a;this.isDragging||(this.updateAvatarViews(),this.dispatchChange());
this.dispatchEvent(new CustomEvent("background-color-changed",{detail:{backgroundColor:a}}))}setForegroundState(a){a!==this.hasForeground&&(this.hasForeground=a,this.container.classList.toggle("has-foreground",this.hasForeground),this.updateAvatarViews(),this.dispatchChange(),this.dispatchEvent(new CustomEvent("foreground-mode-changed",{detail:{foregroundMode:a}})))}setZoomSensitivity(a){this.zoomSensitivity=a;this.zoomer.setScaleFactor(a)}setImageSmoothing(a){this.imageSmoothingEnabled=!!a;this.focusCtx.imageSmoothingEnabled=
!!a;this.updateAvatarViews();this.dispatchChange()}toggleForegroundMode(){this.setForegroundState(!this.hasForeground)}changeFgModeBtnState(a){this.fgModeBtn.classList.toggle("disabled",!!a)}mirror(){this.zoomer.mirror();this.updateAvatarViews();this.dispatchChange()}requestAvatar(){return new Promise(a=>{this.buildAvatar().toBlob(a,GPAvatarEditor_.AVATAR_TYPE,GPAvatarEditor_.AVATAR_QUALITY)})}}window.GPAvatarEditor_=GPAvatarEditor_;class GPAvatars_ extends EventTarget{static URL="https://gpmod.github.io/avatars/{service}/{filename}";static NOTICE_COLORS={REVIEW:11726246,REMOVAL:12467260};static REQUEST_TYPE={REVIEW:"review",REMOVAL:"removal"};static DEFAULT_SETTINGS={zoomSensitivity:1.03,livePreview:!0,imageSmoothing:!0,hasForeground:!1,backgroundColor:"#cb55e2"};static SETTINGS_UI={editor:{type:"component",args:[this.getEditor]},reviewButtons:{type:"buttons",args:[this.getButtons]},_1:{size:"small"},livePreview:{type:"checkbox",
description:"\u0412\u043a\u043b\u044e\u0447\u0430\u0435\u0442 \u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044e \u043f\u0440\u0435\u0432\u044c\u044e \u0430\u0432\u0430\u0442\u0430\u0440\u0430 \u0432 \u0440\u0435\u0430\u043b\u044c\u043d\u043e\u043c \u0432\u0440\u0435\u043c\u0435\u043d\u0438 (\u0432\u043b\u0438\u044f\u0435\u0442 \u043d\u0430 \u043f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c \u043f\u0440\u0438 \u043f\u043e\u0437\u0438\u0446\u0438\u043e\u043d\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0438 \u0430\u0432\u0430\u0442\u0430\u0440\u0430 \u0432 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0435)"},
zoomSensitivity:{type:"range",args:[1.01,1.1,.01],formatter:this.zoomSensitivityFormatter,description:"\u0427\u0443\u0432\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c \u043c\u0430\u0441\u0448\u0442\u0430\u0431\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0430\u0432\u0430\u0442\u0430\u0440\u0430 \u0432 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0435"},imageSmoothing:{type:"checkbox",description:"\u0412\u043a\u043b\u044e\u0447\u0430\u0435\u0442 \u0441\u0433\u043b\u0430\u0436\u0438\u0432\u0430\u043d\u0438\u0435 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f"}};static zoomSensitivityFormatter(a){return Math.trunc(100*
(a-1))}static getEditor(){return GPAvatars_.instance.getEditor()}static getButtons(){return[GPAvatars_.instance.reviewBtn,GPAvatars_.instance.removalBtn]}static MODULE={title:"Avatars",dependencies:["GPAvatarEditor_"],settings:{storage:"gp_avatars",defaultSettings:this.DEFAULT_SETTINGS,ui:this.SETTINGS_UI}};static INIT(a,b){a.av=new GPAvatars_(a.gpproxy,a.sm,a.act,b)}constructor(a,b,c,d){if(GPAvatars_.instance)return GPAvatars_.instance;super();GPAvatars_.instance=this;this.gpproxy=a;this.act=c;this.l=
d;this.s=b.setSettings(this,this.updateSettings);this.avatarsStates=new Map;this.pendingStates=new Set;this.editor=new GPAvatarEditor_(this.s.livePreview,this.s.zoomSensitivity,this.s.imageSmoothing,this.s.hasForeground,this.s.backgroundColor,this.l);this.isSubscribed=!1;this.handlePlayer=this.handlePlayer.bind(this);this.handleAlbumItem=this.handleAlbumItem.bind(this);this.sendToReview=this.sendToReview.bind(this);this.submitRemovalRequest=this.submitRemovalRequest.bind(this);a=new GPPlayersObserver_(a);
a.addHandler(this.handlePlayer);a.addResultHandler(this.handlePlayer);a.addAlbumHandler(this.handleAlbumItem);this.editor.addEventListener("foreground-mode-changed",({detail:{foregroundMode:e}})=>{this.s.hasForeground=e});this.editor.addEventListener("background-color-changed",({detail:{backgroundColor:e}})=>{this.s.backgroundColor=e});this.editor.addEventListener("change",()=>{this.reviewBtn.classList.remove("disabled_")});document.addEventListener("_av_complete",({detail:{type:e}})=>{e===GPAvatars_.REQUEST_TYPE.REVIEW&&
this.removalBtn.classList.remove("disabled_")},{once:!0});document.addEventListener("_av_complete",({detail:{type:e}})=>{e===GPAvatars_.REQUEST_TYPE.REVIEW?(this.reviewBtn.classList.add("complete_"),this.removalBtn.classList.remove("disabled_")):(this.removalBtn.classList.add("complete_"),this.editor.isChanged&&this.reviewBtn.classList.remove("disabled_"))});document.addEventListener("_av_error",({detail:{type:e}})=>{e===GPAvatars_.REQUEST_TYPE.REVIEW?this.reviewBtn.classList.remove("disabled_"):
this.removalBtn.classList.remove("disabled_")});document.addEventListener("_subs_status",({detail:{status:e}})=>{this.isSubscribed=e;this.reviewBtn.classList.toggle("inactivated_",!e);this.removalBtn.classList.toggle("inactivated_",!e);GPAvatars_.toggleSettingsVisibility(e)});this.gpproxy.addEventListener("presets",()=>{this.gpproxy.isAuthorized&&(this.url=GPAvatars_.URL.replace("{service}",this.gpproxy.getAuthType()?.[0]))},{once:!0});this.init()}init(){this.reviewBtn=document.createElement("div");
this.reviewBtn.className="av-review-btn_";this.reviewBtn.classList.add("disabled_");this.reviewBtn.classList.toggle("inactivated_",!this.isSubscribed);this.reviewBtn.title=this.l.REVIEW_BTN_TTL;this.reviewBtn.textContent=this.l.REVIEW_BTN_LBL;this.reviewBtn.addEventListener("click",this.sendToReview);this.reviewBtn.addEventListener("animationend",()=>{this.reviewBtn.classList.remove("complete_")});this.removalBtn=document.createElement("div");this.removalBtn.className="av-removal-btn_";this.removalBtn.classList.toggle("inactivated_",
!this.isSubscribed);this.removalBtn.title=this.l.REMOVAL_BTN_TTL;this.removalBtn.textContent=this.l.REMOVAL_BTN_LBL;this.removalBtn.addEventListener("click",this.submitRemovalRequest);this.removalBtn.addEventListener("animationend",()=>{this.removalBtn.classList.remove("complete_")});this.gpproxy.addEventListener("presets",()=>{if(this.gpproxy.isAuthorized){var a=this.formatUsername(this.gpproxy.getUser().nick);this.requestState(a,()=>{this.removalBtn.classList.remove("disabled_")})}},{once:!0})}sendToReview(){this.editor.isChanged&&
(this.editor.requestAvatar().then(a=>{this.sendRequest(GPAvatars_.REQUEST_TYPE.REVIEW,a)}),this.reviewBtn.classList.add("disabled_"))}submitRemovalRequest(){this.sendRequest(GPAvatars_.REQUEST_TYPE.REMOVAL);this.removalBtn.classList.add("disabled_")}sendRequest(a,b){if(this.isSubscribed){var {authId:c,nick:d}=this.gpproxy.getUser(),e=this.gpproxy.getAuthType(),g=this.act.getKeyMark(),f=this.usernameHash(this.formatUsername(d));switch(a){case GPAvatars_.REQUEST_TYPE.REVIEW:a=new File([b],`${f}.${b.type.split("/")[1]}`);
document.dispatchEvent(new CustomEvent("_av_review",{detail:{sender:d,senderId:c,service:e,keyMark:g,imageFile:a,filename:f,noticeColor:GPAvatars_.NOTICE_COLORS.REVIEW}}));break;case GPAvatars_.REQUEST_TYPE.REMOVAL:document.dispatchEvent(new CustomEvent("_av_removal",{detail:{sender:d,senderId:c,service:e,keyMark:g,filename:f,noticeColor:GPAvatars_.NOTICE_COLORS.REMOVAL}}))}}}getEditor(){return this.editor.getElement()}handlePlayer(a){const b=a.querySelector(".avatar > span");a=a.querySelector(".nick")?.textContent;
a=this.formatUsername(a);this.insertAvatar(a,b)}handleAlbumItem(a){const b=a.querySelector(".avatar > span");a=a.querySelector(":scope > :not(.avatar) > span")?.textContent;a=this.formatUsername(a);this.insertAvatar(a,b)}insertAvatar(a,b){this.requestState(a,c=>{b.style.backgroundImage=`url(${c})`})}requestState(a,b){if(this.pendingStates.has(a)){const c=({detail:{username:d,avatarURL:e,isExists:g}})=>{d===a&&(g&&b(e),this.removeEventListener("state-changed",c))};this.addEventListener("state-changed",
c)}else{const c=this.buildURL(a),d=this.getAvatarState(a);d?b(c):void 0===d&&(this.pendingStates.add(a),fetch(c,{method:"HEAD"}).then(e=>{e.ok?(b(c),this.avatarsStates.set(a,!0)):this.avatarsStates.set(a,!1)}).finally(()=>{this.pendingStates.delete(a);this.dispatchEvent(new CustomEvent("state-changed",{detail:{username:a,avatarURL:c,isExists:this.avatarsStates.get(a)}}))}))}}buildURL(a){a=this.usernameHash(a);return this.url.replace("{filename}",a)}formatUsername(a){return this.gpproxy.isDiscordAuth()?
a:a.toLowerCase()}usernameHash(a){let b=-559038721,c=1103547975;for(let d=0,e;d<a.length;d++)e=a.charCodeAt(d),b=Math.imul(b^e,2654435761),c=Math.imul(c^e,1597334677);b=Math.imul(b^b>>>16,2246822507)^Math.imul(c^c>>>13,3266489909);c=Math.imul(c^c>>>16,2246822507)^Math.imul(b^b>>>13,3266489909);return(4294967296*(2097151&c)+(b>>>0)).toString(36)}getAvatarState(a){return this.avatarsStates.get(a)}updateSettings({detail:{settings:a}}){"livePreview"in a&&this.editor.setLivePreview(a.livePreview);"zoomSensitivity"in
a&&this.editor.setZoomSensitivity(a.zoomSensitivity);"imageSmoothing"in a&&this.editor.setImageSmoothing(a.imageSmoothing)}}window.GPAvatars_=GPAvatars_;class GPCanvasZoomer_ extends EventTarget{static SCALE_FACTOR=1.05;constructor(a,b,c){super();this.scaleFactor=c??GPCanvasZoomer_.SCALE_FACTOR;this.canvas=a;this.canvas.addEventListener("contextmenu",d=>{d.preventDefault()});this.canvas.addEventListener("pointerdown",d=>{d.preventDefault();2===d.button&&this.reset();0!==d.button||d.ctrlKey||(this.canvas.setPointerCapture(d.pointerId),this.lastX=d.offsetX,this.lastY=d.offsetY,this.dragStartPoint=this.ctx.transformedPoint(this.lastX,this.lastY))});
this.canvas.addEventListener("pointermove",d=>{this.lastX=d.offsetX;this.lastY=d.offsetY;this.dragStartPoint&&(d=this.ctx.transformedPoint(this.lastX,this.lastY),this.ctx.translate(d.x-this.dragStartPoint.x,d.y-this.dragStartPoint.y),this.redraw())});this.canvas.addEventListener("pointerup",d=>{this.dragStartPoint=null});this.canvas.addEventListener("wheel",d=>{this.zoom(-d.deltaY/40);d.preventDefault()});this.ctx=a.getContext("2d");this.ctx.imageSmoothingQuality="high";this.trackTransforms(this.ctx);
this.image=b;this.lastX=a.width/2;this.lastY=a.height/2;this.dragStartPoint;this.mirror=this.mirror.bind(this)}reset(){this.ctx.resetTransform();this.redraw()}redraw(){if(this.image){var a=this.ctx.transformedPoint(0,0),b=this.ctx.transformedPoint(this.canvas.width,this.canvas.height);this.ctx.clearRect(a.x,a.y,b.x-a.x,b.y-a.y);this.ctx.drawImage(this.image,-(this.image.width-this.canvas.width)/2,-(this.image.height-this.canvas.height)/2);this.dispatchEvent(new Event("change"))}}zoom(a){const b=this.ctx.transformedPoint(this.lastX,
this.lastY);this.ctx.translate(b.x,b.y);a=Math.pow(this.scaleFactor,a);this.ctx.scale(a,a);this.ctx.translate(-b.x,-b.y);this.redraw()}setTransform(a,b,c,d,e,g){this.ctx.setTransform(a,b,c,d,e,g);this.redraw()}trackTransforms(a){const b=document.createElementNS("http://www.w3.org/2000/svg","svg");let c=b.createSVGMatrix();a.getTransform=function(){return c};const d=[],e=a.save;a.save=function(){d.push(c.translate(0,0));return e.call(a)};const g=a.restore;a.restore=function(){c=d.pop();return g.call(a)};
const f=a.scale;a.scale=function(r,q){c=c.scaleNonUniform(r,q);return f.call(a,r,q)};const h=a.rotate;a.rotate=function(r){c=c.rotate(180*r/Math.PI);return h.call(a,r)};const k=a.translate;a.translate=function(r,q){c=c.translate(r,q);return k.call(a,r,q)};const l=a.transform;a.transform=function(r,q,z,A,y,t){const w=b.createSVGMatrix();w.a=r;w.b=q;w.c=z;w.d=A;w.e=y;w.f=t;c=c.multiply(w);return l.call(a,r,q,z,A,y,t)};const m=a.setTransform;a.setTransform=function(r,q,z,A,y,t){c.a=r;c.b=q;c.c=z;c.d=
A;c.e=y;c.f=t;return m.call(a,r,q,z,A,y,t)};const n=a.resetTransform;a.resetTransform=function(){c=b.createSVGMatrix();d.length=0;return n.call(a)};const p=b.createSVGPoint();a.transformedPoint=function(r,q){p.x=r;p.y=q;return p.matrixTransform(c.inverse())}}setImage(a){this.image=a;this.reset()}setScaleFactor(a){this.scaleFactor=a}mirror(){this.image&&(this.ctx.translate(this.canvas.width,0),this.ctx.scale(-1,1),this.ctx.drawImage(this.image,0,0),this.redraw())}};class GPLocalization_{static MISSING_STR="N/A";static DEFAULT_DATA={lang:"ru",entries:{}};constructor(a=GPLocalization_.DEFAULT_DATA){this.lang=a.lang;this.entries=this.initEntries(a.entries)}get(a){return this.entries[a]}getLang(){return this.lang}initEntries(a={}){return new Proxy(a,{get:(b,c)=>new Proxy(b[c]??{},{get:(d,e)=>"lang"===e?this.lang:d[e]??GPLocalization_.MISSING_STR})})}};class GPPlayersObserver_ extends EventTarget{static MONITOR_INTERVAL=200;static SCREEN={START:"start",LOBBY:"lobby",FIRST:"first",DRAW:"draw",WRITE:"write",REPLY:"reply",BOOK:"book",RESULT:"result"};static OBSERVED_SCREENS=new Set([this.SCREEN.LOBBY,this.SCREEN.BOOK,this.SCREEN.RESULT]);constructor(a){if(GPPlayersObserver_.instance)return GPPlayersObserver_.instance;super();GPPlayersObserver_.instance=this;this.gpproxy=a;this.isInitialized=!1;this.monitorTimer;this.inObserving=!1;this.observerConfig=
{childList:!0,subtree:!0};this.observer=new MutationObserver(this.observerCallback.bind(this));this.albumObserverConfig={childList:!0,subtree:!0};this.albumObserver=new MutationObserver(this.albumObserverCallback.bind(this));this.currentScreen=null;this.playerItems=new Map;this.handlers=new Set;this.resultHandlers=new Set;this.albumHandlers=new Set}init(){const a=new MutationObserver((b,c)=>{for(const d of b)if(b=d.addedNodes?.[0],b?.classList.contains("screen")){b=[...b.firstElementChild.classList].find(e=>
!e.startsWith("jsx-"));if(!b)break;b!==this.currentScreen&&this.dispatchEvent(new Event("screen-changed"));this.currentScreen=b;GPPlayersObserver_.OBSERVED_SCREENS.has(b)?(this.stopMonitor(),this.startMonitor()):this.stopMonitor()}});this.gpproxy.addEventListener("presets",()=>{this.gpproxy.isAuthorized&&(a.observe(document.getElementById("content"),{childList:!0}),this.gpproxy.isGameStages(GPProxy_.GAME_STAGE.LOBBY,GPProxy_.GAME_STAGE.ALBUM,GPProxy_.GAME_STAGE.SCORE)&&this.startMonitor())},{once:!0});
this.addEventListener("screen-changed",()=>{this.playerItems.clear()});this.isInitialized=!0}addHandler(a){this.handlers.add(a);this.isInitialized||this.init()}addResultHandler(a){this.resultHandlers.add(a)}addAlbumHandler(a){this.albumHandlers.add(a)}getPlayerItems(){return this.playerItems}startMonitor(){if(!this.inObserving){var a=document.querySelector(".players");a?(this.observer.observe(a,this.observerConfig),this.inObserving=!0,this.handlePlayers(a),this.currentScreen===GPPlayersObserver_.SCREEN.BOOK&&
this.albumHandlers.size?(a=a.parentElement.querySelector(":scope > .scrapbook > .timeline"),this.albumObserver.observe(a,this.albumObserverConfig),this.handleAlbum(a)):this.currentScreen===GPPlayersObserver_.SCREEN.RESULT&&this.resultHandlers.size&&(a=a.parentElement.querySelector(".ranking"),this.handleResult(a))):this.monitorTimer=setTimeout(()=>{this.startMonitor()},GPPlayersObserver_.MONITOR_INTERVAL)}}stopMonitor(){clearTimeout(this.monitorTimer);this.inObserving&&(this.observer.disconnect(),
this.albumObserver.disconnect(),this.inObserving=!1)}observerCallback(a,b){for(const c of a)if("childList"===c.type&&c.addedNodes.length&&c.target.classList.contains("scrollElements")&&c.addedNodes[0].matches(".user:not(.empty)")){const d=c.addedNodes[0];this.handlers.forEach(e=>{this.cachePlayer(d);e(d)})}}albumObserverCallback(a,b){for(const c of a)"childList"===c.type&&c.addedNodes.length&&1===c.addedNodes[0].nodeType&&c.addedNodes[0].matches(".item:has(> :is(.answerBalloon, .drawBalloon))")&&
this.albumHandlers.forEach(d=>{d(c.addedNodes[0].firstElementChild)})}cachePlayer(a){const b=a.querySelector(".nick")?.textContent;b&&this.playerItems.set(b,a)}handlePlayers(a){a=a.querySelectorAll(".user:not(.empty)");Array.from(a).forEach(b=>{this.handlers.forEach(c=>{this.cachePlayer(b);c(b)})})}handleResult(a){a=a.querySelectorAll(".user");Array.from(a).forEach(b=>{this.resultHandlers.forEach(c=>c(b))})}handleAlbum(a){a=a.querySelectorAll(".item > :is(.answerBalloon, .drawBalloon)");Array.from(a).forEach(b=>
{this.albumHandlers.forEach(c=>c(b))})}}window.GPPlayersObserver_=GPPlayersObserver_;class GPUtils_{static async compressImageData(a,b=!0){const {data:c,background:d,auth:e,meta:g}=a;a={m:{a:g.author,t:g.title,d:(new Date(g.date)).toISOString()},d:c};d&&(a.b=d);e&&(a.a=e);return b?this.wCompressData(a):this.compressData(a)}static async compressData(a){a=JSON.stringify(a);a=this.stringToArrayBuffer(a);a=await this.compressArrayBuffer(a);return this.arrayBufferToBlob(a)}static arrayBufferToBlob(a){return new Blob([a],{type:"octet/stream"})}static async compressArrayBuffer(a){var b=
new CompressionStream("deflate"),c=b.writable.getWriter();c.write(a);c.close();a=[];b=b.readable.getReader();for(c=0;;){const {value:d,done:e}=await b.read();if(e)break;a.push(d);c+=d.byteLength}b=new Uint8Array(c);c=0;for(const d of a)b.set(d,c),c+=d.byteLength;return b}static stringToArrayBuffer(a){return(new TextEncoder).encode(a)}static async decompressFile(a){return JSON.parse(await this.decompressBlob(a))}static async decompressBlob(a){let b=new DecompressionStream("deflate");a=a.stream().pipeThrough(b);
return await (new Response(a)).text()}static saveBlob(a,b=""){a=window.URL.createObjectURL(a);const c=document.createElement("a");c.href=a;c.download=b;c.click();window.URL.revokeObjectURL(a)}static wCompressData(a){return new Promise(b=>{const c=this.createWorker(this.compressWorkerBody);c.addEventListener("message",({data:d})=>{c.terminate();b(d)});c.postMessage(a)})}static compressWorkerBody(){self.work=new async function(){}.constructor("a",'a=JSON.stringify(a);a=(new TextEncoder).encode(a);var c=new CompressionStream("deflate"),b=c.writable.getWriter();b.write(a);b.close();a=[];c=c.readable.getReader();for(b=0;;){const {value:d,done:e}=await c.read();if(e)break;a.push(d);b+=d.byteLength}c=new Uint8Array(b);b=0;for(const d of a)c.set(d,b),b+=d.byteLength;return new Blob([c],{type:"octet/stream"})');
self.addEventListener("message",async({data:a})=>{self.postMessage(await self.work(a))})}static createWorker(a){a=URL.createObjectURL(new Blob([this.getFuncBody(a)]));const b=new Worker(a);URL.revokeObjectURL(a);return b}static getFuncBody(a){a=a.toString();return a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))}}window.GPUtils_=GPUtils_;class GPGlobalBanlist_ extends EventTarget{static RAID_NOTICE_OPTIONS={type:GPAbout_.NOTICE_TYPE.NORMAL,style:{color:"#fff",background:"#d64242",width:"344px"}};static PERSONAL_RAID_NOTICE_OPTIONS={type:GPAbout_.NOTICE_TYPE.RAID};static RAID_PATTERNS=[RegExp("discord.gg&#47;"),RegExp("\\b\\d{1,2}:\\d{2}\\b")];static RAID_START_TIME="18:00";static RAID_DURATION=216E5;static PERSONAL_RAID_CHECK_TIMEOUT=3E3;static DEFAULT_SETTINGS={showRaidAlert:!0,personalRaidCheck:!1,latestRaidCheck:null};static SETTINGS_UI={showRaidAlert:{type:"checkbox",
description:"\u041f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u043f\u0440\u0435\u0434\u0443\u043f\u0440\u0435\u0436\u0434\u0435\u043d\u0438\u044f \u043e \u0437\u043b\u043e\u043d\u0430\u043c\u0435\u0440\u0435\u043d\u043d\u044b\u0445 \u0440\u0435\u0439\u0434\u0430\u0445 \u043d\u0430 \u0442\u0440\u0430\u043d\u0441\u043b\u044f\u0446\u0438\u0438 \u0441\u0442\u0440\u0438\u043c\u0435\u0440\u043e\u0432."},personalRaidCheck:{type:"checkbox",description:"\u041f\u0440\u043e\u0432\u0435\u0440\u044f\u0442\u044c \u043f\u0435\u0440\u0435\u0434 \u0437\u0430\u043f\u0443\u0441\u043a\u043e\u043c \u043a\u0430\u0436\u0434\u043e\u0439 \u043d\u043e\u0432\u043e\u0439 \u0438\u0433\u0440\u044b, \u043d\u0435 \u043f\u0440\u043e\u0432\u043e\u0434\u0438\u0442\u0441\u044f \u043b\u0438 \u0440\u0435\u0439\u0434 \u043d\u0430 \u0432\u0430\u0448 \u0441\u0442\u0440\u0438\u043c."}};static MODULE={title:"Global Banlist",
settings:{storage:"gp_global-banlist",defaultSettings:this.DEFAULT_SETTINGS,ui:this.SETTINGS_UI}};static INIT(a,b){new GPGlobalBanlist_(a.gpproxy,a.sm,a.abt,b)}constructor(a,b,c,d){super();this.gpproxy=a;this.abt=c;this.l=d;this.s=b.setSettings(this,this.updateSettings);this.isSubscribed=!1;this.globalBanlist=new Set;this.globalBanlistIds=new Set;this.twitchUsernamesCache=new Map;this.twitchCachedUsers=new Set;this.startGameTimer;this.currentRaidDate=null;this.isPersonalRaidDetected=this.isRaidCheckPending=
!1;this.startGameHandler=this.startGameHandler.bind(this);this.addEventListener("global_banlist_updated",e=>{this.clearPlayersByGlobalBanlist()});this.gpproxy.addEventListener("data",({detail:{event:e}})=>{e===GPProxy_.EVENT.NEW_GAME?this.gpproxy.isAuthorized&&this.requestGlobalBanlist():e===GPProxy_.EVENT.GAME_STARTED&&(document.removeEventListener("click",this.startGameHandler,!0),this.isRaidCheckPending=!1)});this.gpproxy.addEventListener("users_updated",({})=>{this.clearPlayersByGlobalBanlist()});
document.addEventListener("_global_banlist_received",({detail:{ids:e}})=>{this.globalBanlistIds=new Set(e);this.updateGlobalBanlist()});document.addEventListener("_tw_ids_usernames",({detail:{usernamesMap:e}})=>{this.updateTwitchUsernamesCache(e);this.updateGlobalBanlist(e)});document.addEventListener("_raid_status",({detail:{status:e,date:g}})=>{this.s.latestRaidCheck=g;e&&(this.currentRaidDate=g,this.s.showRaidAlert&&this.abt?.addNotice(Object.assign(GPGlobalBanlist_.RAID_NOTICE_OPTIONS,{text:this.l.RAID_WARNING})))});
document.addEventListener("_raid_personal_status",({detail:{status:e,startBtn:g}})=>{this.isRaidCheckPending&&(this.isRaidCheckPending=!1,clearTimeout(this.startGameTimer),e?(this.isPersonalRaidDetected=!0,this.s.personalRaidCheck&&this.abt?.addNotice(Object.assign(GPGlobalBanlist_.PERSONAL_RAID_NOTICE_OPTIONS,{text:this.l.PERSONAL_RAID_WARNING}))):g.click())});document.addEventListener("_url_changed",({detail:{path:e}})=>{this.isLobbyScreen(e)&&this.s.showRaidAlert&&(this.requestRaidStatus(),this.s.personalRaidCheck&&
this.gpproxy.isTwitchAuth()&&!this.isPersonalRaidDetected&&document.addEventListener("click",this.startGameHandler,!0))});document.addEventListener("_subs_status",({detail:{status:e,ps:g}})=>{this.isSubscribed=e;2&g||this.gpproxy.addEventListener("users_updated",({detail:{users:f}})=>{this.requestIdsUsernames(f)})});this.clearPlayersByGlobalBanlist();this.requestGlobalBanlist()}requestGlobalBanlist(){document.dispatchEvent(new CustomEvent("_request_global_banlist"))}clearPlayersByGlobalBanlist(){this.gpproxy.isOwner()&&
this.gpproxy.isTwitchAuth()&&this.gpproxy.isGameStage(GPProxy_.GAME_STAGE.LOBBY)&&this.gpproxy.getUsers().forEach(a=>{!this.gpproxy.isYou(a.nick)&&this.globalBanlist.has(this.formatUsername(a.nick))&&this.gpproxy.kickPlayer(a.id)})}updateGlobalBanlist(a){a||this.globalBanlist.clear();const b=a||this.twitchUsernamesCache;if(b.size){var c=!1;this.globalBanlistIds.forEach(d=>{d=b.get(d);void 0!==d&&(this.globalBanlist.add(d),c=!0)});c&&this.dispatchEvent(new CustomEvent("global_banlist_updated"))}}requestIdsUsernames(a){this.gpproxy.isOwner()&&
this.gpproxy.isTwitchAuth()&&(a=a.filter(b=>!this.twitchCachedUsers.has(this.formatUsername(b.nick))&&!this.gpproxy.isYou(b.nick)&&!this.gpproxy.isViewer(b)).map(b=>this.formatUsername(b.nick)),a.length&&document.dispatchEvent(new CustomEvent("_request_ids_usernames",{detail:{users:a}})))}updateTwitchUsernamesCache(a){a.forEach((b,c)=>{this.twitchUsernamesCache.set(c,b);this.twitchCachedUsers.add(b)})}formatUsername(a){return this.gpproxy.isDiscordAuth()?a:a.toLowerCase()}requestRaidStatus(){const [a,
b]=this.getMSKDate();this.isRaidTime(a)&&b!==this.s.latestRaidCheck&&document.dispatchEvent(new CustomEvent("_raid_check",{detail:{patterns:GPGlobalBanlist_.RAID_PATTERNS,startTime:GPGlobalBanlist_.RAID_START_TIME,duration:GPGlobalBanlist_.RAID_DURATION,date:b}}))}requestPersonalRaidStatus(a,b){b.click=b.click.bind(b);document.dispatchEvent(new CustomEvent("_raid_personal_check",{detail:{username:this.gpproxy.getUser().nick.toLowerCase(),date:a,startBtn:b}}))}isRaidTime(a){return 18<=a.getHours()&&
23>=a.getHours()}getMSKDate(){var a=new Date,b=a.getTime();a=b-(new Date(a.toLocaleString("en-US",{timeZone:"Europe/Moscow"}))).getTime();b=new Date(b-a);a=b.toLocaleDateString("en-US");return[b,a]}startGameHandler(a){if(!this.isPersonalRaidDetected&&a.isTrusted){var [b,c]=this.getMSKDate();if(this.isRaidTime(b)&&c===this.currentRaidDate){const d=document.querySelector("i.playSmall").parentElement;(a.target===d||d.contains(a.target))&&location.pathname.endsWith("/lobby")&&(a.stopPropagation(),this.isRaidCheckPending||
(this.startGameTimer=setTimeout(()=>{this.isRaidCheckPending=!1;d.click()},GPGlobalBanlist_.PERSONAL_RAID_CHECK_TIMEOUT),this.requestPersonalRaidStatus(c,d),this.isRaidCheckPending=!0))}}}isLobbyScreen(a){return"lobby"===a.slice(1)}updateSettings({detail:{settings:a}}){"showRaidAlert"in a&&a.showRaidAlert&&this.gpproxy.isGameStage(GPProxy_.GAME_STAGE.LOBBY)&&this.requestRaidStatus();"personalRaidCheck"in a&&this.gpproxy.isTwitchAuth()&&this.gpproxy.isGameStage(GPProxy_.GAME_STAGE.LOBBY)&&!this.isPersonalRaidDetected&&
(a.personalRaidCheck?document.addEventListener("click",this.startGameHandler,!0):document.removeEventListener("click",this.startGameHandler,!0))}}window.GPGlobalBanlist_=GPGlobalBanlist_;class GPPacketParser_{constructor(){this.socketIOParser=new SocketIOParser_;this.engineIOClient=new EngineIOClient_;return{encodeString:this.socketIOParser.encodeString,add:this.socketIOParser.add,decodeString:this.socketIOParser.decodeString,decodePayload:this.engineIOClient.decodePayload,decode:this.decode.bind(this)}}decode(a,b){if(b){const {type:c,data:d}=this.engineIOClient.decodePayload(a);return"message"===c?this.socketIOParser.add(d).data:null}return this.socketIOParser.add(a).data}}
class SocketIOParser_{constructor(){function a(d){var e=0,g={type:Number(d.charAt(0))};if(null==c.types[g.type])return{type:c.ERROR,data:null};if(c.BINARY_EVENT===g.type||c.BINARY_ACK===g.type){for(var f=e+1;"-"!==d.charAt(++e)&&e!=d.length;);f=d.substring(f,e);if(f!=Number(f)||"-"!==d.charAt(e))throw Error("Illegal attachments");g.attachments=Number(f)}if("/"===d.charAt(e+1)){for(f=e+1;++e;){var h=d.charAt(e);if(","===h)break;if(e===d.length)break}g.nsp=d.substring(f,e)}else g.nsp="/";f=d.charAt(e+
1);if(""!==f&&Number(f)==f){for(f=e+1;++e;){h=d.charAt(e);if(null==h||Number(h)!=h){--e;break}if(e===d.length)break}g.id=Number(d.substring(f,e+1))}"4"===d.charAt(0)&&"5"===d.charAt(1)&&e++;if(d.charAt(++e)){d=d.substr(e);try{var k=JSON.parse(d)}catch(l){k=!1}if(!1===k||g.type!==c.ERROR&&!Array.isArray(k))return{type:c.ERROR,data:null};g.data=k}return g}var b="function"===typeof ArrayBuffer;const c={protocol:4,types:"CONNECT DISCONNECT EVENT ACK ERROR BINARY_EVENT BINARY_ACK".split(" "),CONNECT:0,
DISCONNECT:1,EVENT:2,ACK:3,ERROR:4,BINARY_EVENT:5,BINARY_ACK:6};return{add:function(d){if("string"===typeof d)if(d=a(d),c.BINARY_EVENT===d.type||c.BINARY_ACK===d.type){if(this.reconstructor=new window.BinaryReconstructor(d),0===this.reconstructor.reconPack.attachments)return d}else return d;else{var e;if(e=b)(e=d instanceof ArrayBuffer)||(e="function"===typeof ArrayBuffer.isView?ArrayBuffer.isView(d):d.buffer instanceof ArrayBuffer);if(e||d.base64)if(this.reconstructor){if(d=this.reconstructor.takeBinaryData(d))return this.reconstructor=
null,d}else throw Error("got binary data when not reconstructing a packet");else throw Error("Unknown type: "+d);}},decodeString:a,encodeString:function(d){let e,g=!1;e=""+d.type;if(c.BINARY_EVENT==d.type||c.BINARY_ACK==d.type)e+=d.attachments,e+="-";d.nsp&&"/"!=d.nsp&&(g=!0,e+=d.nsp);null!=d.id&&(g&&(e+=",",g=!1),e+=d.id);null!=d.data&&(g&&(e+=","),e+=JSON.stringify(d.data));return e}}}}
class EngineIOClient_{constructor(){function a(e,g,f){if(void 0===e)return d;if("string"===typeof e){if("b"===e.charAt(0))return f=e.substr(1),e=c[f.charAt(0)],window.base64encoder?(f=window.base64encoder.decode(f.substr(1)),"blob"===g&&Blob&&(f=new Blob([f])),g={type:e,data:f}):g={type:e,data:{base64:!0,data:f.substr(1)}},g;if(f){a:{g=e;try{g=window.utf8.decode(g,{strict:!1})}catch(h){e=!1;break a}e=g}if(!1===e)return d}f=e.charAt(0);return Number(f)==f&&c[f]?1<e.length?{type:c[f],data:e.substring(1)}:
{type:c[f]}:d}f=(new Uint8Array(e))[0];e=e.slice(1);Blob&&"blob"===g&&(e=new Blob([e]));return{type:c[f],data:e}}function b(e,g,f){"function"===typeof g&&(f=g,g=null);for(var h=[];0<e.byteLength;){for(var k=new Uint8Array(e),l=0===k[0],m="",n=1;255!==k[n];n++){if(310<m.length)return f(d,0,1);m+=k[n]}e=e.slice(2+m.length);m=parseInt(m);k=e.slice(0,m);if(l)try{k=String.fromCharCode.apply(null,new Uint8Array(k))}catch(r){for(l=new Uint8Array(k),k="",n=0;n<l.length;n++)k+=String.fromCharCode(l[n])}h.push(k);
e=e.slice(m)}var p=h.length;h.forEach(function(r,q){f(a(r,g,!0),q,p)})}var c=Object.keys({open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6}),d={type:"error",data:"parser error"};return{decodePayload:function(e,g,f){if("string"!==typeof e)return b(e,g,f);"function"===typeof g&&(g=null);if(""===e)return d;f="";for(var h,k,l=0,m=e.length;l<m;l++)if(k=e.charAt(l),":"!==k)f+=k;else{if(""===f||f!=(h=Number(f)))return d;k=e.substr(l+1,h);if(f!=k.length)return d;if(k.length)return e=a(k,g,!1),d.type===
e.type&&d.data===e.data?d:e;l+=h;f=""}if(""!==f)return d}}}}window.GPPacketParser_=GPPacketParser_;class GPProxy_ extends EventTarget{static MODULE={title:"GP Proxy",dependencies:["GPPacketParser_"]};static INIT(a,b){a.gpproxy=new GPProxy_(a.ws,b)}static EVENT={GAME_QUIT:28,CHANGE_GAME_MODE:26,CHANGE_LOBBY_SCREEN:27,CHANGE_GAME_SETTINGS:18,GAME_STARTED:5,DESCRIPTION_INPUT:6,TOOL:7,READY:15,GALLERY_SETTINGS:23,NEW_GAME:20,PLAYER_JOINED:2,PLAYER_LEFT:3,PLAYER_KICKED:14,PLAYER_LEFT_GAME:21,PLAYER_RETURNED:22,TURN_STARTED:11,TURNS_ENDED:24,TIMER_STARTED:25,ALBUM_INFO:12,ALBUM_ITEM:9,ALBUM_NEXT:16,
ALBUM_BACK:17,ALBUM_SCORE:35};static GAME_TIME={FAST:3,NORMAL:2,SLOW:1,REGRESSIVE:5,PROGRESSIVE:8,DYNAMIC:4,INFINITE:6,HOSTS_DECISION:7,FASTER_FIRST_TURN:9,SLOWER_FIRST_TURN:10};static GAME_ORDER={WRITING_DRAWING:1,DRAWING_WRITING:2,ONLY_DRAWINGS:3,WRITING_ONLY_AT_THE_BEGINNING_AND_THE_END:4,WRITING_ONLY_AT_THE_BEGINNING:5,WRITING_ONLY_AT_THE_END:6,SINGLE_SENTENCE:7,SINGLE_DRAWING:8,SOLO_DRAWING:9,DRAWINGS_WITH_A_BACKGROUND:10,DRAWINGS_WITH_A_BACKGROUND_NO_PREVIEW:11};static INITIAL_STATE={screen:null,
user:{owner:!1},users:[],turn:{},turnNum:0,turnMax:0,roundNum:0,bookAuthor:{id:0,nick:""},bookNum:-1,bookLoaded:!1,bookAutomatic:!0,bookVoice:!1,timeline:[],previous:{user:{id:0,nick:""},type:2,data:""},active:!1,sentence:"",write:"",draw:[],lastDraw:null,background:null,configs:{tab:1,mode:1,maxUsers:14,visible:!0,speed:2,turns:3,first:1,score:2,animate:2,keep:2},animationConfigs:{speed:3,loop:1},timeStarted:!1,elapsedBase:0,elapsedTime:0,modList:0};static PAYLOAD_TYPE={PRESETS:1,DATA:2};static GAME_STAGE={LOBBY:1,
GAME:2,GALLERY_SETTINGS:5,ALBUM:3,SCORE:4};static ALBUM_ITEM_TYPE={DESCRIPTION:2,IMAGE:1,ANIMATION:5};static AUTH_TYPE={DISCORD:"discord",TWITCH:"twitch"};static AUTH_TYPE_IDS={twitch:1,discord:2};static DISCORD_USERNAME_PATTERN=/^.+#\d+$/;static GAME_MODES_PRESETS={1:{mode:1,visible:1,speed:2,turns:3,first:1,score:2,animate:2,keep:2},2:{mode:2,speed:4},3:{mode:3,visible:2},4:{mode:4,turns:3},5:{mode:5,first:4},6:{mode:6,speed:3},7:{mode:7,speed:3,turns:1},8:{mode:8,speed:5,first:3},9:{mode:9,first:7},
10:{mode:10,score:1},11:{mode:11,first:3,animate:1},12:{mode:12,speed:6,turns:4,first:7,animate:1},13:{mode:13,speed:4,turns:7,first:9,animate:1},14:{mode:14,speed:10,turns:4,first:10,animate:1},15:{mode:15,speed:9,first:11},17:{mode:17,first:12},18:{mode:18,speed:3,turns:13,first:7,keep:1},20:{mode:20,speed:7,turns:6,first:3},21:{mode:21,first:3,keep:3}};static SCREEN={LOBBY:1,PHRASE:3,DESCRIPTION:4,PAINTER:5,ALBUM:7};static SCREEN_NAMES={1:"lobby",3:"phrase",4:"description",5:"painter",7:"album"};static REJOIN_STAGES={LOBBY:["lobby"],
GAME:["start","draw","write","memory","reply"],ALBUM:["book"],SCORE:["rank"]};static SEND_QUEUE_DELAY=130;constructor(a,b){super();this.ws;this.l=b;this.state=GPProxy_.INITIAL_STATE;this.albums=[];this.albumsCount=0;this.prevImageData=null;this.isAuthorized=!1;this.gameStage=GPProxy_.GAME_STAGE.LOBBY;this.rejoinFlag=!1;this.stateUpdateHandler=this.stateUpdateHandler.bind(this);this.wsMessageHandler=this.wsMessageHandler.bind(this);this.dataEventHandler=this.dataEventHandler.bind(this);this.rejoinHandler=
this.rejoinHandler.bind(this);this.sendQueueHandler=this.sendQueueHandler.bind(this);this.resetSendQueue=this.resetSendQueue.bind(this);this.setAlbumItem=this.setAlbumItem.bind(this);this.parser=new GPPacketParser_;this.localization={};this.wsMsgMiddlewares=new Map;this.sendQueue=[];this.lastSendTime=Date.now();this.sendQueueTimer;document.addEventListener("_xhr_data",({detail:{encodedPacket:c}})=>{(c=this.parser.decode(c,!0))&&this.setPresets(c[1])});document.addEventListener("_ws_send_data",({detail:{encodedPacket:c}})=>
{c&&3<c.length&&(c=this.parser.decode(c))&&this.wsSendHandler(c)});document.addEventListener("_onmessage_intercept",({detail:{handler:c,e:d}})=>{if(this.wsMsgMiddlewares.size)if("string"!==typeof d.data)c(d);else{var [,e,g]=d.data.match(/4(?:(?:2)|(51-))\[2,(\d+)/)||[];if(void 0!==g&&this.wsMsgMiddlewares.has(+g)){var f=this.wsMsgMiddlewares.get(+g),h=this.parser.decodeString(d.data).data;if(h){var [k,l]=[...f].reduce((m,n)=>n(m),[h,!1]);l?(f=this.encodePacket(k,!!e),d=this.buildMessageEvent(d,f),
c(d)):c(d)}else c(d)}else c(d)}else c(d)});this.addEventListener("data",this.stateUpdateHandler);this.addEventListener("data",this.gameStageUpdateHandler);this.addEventListener("data",this.usersUpdateHandler);this.addEventListener("data",this.albumUpdateHandler);this.addEventListener("data",this.dataEventHandler);this.addEventListener("data",this.prevImageHandler);this.addEventListener("data",this.sendQueueHandler);this.addEventListener("presets",this.resetSendQueue);this.addEventListener("album_reconnect",
()=>{this.albumsCount=this.getAlbumsCount()});document.addEventListener("_url_changed",this.rejoinHandler,{once:!0});this.setWebSocket(a);this.requestLocalization("draw").then(({data:c,type:d})=>{this.localization[d]=c;this.dispatchEvent(new CustomEvent("localization",{detail:{data:c,type:d}}))}).catch(({err:c,type:d})=>{console.error(c);this.localization[d]={}})}setWebSocket(a){this.ws&&this.ws.removeEventListener("message",this.wsMessageHandler);this.ws=a;this.ws.addEventListener("message",this.wsMessageHandler)}addWSMsgMiddleware(a,
b){a.forEach(c=>{const d=this.wsMsgMiddlewares.get(c)||new Set;d.add(b);this.wsMsgMiddlewares.set(c,d)})}removeWSMsgMiddleware(a){this.wsMsgMiddlewares.forEach((b,c)=>{b.delete(a);b.size||this.wsMsgMiddlewares.delete(c)})}encodePacket([a,b,c,d],e){e=e?"51-":2;a=[a,b,c];void 0!==d&&a.push(d);return this.parser.encodeString({type:4,nsp:"/",id:e,data:a})}buildMessageEvent(a,b){return new MessageEvent("message",{data:b,origin:a.origin,lastEventId:a.lastEventId,source:a.source,ports:a.ports})}setPresets(a){if(a.error)console.warn("Presets Error:",
a);else try{this.state=Object.assign(GPProxy_.INITIAL_STATE,this.state,a);this.state.users.find(c=>c.id===a.user.id).you=!0;this.isAuthorized=this.state.user.uid!==this.state.user.authId;this.authTypeId=(this.authType=this.calcAuthType())?GPProxy_.AUTH_TYPE_IDS[this.authType]:0;if(a.users){const c=new CustomEvent("users_updated",{detail:{users:this.state.users}});this.dispatchEvent(c)}a.timeline?.length&&(this.albums[a.bookNum]={items:[],background:a.background},a.timeline.forEach(this.setAlbumItem));
document.dispatchEvent(new CustomEvent("_auth_id",{detail:{authId:this.state.user.authId,authTypeId:this.authTypeId,isAuthorized:this.isAuthorized}}));this.dispatchEvent(new Event("presets"));if(1!==a.screen){var b=GPProxy_.SCREEN_NAMES[a.screen];b&&(this.dispatchEvent(new CustomEvent(`${b}_reconnect`)),[3,4,5].includes(a.screen)&&this.dispatchEvent(new CustomEvent("game_reconnect")));this.rejoinFlag=!0}}catch(c){console.warn("Presets Data Error:",{error:c,data:a})}}wsMessageHandler({data:a}){if("string"===
typeof a&&(a=this.parser.decodeString(a).data)){const [,b,c]=a;this.dispatchEvent(new CustomEvent("data",{detail:{event:b,data:c}}))}}wsSendHandler(a){const [,b,c]=a;b!==GPProxy_.EVENT.CHANGE_GAME_SETTINGS&&b!==GPProxy_.EVENT.GAME_QUIT||this.dispatchEvent(new CustomEvent("data",{detail:{event:b,data:c}}))}stateUpdateHandler({detail:{event:a,data:b}}){switch(a){case GPProxy_.EVENT.CHANGE_GAME_MODE:a=GPProxy_.GAME_MODES_PRESETS;b=Object.assign({},a[1],a[b]);this.state.configs=Object.assign({},this.state.configs,
b);break;case GPProxy_.EVENT.CHANGE_LOBBY_SCREEN:b=GPProxy_.GAME_MODES_PRESETS[1];this.state.configs=Object.assign({},this.state.configs,b);break;case GPProxy_.EVENT.CHANGE_GAME_SETTINGS:this.state.configs=Object.assign({},this.state.configs,b);break;case GPProxy_.EVENT.GAME_STARTED:this.state=Object.assign({},this.state,{countDown:!0,previous:null,turnNum:0,roundNum:this.state.roundNum+1,bookNum:0,turnMax:b,timeline:[],background:null});break;case GPProxy_.EVENT.TURN_STARTED:this.state=Object.assign({},
this.state,{draw:[],lastDraw:null},b);[3,4,9].includes(this.state.screen)?this.state.write=b.write||"":this.state.draw=b.draw||[];break;case GPProxy_.EVENT.TURNS_ENDED:this.state=Object.assign({},this.state,{screen:7,bookNum:-1});break;case GPProxy_.EVENT.GALLERY_SETTINGS:this.state=Object.assign({},this.state,{background:null},b);break;case GPProxy_.EVENT.ALBUM_INFO:this.state=Object.assign({},this.state,{timeline:[],bookLoaded:0<b.timeline.length},b);break;case GPProxy_.EVENT.NEW_GAME:this.state=
Object.assign({},this.state,{screen:1,roundNum:0});break;case GPProxy_.EVENT.ALBUM_SCORE:this.state=Object.assign({},this.state,{screen:8})}}gameStageUpdateHandler({detail:{event:a}}){switch(a){case GPProxy_.EVENT.NEW_GAME:this.gameStage=GPProxy_.GAME_STAGE.LOBBY;break;case GPProxy_.EVENT.GAME_STARTED:this.gameStage=GPProxy_.GAME_STAGE.GAME;break;case GPProxy_.EVENT.TURNS_ENDED:this.gameStage=GPProxy_.GAME_STAGE.GALLERY_SETTINGS;break;case GPProxy_.EVENT.GALLERY_SETTINGS:this.gameStage=GPProxy_.GAME_STAGE.ALBUM;
break;case GPProxy_.EVENT.ALBUM_SCORE:this.gameStage=GPProxy_.GAME_STAGE.SCORE}}dataEventHandler({detail:{event:a,data:b}}){let c=!0,d;switch(a){case GPProxy_.EVENT.TURN_STARTED:d="turn_started";break;case GPProxy_.EVENT.TURNS_ENDED:d="turns_ended";break;case GPProxy_.EVENT.GALLERY_SETTINGS:d="gallery_started";break;default:c=!1}c&&(a=new CustomEvent(d,{detail:{...b}}),this.dispatchEvent(a))}prevImageHandler({detail:{event:a,data:b}}){a===GPProxy_.EVENT.TURN_STARTED?b.screen!==GPProxy_.SCREEN.DESCRIPTION&&
b.screen!==GPProxy_.SCREEN.PAINTER||!Array.isArray(b.previous?.data)?this.prevImageData=null:this.prevImageData=b.previous.data:a===GPProxy_.EVENT.TURNS_ENDED&&(this.prevImageData=null)}sendQueueHandler({detail:{event:a}}){a!==GPProxy_.EVENT.TURN_STARTED&&a!==GPProxy_.EVENT.TURNS_ENDED||this.resetSendQueue()}rejoinHandler({detail:{path:a}}){if(this.rejoinFlag){var b=a.slice(1);if(a=Object.keys(GPProxy_.REJOIN_STAGES).find(c=>GPProxy_.REJOIN_STAGES[c].find(d=>d===b)))this.gameStage=GPProxy_.GAME_STAGE[a],
this.dispatchEvent(new Event(`${a.toLowerCase()}_rejoin`))}}usersUpdateHandler({detail:{event:a,data:b}}){let c=!0,d=!1;switch(a){case GPProxy_.EVENT.NEW_GAME:this.state.users=this.state.users.filter(k=>!k.away).map(k=>{k.viewer=void 0;k.ready=!1;return k});break;case GPProxy_.EVENT.ALBUM_SCORE:this.state.users=this.state.users.map(k=>{k.viewer=void 0;return k});break;case GPProxy_.EVENT.TURN_STARTED:this.state.user.ready=!1;this.state.users=this.state.users.map(k=>{k.ready=!1;return k});break;case GPProxy_.EVENT.PLAYER_JOINED:this.state.users.push(b);
break;case GPProxy_.EVENT.PLAYER_LEFT:var {userLeft:e,newOwner:g}=b;this.state.users=this.state.users.filter(k=>k.id!==e);g&&(d=this.state.user.id===g,this.state.user.owner=d,this.state.users=this.state.users.map(k=>{k.owner=k.id===g;return k}));break;case GPProxy_.EVENT.PLAYER_LEFT_GAME:var {userLeft:e,newOwner:g}=b;this.state.users=this.state.users.map(k=>{k.away=k.id===e||k.away;return k});g&&(d=this.state.user.id===g,this.state.user.owner=d,this.state.users=this.state.users.map(k=>{k.owner=k.id===
g;return k}));break;case GPProxy_.EVENT.PLAYER_RETURNED:this.state.users=this.state.users.map(k=>{k.away=k.away&&k.id!==b;return k});break;case GPProxy_.EVENT.PLAYER_KICKED:this.state.users=this.state.users.filter(k=>k.id!==b);break;case GPProxy_.EVENT.READY:var {user:f,ready:h}=b;this.state.users=this.state.users.map(k=>{k.ready=k.id===f?h:k.ready;return k});f===this.state.user.id&&(this.state.user.ready=h);break;case GPProxy_.EVENT.GAME_QUIT:this.state.users=[];break;default:c=!1}c&&this.dispatchEvent(new CustomEvent("users_updated",
{detail:{users:this.state.users}}));d&&this.dispatchEvent(new Event("owner_status"))}albumUpdateHandler({detail:{event:a,data:b}}){switch(a){case GPProxy_.EVENT.ALBUM_INFO:this.albums[b.bookNum]={items:[],background:b.background,bookAuthor:b.bookAuthor};b.timeline&&b.timeline.forEach(this.setAlbumItem);break;case GPProxy_.EVENT.ALBUM_ITEM:if(void 0===b.id){this.state.bookNum+1>=this.albumsCount&&this.dispatchEvent(new Event("albums_ended"));break}if(5===b.type){this.dispatchEvent(new CustomEvent("album_item_loading",
{detail:{id:null}}));break}b.user&&!b.data?this.dispatchEvent(new CustomEvent("album_item_loading",{detail:{id:b.id}})):this.setAlbumItem(b);break;case GPProxy_.EVENT.GALLERY_SETTINGS:this.albumsCount=this.getAlbumsCount()}}getAlbumsCount(){return this.getUsers().filter(a=>!a.viewer).length}getAlbum(a=this.state.bookNum){return this.albums[a]}getAlbumBackground(a=this.state.bookNum){return this.albums[a]?.background??null}setAlbumItem({user:a,id:b,data:c,type:d,active:e}){var g=GPProxy_.ALBUM_ITEM_TYPE;
if(e&&c&&a&&(d===g.DESCRIPTION||d===g.IMAGE)){a=a.nick;g=d===g.IMAGE?this.getItemTitle(b):null;e=(new Date).toISOString();var f=this.albums[this.state.bookNum].background;0===b&&f&&!c?.length&&(c=f,f=void 0);c={data:c,background:f,type:d,meta:{author:a,title:g,date:e}};this.isAuthorized&&(c.auth=this.authTypeId);this.albums[this.state.bookNum].items[b]=c;this.dispatchEvent(new CustomEvent("album_item",{detail:{itemID:b,albumID:this.state.bookNum,item:c}}))}}getItemTitle(a){if(!a)return this.l.ITEM_FREE_TITLE;
const b=Object.values(this.albums[this.state.bookNum].items),{first:c,animate:d}=this.state.configs;let e;if(1===d)return this.l.ITEM_ANIM_FRAME_TITLE;if(1===c||2===c){for(a=b.length;0<a--;)if(2===b[a].type){e=b[a].data;break}return e||this.l.ITEM_FREE_TITLE}return 3===c||6===c?this.l.ITEM_REDRAWN_TITLE:4===c||5===c?1<a?this.l.ITEM_REDRAWN_TITLE:b[0].data:7===c?b[0].data:9===c?this.l.ITEM_FREE_TITLE:10===c||11===c?0<a?this.l.ITEM_COMPLEMENTED_TITLE:this.l.ITEM_FREE_TITLE:this.l.ITEM_FREE_TITLE}getAlbumItem(a,
b=this.state.bookNum){return this.albums[b]?.items[a]??null}calcAuthType(){return this.isAuthorized?GPProxy_.DISCORD_USERNAME_PATTERN.test(this.state.user.nick)?GPProxy_.AUTH_TYPE.DISCORD:GPProxy_.AUTH_TYPE.TWITCH:null}send(a,b,c=4,d=2,e){a=this.parser.encodeString({type:c,nsp:"/",id:d,data:[GPProxy_.PAYLOAD_TYPE.DATA,a,b]});this.sendQueue.length||e?(this.sendQueue.push(a),this.sendInProcess||this.delayedSend()):(this.ws.send(a),this.lastSendTime=Date.now())}delayedSend(a=GPProxy_.SEND_QUEUE_DELAY){if(this.sendQueue.length){this.sendInProcess=
!0;var b=Date.now()-this.lastSendTime;b>a?(b=this.sendQueue.shift(),this.ws.send(b),this.lastSendTime=Date.now(),this.dispatchEvent(new CustomEvent("send_queue_updated",{detail:{size:this.sendQueue.length}})),0<this.sendQueue.length&&(this.sendQueueTimer=setTimeout(()=>{this.delayedSend()},a)),this.sendInProcess=!1):this.sendQueueTimer=setTimeout(()=>{this.delayedSend()},a-b)}else this.sendInProcess=!1}resetSendQueue(){clearTimeout(this.sendQueueTimer);this.sendInProcess=!1;this.sendQueue=[]}getSendQueueSize(){return this.sendQueue.length}kickPlayer(a){this.send(GPProxy_.EVENT.PLAYER_KICKED,
a)}tool(a,b,c){this.send(GPProxy_.EVENT.TOOL,{t:this.state.turnNum,d:a,v:b},void 0,void 0,c)}undo(a,b){this.tool(2,a,b)}redo(a,b){this.tool(1,a,b)}ready(){this.send(GPProxy_.EVENT.READY,!this.state.user.ready)}getState(){return this.state}getUser(){return this.state.user}getUsers(){return this.state.users.slice()}getAuthType(){return this.authType}isTwitchAuth(){return this.authType===GPProxy_.AUTH_TYPE.TWITCH}isDiscordAuth(){return this.authType===GPProxy_.AUTH_TYPE.DISCORD}isReady(){return!!this.state.user.ready}isOwner(){return!!this.state.user.owner}isViewer(a){return!!a.viewer}isYou(a){return void 0===
a?!1:this.state.user["number"===typeof a?"id":"nick"]===a}isAnimateMode(){return 1===this.state.configs.animate}isGameStage(a){return this.gameStage===a}isGameStages(...a){return a.some(b=>b===this.gameStage)}isGameTime(a){return this.state.configs.speed===a}isGameOrder(a){return this.state.configs.first===a}isAlbumAutoShow(){return this.state.bookAutomatic}isSoloGame(){return this.state.screen===GPProxy_.SCREEN.PAINTER&&1===this.state.users.filter(a=>!a.viewer).length}getGameConfig(){return Object.assign({},
this.state.configs)}getCurrentAlbumId(){return this.state.bookNum}getCurrentTurnId(){return this.state.turnNum}getGameCode(){return this.state.user.access}getPrevImageData(){return this.prevImageData}getPrevData(){return this.state.previous}getLocalization(a){return this.localization[a]||{}}requestLocalization(a){return new Promise((b,c)=>{window.__NEXT_DATA__?fetch(`${location.origin}/_next/data/${window.__NEXT_DATA__.buildId}/${window.__NEXT_DATA__.locale}/${a}.json`).then(d=>d.json()).then(d=>
{(d=d.pageProps?.texts?.page)?b({data:d,type:a}):c({error:"localization data not found",type:a})}).catch(d=>{c({error:d,type:a})}):c({error:"__NEXT_DATA__ is undefined",type:a})})}}window.GPProxy_=GPProxy_;class GPModulesManager_ extends EventTarget{static STORAGE_NAME="gp_mm";static FORCE_RELOAD=!0;static DEFAULT_PERMISSIONS=3685;static EDITION_STATE={FREE:"free",GIFT:"gift",SUBSCRIPTION:"subscription",TIME_LEFT:"time-left",EXPIRED:"expired"};static DEFAULT_SETTINGS={disabledList:[]};static LANGUAGES={ru:"\u0420\u0443\u0441\u0441\u043a\u0438\u0439",en:"English",es:"Espa\u00f1ol"};static RELOAD_BTN_L10N={ru:"\u041f\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c",en:"Reload page",
es:"Recarga la pesta\u00f1a"};constructor(a,b){super();this.loc=new GPLocalization_(b);this.l=this.loc.get(this.constructor.name);this.lang=this.loc.getLang();this.settings=JSON.parse(window.localStorage.getItem(GPModulesManager_.STORAGE_NAME))||GPModulesManager_.DEFAULT_SETTINGS;this.disabledList=new Set(this.settings.disabledList);this.modules=[];this.lm=[];this.hiddenSettings=new Set;this.initialState={};this.rootThis;this.publicKey;this.pasteKey=null;this.settingsManager=new GPSettingsManager_(this,
this.loc.get("GPSettingsManager_"));this.onMListClick=this.onMListClick.bind(this);this.onMListContextMenu=this.onMListContextMenu.bind(this);this.renderModulesList=this.renderModulesList.bind(this);this.renderError=this.renderError.bind(this);this.toggleSettingsVisibility=this.toggleSettingsVisibility.bind(this);this.addEventListener("disabled-list-updated",c=>{this.saveSettings()});document.addEventListener("_auth_id",async({detail:{authId:c,authTypeId:d,isAuthorized:e}})=>{function g(m){this.lm=
this.lm.filter(n=>1<<n.id&m?(n.disabled||(window[n.name].INIT.apply(this.rootThis,[this.root,this.loc.get(n.name)]),window[n.name].toggleSettingsVisibility=this.toggleSettingsVisibility(n),n.initialized=!0),n.locked=!1):n.locked=!0);this.renderModulesList()}async function f(m,n){n=(new TextEncoder).encode(n);var p=await crypto.subtle.digest("SHA-256",n);n=window.atob(m).slice(0,12);n={name:"AES-GCM",iv:new Uint8Array(Array.from(n).map(r=>r.charCodeAt(0)))};p=await crypto.subtle.importKey("raw",p,
n,!1,["decrypt"]);m=window.atob(m).slice(12);m=new Uint8Array(Array.from(m).map(r=>r.charCodeAt(0)));try{const r=await crypto.subtle.decrypt(n,p,m);return(new TextDecoder).decode(r)}catch(r){throw Error("Decrypt failed");}}function h(m){document.dispatchEvent(new CustomEvent("_auth_perms",{detail:{ps:m}}))}if(this.lm.length){var k=GPModulesManager_.DEFAULT_PERMISSIONS,l=null;try{if(!d)throw new GPAuthError_;if(!a||!this.publicKey)throw new GPAuthError_;d=1===d?"t":"d";const m=JSON.parse(await f(a,
this.publicKey)),n=JSON.parse(await f(m[d],c));m.e&&this.setEditionTitle(m.e,m.m);m.g&&(l=[GPModulesManager_.EDITION_STATE.GIFT]);if(n.ed){if(n.ed<Date.now())throw l=[GPModulesManager_.EDITION_STATE.EXPIRED],2&n.p&&(k|=16),new GPAuthError_;l=[GPModulesManager_.EDITION_STATE.TIME_LEFT,n.ed-Date.now()]}else m.g||(l=[GPModulesManager_.EDITION_STATE.SUBSCRIPTION]);l&&this.setEditionState(...l);g.call(this,k|n.p);h.call(this,k|n.p);this.renderModulesList()}catch(m){m instanceof GPAuthError_||console.error(m),
e&&!l&&(l=[GPModulesManager_.EDITION_STATE.FREE]),l&&this.setEditionState(...l),g.call(this,k),h.call(this,k)}}});document.addEventListener("_auth_key_changed",c=>{this.container.classList.add("reload-required_")});document.addEventListener("_auth_key",({detail:{publicKey:c}})=>{this.publicKey=c});document.addEventListener("_act_init",({detail:{pasteKey:c}})=>{this.pasteKey=c});this.render();this.setEditionTitle("base")}getElement(){return this.container}getSettingsManager(){return this.settingsManager}render(){this.container=
document.createElement("div");this.container.className="gp-mm_";this.container.style.setProperty("--edition-free-label",`'${this.l.EDITION_FREE_LBL}'`);this.container.style.setProperty("--edition-gift-label",`'${this.l.EDITION_GIFT_LBL}'`);this.container.style.setProperty("--edition-subs-label",`'${this.l.EDITION_SUBS_LBL}'`);this.container.style.setProperty("--edition-expired-label",`'${this.l.EDITION_EXPIRED_LBL}'`);var a=document.createElement("div");a.className="buttons";this.container.appendChild(a);
const b=document.createElement("div");b.className="show-btn_ gp-module-btn_ btn_";b.title=this.l.MODULE_BTN_TTL;b.addEventListener("pointerup",d=>{const e=this.container.classList.contains("shown_");this.container.classList.toggle("shown_",!e);e&&this.settingsManager.toggle(!1,void 0,d.ctrlKey||1===d.button);b.classList.toggle("pressed_",!e)});a.appendChild(b);this.settingsBtn=document.createElement("div");this.settingsBtn.className="settings-btn_ btn_";this.settingsBtn.title=this.l.SETTINGS_BTN_TTL;
this.settingsBtn.addEventListener("pointerup",d=>{this.settingsManager.toggle(void 0,void 0,d.ctrlKey||1===d.button)});a.appendChild(this.settingsBtn);this.keyBtn=document.createElement("div");this.keyBtn.className="key-btn_ btn_";this.keyBtn.title=this.l.KEY_BTN_TTL;this.keyBtn.addEventListener("click",d=>{d=this.keyInput.classList.contains("hidden");this.keyInput.classList.toggle("hidden",!d);d&&this.keyInput.focus();this.settingsManager.close()});this.keyBtn.addEventListener("pointerdown",d=>{this.keyInput.preventHiding=
!0});a.appendChild(this.keyBtn);this.keyInput=document.createElement("input");this.keyInput.className="key-input_ gp-input_ hidden";this.keyInput.placeholder=this.l.KEY_INPUT_PH;this.keyInput.spellcheck=!1;this.keyInput.autocomplete="off";this.keyInput.preventHiding=!1;this.keyInput.addEventListener("input",d=>{if(this.pasteKey){d=d.target.value.trim();var e=this.pasteKey(d);this.keyInput.classList.toggle("hidden",e);this.keyInput.classList.toggle("invalid_",d&&!e)}});this.keyInput.addEventListener("keydown",
d=>{switch(d.key){case "Escape":d.target.blur()}});this.keyInput.addEventListener("focus",d=>{document.dispatchEvent(new CustomEvent("_keys_lock",{detail:{state:!0}}));d.target.value="";d.target.preventHiding=!1});this.keyInput.addEventListener("blur",d=>{document.dispatchEvent(new CustomEvent("_keys_lock",{detail:{state:!1}}));d.target.value="";d.target.classList.remove("invalid_");d.target.preventHiding?d.target.preventHiding=!1:this.keyInput.classList.add("hidden")});this.container.appendChild(this.keyInput);
this.langBtn=document.createElement("div");this.langBtn.className="lang-btn_ btn_";this.langBtn.title=this.l.LANGUAGE_BTN_TTL;this.langBtn.dataset.lang=this.lang;this.langBtn.addEventListener("pointerdown",d=>{0===d.button&&(this.langBtn.classList.add("shown_"),this.settingsManager.close(),this.langBtn.classList.contains("shown_")&&document.addEventListener("click",e=>{document.addEventListener("pointerdown",g=>{this.langBtn.classList.remove("shown_")},{once:!0,capture:!0})},{once:!0}))});a.appendChild(this.langBtn);
const c=document.createElement("div");c.className="lang-list_";c.addEventListener("click",d=>{this.langBtn.classList.remove("shown_")});c.addEventListener("pointerup",d=>{if(d.target.classList.contains("btn_")){var e=d.target.dataset.lang,g=e!==this.lang;this.langBtn.dataset.lang=e;g&&(this.setLanguage(e),Array.from(c.children).forEach(f=>{f.classList.toggle("selected_",f===d.target)}),this.langBtn.classList.remove("shown_"))}});Object.entries(GPModulesManager_.LANGUAGES).forEach(([d,e])=>{const g=
document.createElement("div");g.className="btn_";g.title=e;g.dataset.lang=d;c.appendChild(g);d===this.lang&&g.classList.add("selected_")});this.langBtn.appendChild(c);a=document.createElement("div");a.className="title_";a.textContent=this.l.WIN_TITLE;this.container.appendChild(a);this.edition=document.createElement("div");this.edition.className="edition_ hidden";this.edition.addEventListener("click",d=>{d=d.target.dataset.state;if(d===GPModulesManager_.EDITION_STATE.FREE||d===GPModulesManager_.EDITION_STATE.EXPIRED)d=
document.createElement("a"),d.href="https://boosty.to/gpmod",d.target="_blank",d.click()});this.container.appendChild(this.edition);this.editionTitle=document.createElement("div");this.editionTitle.className="edition-title_";this.edition.appendChild(this.editionTitle);a=document.createElement("div");a.className="ribbon_";this.edition.appendChild(a);this.modulesList=document.createElement("div");this.modulesList.className="modules-list_";this.modulesList.addEventListener("contextmenu",this.onMListContextMenu);
this.modulesList.addEventListener("pointerup",this.onMListClick);this.container.appendChild(this.modulesList);this.reloadBtn=document.createElement("div");this.reloadBtn.className="gp-btn_ reload-btn_";this.reloadBtn.classList.add("disabled_");this.reloadBtn.textContent=this.l.RELOAD_BTN_LBL;this.reloadBtn.addEventListener("click",this.reloadBtnClickHandler);this.container.appendChild(this.reloadBtn);document.body.appendChild(this.container)}setEditionTitle(a,b=!1){this.editionTitle.textContent=`${a} ed.`;
this.edition.classList.toggle("demo_",!!b);this.edition.classList.remove("hidden")}setEditionState(a,b){this.edition.dataset.state=a;this.edition.title="";a===GPModulesManager_.EDITION_STATE.TIME_LEFT?this.edition.dataset.timeLeft=this.formatTimeLeft(b):a===GPModulesManager_.EDITION_STATE.EXPIRED&&(this.edition.title=this.l.BOOSTY_ICON_TTL)}formatTimeLeft(a){a=Math.trunc(a/864E5);const b=a%100;var c=b%10;let d;if(10<=b&&20>b)d=2;else if(1===c)d=0;else if(1<c&&5>c)d=1;else if(!c||4<c)d=2;c=["\u041e\u0441\u0442\u0430\u043b\u0441\u044f",
"\u041e\u0441\u0442\u0430\u043b\u043e\u0441\u044c"];const e=["\u0434\u0435\u043d\u044c","\u0434\u043d\u044f","\u0434\u043d\u0435\u0439"];return`${d?c[1]:c[0]} ${1>b?"\u043c\u0435\u043d\u044c\u0448\u0435 \u0434\u043d\u044f":`${a} ${e[d]}`}`}onMListClick(a){2===a.button?a.preventDefault():a.target.matches(".module-title_, .module-settings_")&&!a.target.classList.contains("disabled_")&&this.settingsManager.toggle(!0,a.target.dataset.module,a.ctrlKey||1===a.button)}onMListContextMenu(a){a.preventDefault();
a.stopPropagation();a.target.matches(".module-title_")&&!a.target.classList.contains("disabled_")&&this.settingsManager.toggle(!0,a.target.dataset.module,a.ctrlKey||1===a.button)}compareToInitialState(){const a=[...this.modulesList.querySelectorAll(".gp-cb_")].some(b=>b.checked!==this.initialState[b.name]);this.reloadBtn.classList.toggle("alert_",a);this.reloadBtn.classList.toggle("disabled_",!a)}reloadBtnClickHandler(a){GPModulesManager_.FORCE_RELOAD&&(window.onbeforeunload=null);location.reload()}setModules(a,
b,c){this.modules=a;this.rootThis=b;this.root=c;this.initDisabledList();this.initHiddenSettings();this.initModules(b,c).then(()=>{this.renderModulesList();this.dispatchEvent(new Event("ready"))}).catch(d=>{console.error(d);d instanceof GPModuleError_&&this.renderError(d)})}initModules(a,b){return new Promise((c,d)=>{this.modules.forEach(e=>{this.initialState[e.name]=this.disabledList.has(e.name)&&!e.required?!1:!0;const g=[],f=e.dependencies?.length?e.dependencies.every(k=>{if(k in window)return!0;
e.required?g.push(`\u0417\u0430\u0432\u0438\u0441\u0438\u043c\u044b\u0439 \u043c\u043e\u0434\u0443\u043b\u044c "${k}" \u043a \u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e\u043c\u0443 \u043c\u043e\u0434\u0443\u043b\u044e "${e.name}" \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d`):g.push(`\u0417\u0430\u0432\u0438\u0441\u0438\u043c\u044b\u0439 \u043c\u043e\u0434\u0443\u043b\u044c "${k}" \u043a \u043c\u043e\u0434\u0443\u043b\u044e "${e.name}" \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d`);
return!1}):!0,h=e.name in window;e.loaded=h&&f;e.title=window[e.name].MODULE.title;if(e.loaded)window[e.name].INIT&&(e.required?(window[e.name].INIT.apply(a,[b,this.loc.get(e.name)]),window[e.name].toggleSettingsVisibility=this.toggleSettingsVisibility(e),e.initialized=!0):this.lm.push(e));else if(!f){g.forEach(k=>{console.error(k)});if(e.required)throw new GPModuleError_(`\u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u044b\u0439 \u043c\u043e\u0434\u0443\u043b\u044c "${e.name}" \u043d\u0435 \u043c\u043e\u0436\u0435\u0442 \u0431\u044b\u0442\u044c \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043d`);
console.error(`\u041c\u043e\u0434\u0443\u043b\u044c "${e.name}" \u043d\u0435 \u043c\u043e\u0436\u0435\u0442 \u0431\u044b\u0442\u044c \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043d`)}else if(!h){if(e.required)throw new GPModuleError_(`\u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u044b\u0439 \u043c\u043e\u0434\u0443\u043b\u044c "${e.name}" \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d`);console.error(`\u041c\u043e\u0434\u0443\u043b\u044c "${e.name}" \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d`)}});
c()})}toggleSettingsVisibility(a){return b=>{a.hiddenSettings===b&&(a.hiddenSettings=!b,a.hidden||a.hiddenSettings?this.hiddenSettings.add(a.name):this.hiddenSettings.delete(a.name),this.renderModulesList(),this.settingsManager.renderSettingsList())}}initDisabledList(){let a=!1;this.modules.forEach(b=>{b.disabled?(this.disabledList.add(b.name),a=!0):this.disabledList.has(b.name)&&(b.disabled=!0)});a&&this.dispatchEvent(new Event("disabled-list-updated"))}initHiddenSettings(){this.hiddenSettings.clear();
this.modules.forEach(a=>{(a.hidden||a.hiddenSettings)&&this.hiddenSettings.add(a.name)})}renderModulesList(){const a=document.createDocumentFragment(),b=new Intl.Collator("us",{sensitivity:"base"});this.modules.sort((c,d)=>{const [e,g]=[!c.locked,!d.locked];return e&&g||!e&&!g?b.compare(c.title,d.title):e&&!g?-1:1});this.modules.forEach((c,d)=>{if(!c.hidden){var e=this.settingsManager.hasSettings(c.name),g=document.createElement("div");g.className="module_";g.classList.toggle("locked_",!!c.locked);
var f=document.createElement("div");f.className="module-title_";f.classList.toggle("not-loaded_",!c.loaded);f.classList.toggle("disabled_",!!c.hiddenSettings||!e);f.title=c.loaded?"":"\u041c\u043e\u0434\u0443\u043b\u044c \u043d\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043d";f.dataset.module=c.name;f.textContent=c.title;g.appendChild(f);f=document.createElement("div");f.className="module-settings_";f.classList.toggle("disabled_",!!c.hiddenSettings||!e);f.dataset.module=c.name;f.textContent=
"\ue92d";g.appendChild(f);f=this.initialState[c.name];e=document.createElement("div");e.className="module-tumbler_";var h=document.createElement("input");h.className="gp-cb_";h.id=`module-${d}_`;h.type="checkbox";h.checked=f;h.toggleAttribute("checked",!!f);h.toggleAttribute("disabled",!!c.required);h.addEventListener("change",k=>{c.required||(k.target.checked&&this.disabledList.has(c.name)?(c.disabled=!1,this.disabledList.delete(c.name)):(c.disabled=!0,this.disabledList.add(c.name)),this.saveSettings(),
this.compareToInitialState())});e.appendChild(h);f=document.createElement("label");f.className="gp-cb-label_";f.setAttribute("for",`module-${d}_`);e.appendChild(f);g.appendChild(e);a.appendChild(g)}});this.settingsBtn.classList.toggle("hidden",!this.settingsManager.hasModulesSettings());this.modulesList.innerHTML="";this.modulesList.appendChild(a)}renderError(a){const b=document.createElement("div");b.className="error_";b.innerHTML=`<div class="error-msg_">${a.message}</div>`;this.modulesList.before(b);
this.modulesList.remove()}areHiddenSettings(a){return this.hiddenSettings.has(a)}setLanguage(a){this.lang=a;var b=this.lang!==this.loc.getLang();this.reloadBtn.classList.toggle("alert_",b);this.reloadBtn.classList.toggle("disabled_",!b);if(b=GPModulesManager_.RELOAD_BTN_L10N[a])this.reloadBtn.textContent=b;window.localStorage.setItem("gp_localization",JSON.stringify({lang:a}))}saveSettings(){this.settings.disabledList=Array.from(this.disabledList);window.localStorage.setItem(GPModulesManager_.STORAGE_NAME,
JSON.stringify(this.settings))}}class GPModuleError_ extends Error{constructor(a){super(a)}}class GPAuthError_ extends Error{constructor(a){super(a)}};class GPSettingsManager_ extends EventTarget{constructor(a,b){super();this.mm=a;this.l=b;this.viewsData=new Map;this.isRendered=!1;this.close=this.close.bind(this);this.addEventListener("update",({detail:{source:c,storage:d,settings:e,changedSettings:g}})=>{c.dispatchEvent(new CustomEvent("settings_updated",{detail:{settings:g}}));this.saveSettings(d,Object.assign({},e,g))})}getElement(){return this.container}setSettings(a,b){const {name:c,MODULE:{title:d,settings:{storage:e,defaultSettings:g,ui:f=
{}}}}=a.constructor;b&&a.addEventListener("settings_updated",b.bind(a));b=Object.assign({},g,JSON.parse(window.localStorage.getItem(e))||{});a.settings=b;const h=[...Object.values(f)].some(l=>!l.hidden),k=this.copy(b);this.viewsData.set(c,{title:d,source:a,storage:e,settings:b,defaultSettings:g,initialSettings:k,ui:f,hasVisibleSettings:h});return this.buildSettingsAPI(c,b,f,e,a)}hasSettings(a){return this.viewsData.has(a)&&this.hasVisibleSettings(a)}hasModulesSettings(){return!!this.viewsData.size}buildSettingsAPI(a,
b,c,d,e){const g=this;return new Proxy(b,{set(f,h,k){k={[h]:k};Object.assign(f,k);h=!(!c[h]||!0===c[h].hidden);g.dispatchEvent(new CustomEvent("update",{detail:{source:e,storage:d,settings:f,changedSettings:k}}));h&&g.isRendered&&a===g.selectSettings.value&&g.renderSettings(a);return!0},get(f,h){return f[h]}})}render(a,b){this.container=document.createElement("div");this.container.className="gp-settings-manager_";const c=document.createElement("div");c.className="close-btn_";c.addEventListener("click",
this.close);this.container.appendChild(c);this.settingsView=document.createElement("div");this.settingsView.className="gp-settings_";this.container.appendChild(this.settingsView);this.selectSettings=document.createElement("select");this.selectSettings.className="select-module_";this.selectSettings.addEventListener("change",d=>{this.renderSettings(d.target.value)});this.container.appendChild(this.selectSettings);this.isRendered=!0;this.renderSettingsList();this.selectSettings.value&&(this.selectSettings.value=
a||this.selectSettings.value,this.renderSettings(a||this.selectSettings.value,b))}renderSettingsList(){if(this.isRendered){this.selectSettings.innerHTML="";var a=new Intl.Collator("us",{sensitivity:"base"});Array.from(this.viewsData).filter(([b])=>!this.isHiddenModule(b)&&this.hasVisibleSettings(b)).sort(([,b],[,c])=>a.compare(b.title,c.title)).forEach(([b,c])=>{const d=document.createElement("option");d.value=b;d.textContent=c.title;this.selectSettings.appendChild(d)})}}renderSettings(a){if(a&&this.viewsData.has(a)&&
!this.isHiddenModule(a)){var {source:b,storage:c,settings:d,ui:e}=this.viewsData.get(a);this.settingsView.innerHTML="";this.settingsView.classList.remove("json-data_");var g=document.createElement("div");g.className="controls_ gp-scrollbar_";this.settingsView.appendChild(g);var f=document.createElement("div");f.className="buttons_";this.settingsView.appendChild(f);var h=document.createElement("div");h.className="load-btn_ btn_ gp-btn_";h.textContent="\ud83e\udc45";h.title=this.l.LOAD_JSON_TTL;h.addEventListener("click",
()=>{this.settingsView.classList.toggle("json-data_");k.focus()});h.addEventListener("animationend",n=>{n.target.classList.remove("failure_");n.target.classList.remove("success_")});f.appendChild(h);var k=document.createElement("input");k.className="json-data-input_ gp-input_";k.placeholder=this.l.JSON_INPUT_PH;k.spellcheck=!1;k.autocomplete="off";k.addEventListener("input",n=>{this.jsonDataInputHandler(a,n.target,h)});k.addEventListener("focus",n=>{document.dispatchEvent(new CustomEvent("_keys_lock",
{detail:{state:!0}}))});k.addEventListener("blur",n=>{document.dispatchEvent(new CustomEvent("_keys_lock",{detail:{state:!1}}))});f.appendChild(k);var l=document.createElement("div");l.className="restore-btn_ btn_ gp-btn_";l.textContent=this.l.RESTORE_BTN_LBL;l.title=this.l.RESTORE_BTN_TTL;l.addEventListener("click",()=>{this.restore(a)});f.appendChild(l);l=document.createElement("div");l.className="gp-btn_ btn_ default-btn_";l.textContent=this.l.RESET_BTN_LBL;l.title=this.l.RESET_BTN_TTL;l.addEventListener("click",
()=>{this.reset(a)});f.appendChild(l);f=document.createDocumentFragment();for(let n in e){l=e[n]||{};const {type:p,args:r,hidden:q,description:z,text:A}=l;if(this.isLabel(n)){var m=document.createElement("div");m.className=A?"group-label_":"separator_";m.classList.toggle(l.size,!!l.size);m.textContent=A;f.appendChild(m)}else if(p&&!q)if("component"===p)[l]=r,m=document.createElement("div"),m.className="component_",m.appendChild(l()),f.appendChild(m);else if("buttons"===p){const y=document.createElement("div");
y.className="buttons_";[l]=r;l().forEach(t=>{t.classList.add("btn_");y.appendChild(t)});f.appendChild(y)}else if("buttons-g"===p){const y=document.createElement("div");y.className="buttons_";r.forEach(([t,w,u])=>{const x=document.createElement("div");x.className="btn_";x.title=w;x.textContent=t;x.addEventListener("click",u);y.appendChild(x)});f.appendChild(y)}else l=this.buildTooltip(z),f.appendChild(l),l=this.buildLabel(n,z),f.appendChild(l),l=this.buildControl(e,n,d[n],b,c,d),f.appendChild(l)}g.appendChild(f);
this.controls=g;this.selectSettings.value=a}}isLabel(a){return/^_\d+/.test(a)}buildTooltip(a){const b=document.createElement("div");b.className="tooltip_";b.textContent="?";if(!a)return b.classList.add("disabled_"),b;b.addEventListener("pointerenter",c=>{let d=window.gpSettingsTooltip;d||(d=document.createElement("div"),d.className="gp-settings-tooltip_",document.body.appendChild(d),window.gpSettingsTooltip=d);d.textContent=a;const {x:e,y:g,width:f,height:h}=c.target.getBoundingClientRect();({height:c}=
d.getBoundingClientRect());d.style.cssText=`top: ${g-(c-h)/2}px; left: ${e+f+12}px`;window.gpSettingsTooltip=d});b.addEventListener("pointerleave",c=>{window.gpSettingsTooltip&&(window.gpSettingsTooltip.remove(),window.gpSettingsTooltip=null)});return b}buildLabel(a,b){const c=document.createElement("div");c.className="label_";c.title=b||"";c.textContent=a.split(/(?<![A-Z])(?=[A-Z])|(?=[A-Z]\B)/).join(" ");return c}buildControl(a,b,c,d,e,g){const {type:f,data:h,args:k,formatter:l,proxyProp:m,inputTrigger:n}=
a[b];a=document.createElement("div");a.className="control_";let p;switch(f){case "range":const q=document.createElement("div");q.className="preview_ gp-range-preview_";q.textContent=l?l(c):c;const [z,A,y,t]=k;p=document.createElement("input");p.className="gp-range_";p.type="range";p.min=z;p.max=A;p.step=y;p.value=c;p.name=b;t&&(p.style.direction="rtl");p.addEventListener("input",u=>{q.textContent=l?l(Number.parseFloat(u.target.value)):u.target.value});a.appendChild(p);a.appendChild(q);break;case "list":p=
document.createElement("select");p.className="gp-list_";p.autocomplete="off";p.name=b;(m&&g[m]||(k.length?k:[c])).forEach((u,x)=>{const v=document.createElement("option");v.value=u;v.textContent=l?l(u,x):u;p.appendChild(v)});p.value=c;a.appendChild(p);break;case "list-m":case "list-md":var r="list-m"===f?k:c;p=document.createElement("form");p.className="gp-list-m_";p.name=b;r.forEach((u,x)=>{var v=document.createElement("input");v.id=`ctrl-${b}-${x}_`;v.type="checkbox";v.value=u;v.name=b;v.checked=
c.includes(u);p.appendChild(v);v=document.createElement("label");v.textContent=l?l(u,x):u;v.setAttribute("for",`ctrl-${b}-${x}_`);p.appendChild(v)});a.appendChild(p);break;case "list-i":const w=[];p=document.createElement("form");p.className="gp-list-i_";p.name=b;Object.keys(h.icons).forEach((u,x)=>{const v=document.createElement("input");v.id=`ctrl-${b}-${x}_`;v.type="checkbox";v.name=b;v.value=u;v.checked=c===u;v.addEventListener("click",C=>{w.forEach(D=>{D.checked=D===v})});p.appendChild(v);w.push(v);
const B=document.createElement("label");B.className="gp-list-i-icon_";B.title=u.split("-").map(C=>C[0].toUpperCase()+C.slice(1)).join(" ");B.style.backgroundImage=`url("${h.icons[u]}")`;B.setAttribute("for",`ctrl-${b}-${x}_`);p.appendChild(B)});a.appendChild(p);break;case "checkbox":p=document.createElement("div");p.className="gp-tumbler_";r=document.createElement("input");r.id=`ctrl-${b}_`;r.type="checkbox";r.name=b;r.checked=c;p.appendChild(r);r=document.createElement("label");r.setAttribute("for",
`ctrl-${b}_`);p.appendChild(r);a.appendChild(p);break;case "color":p=document.createElement("input");p.className="gp-color_";p.type="color";p.value=c;p.name=b;a.appendChild(p);break;case "input":({hidden:r}=k||{}),p=document.createElement("input"),p.className="gp-input_",p.classList.toggle("secure-input_",!!r),p.spellcheck=!1,p.autocomplete="off",p.value=c,p.name=b,p.addEventListener("keydown",u=>{switch(u.key){case "Escape":u.target.value=u.target.dataset.initialValue;case "Enter":u.target.blur()}}),
p.addEventListener("focus",u=>{u.target.select();document.dispatchEvent(new CustomEvent("_keys_lock",{detail:{state:!0}}));u.target.dataset.initialValue=u.target.value}),p.addEventListener("blur",u=>{window.getSelection().removeAllRanges();document.dispatchEvent(new CustomEvent("_keys_lock",{detail:{state:!1}}));delete u.target.dataset}),a.appendChild(p)}p.addEventListener(n?"input":"change",q=>{q={[q.target.name]:this.parseValue(q.target,f)};this.dispatchEvent(new CustomEvent("update",{detail:{source:d,
storage:e,settings:Object.assign(g,q),changedSettings:q}}))});return a}parseValue(a,b){switch(a.type){case "range":return Number.parseFloat(a.value);case "checkbox":return a.form?"list-i"===b?a.value:[...a.form].filter(c=>c.checked).map(c=>c.value):a.checked;default:return a.value}}jsonDataInputHandler(a,b,c){c.classList.remove("failure_");c.classList.remove("success_");try{let d=JSON.parse(b.value);const {settings:e,source:g,storage:f}=this.viewsData.get(a);d=this.filterSettings(d,e);if(Object.keys(d).length){const h=
this.copy(d);Object.assign(e,h);this.renderSettings(a);this.dispatchEvent(new CustomEvent("update",{detail:{source:g,storage:f,settings:e,changedSettings:h}}));c.classList.add("success_")}else c.classList.add("failure_")}catch(d){c.classList.add("failure_")}b.value=""}filterSettings(a,b){for(let c in a)c in b||delete a[c];return a}reset(a){const {settings:b,defaultSettings:c,source:d,storage:e}=this.viewsData.get(a),g=this.copy(c);Object.assign(b,g);for(let f in b)f in g||delete b[f];this.renderSettings(a);
this.dispatchEvent(new CustomEvent("update",{detail:{source:d,storage:e,settings:b,changedSettings:g}}))}restore(a){const {settings:b,initialSettings:c,source:d,storage:e}=this.viewsData.get(a),g=this.copy(c);Object.assign(b,g);this.renderSettings(a);this.dispatchEvent(new CustomEvent("update",{detail:{source:d,storage:e,settings:b,changedSettings:g}}))}copy(a){return JSON.parse(JSON.stringify(a))}toggle(a,b,c=!1){this.container?(this.container.classList.toggle("hidden",void 0===a?a:!a),this.settingsView.classList.remove("json-data_"),
a&&b&&this.renderSettings(b),this.container.classList.toggle("load-btn-shown_",!!c)):!1!==a&&(this.render(b),document.body.appendChild(this.getElement()),this.container.classList.toggle("load-btn-shown_",!!c))}close(){this.isOpened()&&this.toggle(!1)}isOpened(){return!this.container?.classList.contains("hidden")}isHiddenModule(a){return this.mm.areHiddenSettings(a)}hasVisibleSettings(a){return this.viewsData.get(a).hasVisibleSettings}saveSettings(a,b){window.localStorage.setItem(a,JSON.stringify(b))}}
window.GPSettingsManager_=GPSettingsManager_;class GPColorPicker_ extends EventTarget{static TOP="top";static BOTTOM="bottom";static LEFT="left";static RIGHT="right";static HORIZONTAL="horizontal";static VERTICAL="vertical";static DEFAULT_WIDTH=250;static DEFAULT_HEIGHT=250;static DEFAULT_HUE_POSITION=this.BOTTOM;static HUE_MIN_SIDE_SIZE=30;static HUE_MARGIN=15;constructor(a=GPColorPicker_.DEFAULT_WIDTH,b=GPColorPicker_.DEFAULT_HEIGHT,c=GPColorPicker_.DEFAULT_HUE_POSITION){super();this.style=document.documentElement.style;this.style.setProperty("--cp-hue-margin",
`${GPColorPicker_.HUE_MARGIN}px`);this.container;this.hsv=[0,0,0];this.width=a;this.height=b;this.palettePointerY=this.palettePointerX=0;this.hueBarSize=this.width-2*GPColorPicker_.HUE_MARGIN;this.huePosition=c;this.huePosDir=c===GPColorPicker_.TOP||c===GPColorPicker_.BOTTOM?GPColorPicker_.HORIZONTAL:GPColorPicker_.VERTICAL;this.huePosDir===GPColorPicker_.HORIZONTAL?(this.hueWidth=this.width,this.hueHeight=GPColorPicker_.HUE_MIN_SIDE_SIZE,this.paletteWidth=this.width,this.paletteHeight=this.height-
this.hueHeight):(this.hueWidth=GPColorPicker_.HUE_MIN_SIDE_SIZE,this.hueHeight=this.height,this.paletteWidth=this.width-this.hueWidth,this.paletteHeight=this.height);this.paletteDownHandler=this.paletteDownHandler.bind(this);this.paletteMoveHandler=this.paletteMoveHandler.bind(this);this.hueSliderDownHandler=this.hueSliderDownHandler.bind(this);this.hueSliderMoveHandler=this.hueSliderMoveHandler.bind(this);this.render()}getElement(){return this.container}hide(){this.container.classList.add("hidden");
this.isHidden=!0}show(a,b){let c=0,d=0;switch(this.huePosition){case GPColorPicker_.LEFT:c=this.hueWidth;break;case GPColorPicker_.TOP:d=this.hueHeight}this.container.style.top=`${b-this.palettePointerY-d}px`;this.container.style.left=`${a-this.palettePointerX-c}px`;this.container.classList.remove("hidden");this.isHidden=!1}render(a,b){this.container=document.createElement("div");this.container.className=`gp-color-picker_ ${this.huePosition}_`;this.container.innerHTML='<div class="palette"><div class="hue"><div class="lightness"><div class="darkness"></div><div class="pointer-wrapper"><div class="pointer"></div></div></div></div></div><div class="hue"><div class="slider-wrapper"><div class="slider"><div class="handle-wrapper"><div class="handle"></div></div></div></div></div>';
this.container.style.width=`${this.width}px`;this.container.style.height=`${this.height}px`;this.palette=this.container.querySelector(".palette");this.palette.addEventListener("pointerdown",this.paletteDownHandler);this.paletteHue=this.container.querySelector(".gp-color-picker_ > .palette .hue");this.pointerWrapper=this.container.querySelector(".gp-color-picker_ > .palette .pointer-wrapper");a=this.container.querySelector(".gp-color-picker_ > .hue");a.style.width=`${this.hueWidth}px`;a.style.height=
`${this.hueHeight}px`;this.hueSlider=this.container.querySelector(".gp-color-picker_ > .hue .slider");this.hueSlider.addEventListener("pointerdown",this.hueSliderDownHandler);this.hueHandleWrapper=this.container.querySelector(".gp-color-picker_ > .hue .handle-wrapper")}paletteDownHandler(a){this.palette.setPointerCapture(a.pointerId);this.palette.addEventListener("pointermove",this.paletteMoveHandler);this.palette.addEventListener("pointerup",b=>{this.palette.removeEventListener("pointermove",this.paletteMoveHandler)},
{once:!0});this.paletteMoveHandler(a)}paletteMoveHandler(a){if(!this.isHidden){var [b,c]=this.getCoords(a);b=Math.max(0,Math.min(this.paletteWidth,b));c=Math.max(0,Math.min(this.paletteHeight,c));this.palettePointerX=b;this.palettePointerY=c;this.updatePalettePointer(b,c);this.hsv=this.getPaletteColor(b,c);this.dispatchEvent(new CustomEvent("color",{detail:{color:GPColorUtils_.hsvToHex(...this.hsv)}}))}}hueSliderDownHandler(a){this.hueSlider.setPointerCapture(a.pointerId);this.hueSlider.addEventListener("pointermove",
this.hueSliderMoveHandler);this.hueSlider.addEventListener("pointerup",b=>{this.hueSlider.removeEventListener("pointermove",this.hueSliderMoveHandler)},{once:!0});this.hueSliderMoveHandler(a)}hueSliderMoveHandler(a){if(!this.isHidden){var [b,c]=this.getCoords(a),d=(a=this.huePosDir===GPColorPicker_.HORIZONTAL)?b:c;this.updateHueSlider(d,a);this.hsv[0]=Math.round(Math.max(0,Math.min(100,d/(this.hueBarSize/100))))/100;this.updatePaletteHue(this.hsv[0]);this.dispatchEvent(new CustomEvent("color",{detail:{color:GPColorUtils_.hsvToHex(...this.hsv)}}))}}updatePalettePointer(a,
b){a=Math.max(0,Math.min(100,a/(this.paletteWidth/100)));this.pointerWrapper.style.top=`${Math.max(0,Math.min(100,b/(this.paletteHeight/100)))}%`;this.pointerWrapper.style.left=`${a}%`}updatePaletteHue(a){const [b,c,d]=GPColorUtils_.hsvToRgb(a,1,1);this.paletteHue.style.backgroundColor=`rgb(${b}, ${c}, ${d})`}updateHueSlider(a,b=this.huePosDir===GPColorPicker_.HORIZONTAL){a=Math.max(0,Math.min(100,a/(this.hueBarSize/100)));b?this.hueHandleWrapper.style.left=`${a}%`:this.hueHandleWrapper.style.top=
`${a}%`}getPaletteColor(a,b){return Number.isNaN(a)||Number.isNaN(b)?this.hsv:[this.hsv[0],Math.max(0,Math.min(100,Math.round(a/(this.paletteWidth/100))))/100,Math.max(0,Math.min(100,Math.round((this.paletteHeight-b)/(this.paletteHeight/100))))/100]}getCoords(a){const b=a.target.getBoundingClientRect(),[c,d]=a.touches?[a.touches[0].clientX,a.touches[0].clientY]:[a.clientX,a.clientY],[e,g]=[c-b.left,d-b.top];return[a.target.clientWidth/b.width*e,a.target.clientHeight/b.height*g]}getColor(){return GPColorUtils_.hsvToHex(...this.hsv)}setColor(a){const [b,
c,d]=GPColorUtils_.hexToHsv(a);this.hsv=[b,c,d];a=this.hueBarSize*b;const e=this.paletteWidth*c,g=this.paletteHeight-this.paletteHeight*d;this.palettePointerX=Math.max(0,Math.min(this.paletteWidth,e));this.palettePointerY=Math.max(0,Math.min(this.paletteHeight,g));this.updateHueSlider(a);this.updatePaletteHue(b);this.updatePalettePointer(e,g)}}window.GPColorPicker_=GPColorPicker_;class GPColorUtils_{static hsvToRgb(a,b,c){let d,e,g;const f=Math.floor(6*a),h=6*a-f;a=c*(1-b);const k=c*(1-h*b);b=c*(1-(1-h)*b);switch(f%6){case 0:d=c;e=b;g=a;break;case 1:d=k;e=c;g=a;break;case 2:d=a;e=c;g=b;break;case 3:d=a;e=k;g=c;break;case 4:d=b;e=a;g=c;break;case 5:d=c,e=a,g=k}return[Math.round(255*d),Math.round(255*e),Math.round(255*g)]}static rgbToHex(a,b,c){return"#"+(16777216+(a<<16)+(b<<8)+c).toString(16).slice(1)}static hsvToHex(a,b,c){a=this.hsvToRgb(a,b,c);return this.rgbToHex(...a)}static hexToRgb(a){a=
a.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(b,c,d,e)=>c+c+d+d+e+e);return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]:null}static rgbToHsv(a,b,c){a/=255;b/=255;c/=255;const d=Math.max(a,b,c),e=Math.min(a,b,c);let g;const f=d-e;if(d==e)g=0;else{switch(d){case a:g=(b-c)/f+(b<c?6:0);break;case b:g=(c-a)/f+2;break;case c:g=(a-b)/f+4}g/=6}return[g,0==d?0:f/d,d]}static hexToHsv(a){a=this.hexToRgb(a);return this.rgbToHsv(...a).map(b=>Math.floor(1E3*
b)/1E3)}}window.GPColorUtils_=GPColorUtils_;class GPPainter_ extends EventTarget{static SEARCH_DRAW_CONTAINER_INTERVAL=200;static TOOL={BRUSH:1,ERASER:2,LINE:3,RECTANGLE:4,CIRCLE:5,RECTANGLE_FILLED:6,CIRCLE_FILLED:7,FILL:8,NOTE:10,DELIMITER:11};static TOOLS_IN_TIME=[this.TOOL.BRUSH,this.TOOL.ERASER,this.TOOL.NOTE];static ORIGINAL_WIDTH=758;static ORIGINAL_HEIGHT=424;static DEFAULT_DENSITY=2;static BACKGROUND_COLOR="#ffffff";static DEFAULT_COLOR="#000000";static DEFAULT_THICKNESS=6;static DEFAULT_OPACITY=1;static DEFAULT_TOOL=this.TOOL.BRUSH;static FIRST_STROKE_ID=1;static DEFAULT_MIN_THICKNESS=2;static DEFAULT_MAX_THICKNESS=300;static DEFAULT_MINIMUM_OPACITY=.02;static DEFAULT_OPACITY_STEP=.03;static DEFAULT_BRIGHTNESS_STEP=.03;static DEFAULT_MIN_ZOOM=1;static DEFAULT_MAX_ZOOM=30;static DEFAULT_ZOOM_SENSITIVITY=10;static DEFAULT_LINE_SMOOTHING_LEVEL=0;static STABILIZER_SIZE=5;static POINTER_COLOR=this.DEFAULT_COLOR;static POINTER_OPACITY=1;static POINTER_OUTLINE_COLOR="#FFFFFF";static POINTER_OUTLINE_OPACITY=1;static POINTER_CROSSHAIR_MIN_THICKNESS=5;static POINTER_CROSSHAIR_LINE_LENGTH=6;static FIXED_SCREEN_SIZE=!1;static READY_CONFIRMATION=!1;static TOOLS_THICKNESSES={[this.TOOL.RECTANGLE_FILLED]:1,
[this.TOOL.CIRCLE_FILLED]:1,[this.TOOL.FILL]:1};static DISABLED_MODE_OPTIONS={visible:[2]};static COLOR_PICKER_WIDTH=250;static COLOR_PICKER_HEIGHT=250;static COLOR_PICKER_HUE_POSITION=GPColorPicker_.RIGHT;static DEFAULT_PANELS_BACKGROUND_COLOR="#5e1933";static DEFAULT_PANELS_BACKGROUND_OPACITY=50;static DEFAULT_PANELS_ELEMENTS_COLOR="#ff8eaf";static DEFAULT_PANELS_ELEMENTS_OPACITY=60;static HEADER_INSTRUCTIONS_COLOR="#43de99";static HIDE_HEADER_BACKGROUND=!1;static AUTO_HIDE_HEADER_ELEMENTS=!1;static AUTO_HIDE_HEADER_ELEMENTS_DELAY=.3;static SYMMETRY_MODES={VERTICAL:0,
HORIZONTAL:1,QUADRANT:2,RADIAL:3,MANDALA:4};static UNSUBSCRIBED_SYMMETRY_MODES=["VERTICAL","HORIZONTAL"];static DEFAULT_SYMMETRY_GUIDES_COLOR="#4affff";static DEFAULT_SYMMETRY_GUIDES_OPACITY=1;static DEFAULT_SYMMETRY_GUIDES_WIDTH=1;static DEFAULT_SYMMETRY_MODE=this.SYMMETRY_MODES.VERTICAL;static SYMMETRY_GUIDES_COUNT_SENSITIVITY=Math.round(window.screen.height/1080*5);static DEFAULT_SYMMETRY_RADIAL_GUIDES_COUNT=8;static DEFAULT_SYMMETRY_MANDALA_GUIDES_COUNT=4;static MIN_SYMMETRY_RADIAL_GUIDES=2;static MAX_SYMMETRY_RADIAL_GUIDES=32;static MIN_SYMMETRY_MANDALA_GUIDES=2;static MAX_SYMMETRY_MANDALA_GUIDES=16;static SYMMETRY_GUIDES_RADIUS=Math.ceil(Math.sqrt(this.ORIGINAL_WIDTH*
this.ORIGINAL_WIDTH+this.ORIGINAL_HEIGHT*this.ORIGINAL_HEIGHT))*this.DEFAULT_DENSITY;static M_STROKE_OFFSET=67;static M_STROKE_RANGE=100;static UI_SETTINGS={_1:{text:"Default Settings"},defaultColor:{value:this.DEFAULT_COLOR,type:"color",description:"\u0426\u0432\u0435\u0442 \u043a\u0438\u0441\u0442\u0438 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e (\u0443\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442\u0441\u044f \u0432 \u043d\u0430\u0447\u0430\u043b\u0435 \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u0440\u0430\u0443\u043d\u0434\u0430)"},
defaultThickness:{value:this.DEFAULT_THICKNESS,type:"range",args:[1,600,1],description:"\u0422\u043e\u043b\u0449\u0438\u043d\u0430 \u043a\u0438\u0441\u0442\u0438 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e (\u0443\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442\u0441\u044f \u0432 \u043d\u0430\u0447\u0430\u043b\u0435 \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u0440\u0430\u0443\u043d\u0434\u0430)"},defaultOpacity:{value:this.DEFAULT_OPACITY,type:"range",
args:[.01,1,.01],description:"\u041d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u044c \u043a\u0438\u0441\u0442\u0438 \u043f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e (\u0443\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442\u0441\u044f \u0432 \u043d\u0430\u0447\u0430\u043b\u0435 \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u0440\u0430\u0443\u043d\u0434\u0430)"},_2:{text:"Thickness"},minThickness:{value:this.DEFAULT_MIN_THICKNESS,type:"range",
args:[1,600,1],description:"\u041c\u0438\u043d\u0438\u043c\u0430\u043b\u044c\u043d\u0430\u044f \u0442\u043e\u043b\u0449\u0438\u043d\u0430 \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u0430\u044f \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},maxThickness:{value:this.DEFAULT_MAX_THICKNESS,type:"range",args:[1,600,1],description:"\u041c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u0430\u044f \u0442\u043e\u043b\u0449\u0438\u043d\u0430 \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u0430\u044f \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
thicknessAxis:{value:"horizontal",type:"list",args:["horizontal","vertical"],description:"\u041f\u043b\u043e\u0441\u043a\u043e\u0441\u0442\u044c \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u043e\u0432\u043a\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c \u0442\u043e\u043b\u0449\u0438\u043d\u044b \u043a\u0438\u0441\u0442\u0438"},upThicknessDirection:{value:"down / right",type:"list",args:["down / right","up / left"],description:"\u041d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043f\u043e\u0432\u044b\u0448\u0435\u043d\u0438\u044f \u0442\u043e\u043b\u0449\u0438\u043d\u044b \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0435 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
doubleEraserThickness:{value:!0,type:"checkbox",description:"\u0423\u0434\u0432\u0430\u0438\u0432\u0430\u0442\u044c \u0442\u043e\u043b\u0449\u0438\u043d\u0443 \u043a\u0438\u0441\u0442\u0438 \u043f\u0440\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0438 \u0438\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442\u0430 \u041b\u0430\u0441\u0442\u0438\u043a"},_3:{text:"Opacity"},minOpacity:{value:this.DEFAULT_MINIMUM_OPACITY,type:"range",args:[.01,1,.01],description:"\u041c\u0438\u043d\u0438\u043c\u0430\u043b\u044c\u043d\u0430\u044f \u043d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u044c \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u0430\u044f \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
opacityStep:{value:this.DEFAULT_OPACITY_STEP,type:"range",args:[.01,.1,.01],description:"\u0428\u0430\u0433 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u043d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u0438 \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0435 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},opacityAxis:{value:"horizontal",type:"list",args:["horizontal","vertical"],description:"\u041f\u043b\u043e\u0441\u043a\u043e\u0441\u0442\u044c \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u043e\u0432\u043a\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c \u043d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u0438 \u043a\u0438\u0441\u0442\u0438"},
upOpacityDirection:{value:"up / left",type:"list",args:["down / right","up / left"],description:"\u041d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043f\u043e\u0432\u044b\u0448\u0435\u043d\u0438\u044f \u043d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u0438 \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0435 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},_4:{text:"Brightness"},brightnessStep:{value:this.DEFAULT_BRIGHTNESS_STEP,
type:"range",args:[.01,.1,.01],description:"\u0428\u0430\u0433 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u044f\u0440\u043a\u043e\u0441\u0442\u0438 \u0446\u0432\u0435\u0442\u0430 \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0435 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},brightnessAxis:{value:"vertical",type:"list",args:["horizontal","vertical"],description:"\u041f\u043b\u043e\u0441\u043a\u043e\u0441\u0442\u044c \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u043e\u0432\u043a\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c \u044f\u0440\u043a\u043e\u0441\u0442\u0438 \u0446\u0432\u0435\u0442\u0430 \u043a\u0438\u0441\u0442\u0438"},
upBrightnessDirection:{value:"up / left",type:"list",args:["down / right","up / left"],description:"\u041d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043f\u043e\u0432\u044b\u0448\u0435\u043d\u0438\u044f \u044f\u0440\u043a\u043e\u0441\u0442\u0438 \u0446\u0432\u0435\u0442\u0430 \u043a\u0438\u0441\u0442\u0438, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0435 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},_5:{text:"Zoom"},minZoom:{value:this.DEFAULT_MIN_ZOOM,
type:"range",args:[.1,1,.1],description:"\u041c\u0438\u043d\u0438\u043c\u0430\u043b\u044c\u043d\u044b\u0439 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u043f\u0440\u0438\u0431\u043b\u0438\u0436\u0435\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0435 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},maxZoom:{value:this.DEFAULT_MAX_ZOOM,type:"range",args:[2,60,1],description:"\u041c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u044b\u0439 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u043f\u0440\u0438\u0431\u043b\u0438\u0436\u0435\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0435 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
zoomSensitivity:{value:this.DEFAULT_ZOOM_SENSITIVITY,type:"range",args:[1,20,1],description:"\u0427\u0443\u0432\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c \u043f\u0440\u0438\u0431\u043b\u0438\u0436\u0435\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0435 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},zoomAxis:{value:"vertical",type:"list",args:["horizontal","vertical"],
description:"\u041f\u043b\u043e\u0441\u043a\u043e\u0441\u0442\u044c \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u043e\u0432\u043a\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c \u043f\u0440\u0438\u0431\u043b\u0438\u0436\u0435\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430"},zoomInDirection:{value:"up / left",type:"list",args:["down / right","up / left"],description:"\u041d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043f\u0440\u0438\u0431\u043b\u0438\u0436\u0435\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430, \u0440\u0435\u0433\u0443\u043b\u0438\u0440\u0443\u0435\u043c\u043e\u0435 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
maxZoomToPoint:{value:3,type:"range",args:[2,60,1],description:"\u041c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u043e\u0435 \u043f\u0440\u0438\u0431\u043b\u0438\u0436\u0435\u043d\u0438\u0435 \u0445\u043e\u043b\u0441\u0442\u0430 \u0432 \u0432\u044b\u0431\u0440\u0430\u043d\u043d\u0443\u044e \u0442\u043e\u0447\u043a\u0443"},_6:{text:"Pointer"},pointerOpacity:{value:this.POINTER_OPACITY,type:"range",args:[0,1,.1],description:"\u041f\u0440\u043e\u0437\u0440\u0430\u0447\u043d\u043e\u0441\u044c \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044f"},
pointerOutlineOpacity:{value:this.POINTER_OUTLINE_OPACITY,type:"range",args:[0,1,.1],description:"\u041f\u0440\u043e\u0437\u0440\u0430\u0447\u043d\u043e\u0441\u044c \u043a\u043e\u043d\u0442\u0443\u0440\u0430 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044f"},_7:{text:"Color Picker"},colorPickerHuePosition:{value:this.COLOR_PICKER_HUE_POSITION,type:"list",args:[GPColorPicker_.TOP,GPColorPicker_.BOTTOM,GPColorPicker_.RIGHT,GPColorPicker_.LEFT],description:"\u0420\u0430\u0441\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u0435 \u043f\u043e\u043b\u0437\u0443\u043d\u043a\u0430 \u043e\u0442\u0442\u0435\u043d\u043a\u0430 \u0434\u043b\u044f \u043f\u0430\u043b\u0438\u0442\u0440\u044b \u0446\u0432\u0435\u0442\u043e\u0432 (\u043f\u043e\u0434 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c)"},
colorPickerWidth:{value:250,type:"range",args:[100,350,1],description:"\u0428\u0438\u0440\u0438\u043d\u0430 \u043f\u0430\u043b\u0438\u0442\u0440\u044b \u0446\u0432\u0435\u0442\u043e\u0432 (\u043f\u043e\u0434 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c)"},colorPickerHeight:{value:250,type:"range",args:[100,350,1],description:"\u0412\u044b\u0441\u043e\u0442\u0430 \u043f\u0430\u043b\u0438\u0442\u0440\u044b \u0446\u0432\u0435\u0442\u043e\u0432 (\u043f\u043e\u0434 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c)"},
_8:{text:"Interface"},fixedScreenSize:{value:this.FIXED_SCREEN_SIZE,type:"checkbox",description:"\u0424\u0438\u043a\u0441\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0439 \u0440\u0430\u0437\u043c\u0435\u0440 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0430 (\u0438\u0433\u043d\u043e\u0440\u0438\u0440\u0443\u0435\u0442 \u0440\u0430\u0437\u043c\u0435\u0440 \u043e\u043a\u043d\u0430 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430)"},
readyConfirmation:{value:this.READY_CONFIRMATION,type:"checkbox",description:'\u041f\u043e\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043d\u0438\u0435 \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043d\u0438\u044f \u0445\u043e\u0434\u0430, \u0435\u0441\u043b\u0438 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440 "\u0412\u0420\u0415\u041c\u042f" \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d, \u043a\u0430\u043a "\u0420\u0415\u0428\u0415\u041d\u0418\u0415 \u0412\u0415\u0414\u0423\u0429\u0415\u0413\u041e" (\u043f\u0440\u0438 \u0443\u0441\u043b\u043e\u0432\u0438\u0438, \u0447\u0442\u043e \u0412\u044b \u044f\u0432\u043b\u044f\u0435\u0442\u0435\u0441\u044c \u0432\u043b\u0430\u0434\u0435\u043b\u044c\u0446\u0435\u043c \u043a\u043e\u043c\u043d\u0430\u0442\u044b)'},
extendedPalettePanel:{value:!0,type:"checkbox",description:"\u0420\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u043d\u0430\u044f \u043f\u0430\u043d\u0435\u043b\u044c \u043f\u0430\u043b\u0438\u0442\u0440\u044b (\u0437\u0430\u043c\u0435\u043d\u044f\u0435\u0442 \u043e\u0441\u043d\u043e\u0432\u043d\u0443\u044e)"},extendedPaletteName:{value:"default",hidden:!0},colorPickerPanel:{value:!0,type:"checkbox",description:"\u041f\u0430\u043d\u0435\u043b\u044c \u0432\u044b\u0431\u043e\u0440\u0430 \u0446\u0432\u0435\u0442\u0430"},
panelsBackgroundColor:{value:this.DEFAULT_PANELS_BACKGROUND_COLOR,type:"color",inputTrigger:!0,description:"\u0426\u0432\u0435\u0442 \u0444\u043e\u043d\u0430 \u043f\u0430\u043d\u0435\u043b\u0435\u0439 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430"},panelsBackgroundOpacity:{value:this.DEFAULT_PANELS_BACKGROUND_OPACITY,type:"range",args:[0,100,1],inputTrigger:!0,description:"\u041f\u0440\u043e\u0437\u0440\u0430\u0447\u043d\u043e\u0441\u0442\u044c \u0444\u043e\u043d\u0430 \u043f\u0430\u043d\u0435\u043b\u0435\u0439 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430"},
panelsElementsColor:{value:this.DEFAULT_PANELS_ELEMENTS_COLOR,type:"color",inputTrigger:!0,description:"\u0426\u0432\u0435\u0442 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432 \u043f\u0430\u043d\u0435\u043b\u0435\u0439 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430"},panelsElementsOpacity:{value:this.DEFAULT_PANELS_ELEMENTS_OPACITY,type:"range",args:[0,100,1],inputTrigger:!0,description:"\u041f\u0440\u043e\u0437\u0440\u0430\u0447\u043d\u043e\u0441\u0442\u044c \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432 \u043f\u0430\u043d\u0435\u043b\u0435\u0439 \u0438\u043d\u0442\u0435\u0440\u0444\u0435\u0439\u0441\u0430"},
_9:{text:"Header"},hideHeaderBackground:{value:this.HIDE_HEADER_BACKGROUND,type:"checkbox",description:"\u0421\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u0444\u043e\u043d \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0430 \u0438 \u0440\u0430\u043c\u043a\u0438 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0430"},autoHideHeaderElements:{value:this.AUTO_HIDE_HEADER_ELEMENTS,type:"checkbox",description:"\u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u0441\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u044b \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0430 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0430 (\u043a\u0440\u043e\u043c\u0435 \u043b\u043e\u0433\u043e \u0438 \u0437\u0430\u043f\u0443\u0449\u0435\u043d\u043d\u043e\u0433\u043e \u0442\u0430\u0439\u043c\u0435\u0440\u0430) \u0438 \u043f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u043f\u0440\u0438 \u043d\u0430\u0432\u0435\u0434\u0435\u043d\u0438\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044f"},
autoHideHeaderDelay:{value:this.AUTO_HIDE_HEADER_ELEMENTS_DELAY,type:"range",args:[0,1,.1],description:"\u0417\u0430\u0434\u0435\u0440\u0436\u043a\u0430 \u043f\u0435\u0440\u0435\u0434 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u043c \u0441\u043a\u0440\u044b\u0442\u0438\u0435\u043c/\u043f\u043e\u043a\u0430\u0437\u043e\u043c \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432 \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0430"},headerInstructionsColor:{value:this.HEADER_INSTRUCTIONS_COLOR,
type:"color",inputTrigger:!0,description:"\u0426\u0432\u0435\u0442 \u0438\u043d\u0441\u0442\u0440\u0443\u043a\u0446\u0438\u0439 \u0432 \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0435 \u0440\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0430"},_10:{text:"Line Smoothing"},lineSmoothingLevel:{value:this.DEFAULT_LINE_SMOOTHING_LEVEL,type:"range",args:[0,8,1],description:"\u0423\u0440\u043e\u0432\u0435\u043d\u044c \u0441\u0433\u043b\u0430\u0436\u0438\u0432\u0430\u043d\u0438\u044f \u043b\u0438\u043d\u0438\u0439 \u0434\u043b\u044f \u0438\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442\u043e\u0432 \u041a\u0438\u0441\u0442\u044c, \u041b\u0430\u0441\u0442\u0438\u043a \u0438 \u0417\u0430\u043c\u0435\u0442\u043a\u0430"},
eraserLineSmoothing:{value:!1,type:"checkbox",description:"\u041f\u0440\u0438\u043c\u0435\u043d\u044f\u0442\u044c \u0441\u0433\u043b\u0430\u0436\u0438\u0432\u0430\u043d\u0438\u0435 \u043b\u0438\u043d\u0438\u0439 \u0434\u043b\u044f \u0438\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442\u0430 \u041b\u0430\u0441\u0442\u0438\u043a"},_11:{text:"Symmetry Guides"},symmetryGuidesColor:{value:this.DEFAULT_SYMMETRY_GUIDES_COLOR,type:"color",inputTrigger:!0,description:"\u0426\u0432\u0435\u0442 \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u044f\u044e\u0449\u0438\u0445 \u0441\u0438\u043c\u043c\u0435\u0442\u0440\u0438\u0438"},
symmetryGuidesOpacity:{value:this.DEFAULT_SYMMETRY_GUIDES_OPACITY,type:"range",args:[0,1,.01],inputTrigger:!0,description:"\u041d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u044c \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u044f\u044e\u0449\u0438\u0445 \u0441\u0438\u043c\u043c\u0435\u0442\u0440\u0438\u0438"},symmetryGuidesWidth:{value:this.DEFAULT_SYMMETRY_GUIDES_WIDTH,type:"range",args:[1,8,.5],inputTrigger:!0,description:"\u0428\u0438\u0440\u0438\u043d\u0430 \u043d\u0430\u043f\u0440\u0430\u0432\u043b\u044f\u044e\u0449\u0438\u0445 \u0441\u0438\u043c\u043c\u0435\u0442\u0440\u0438\u0438"},
symmetryRadialGuidesCount:{value:this.DEFAULT_SYMMETRY_RADIAL_GUIDES_COUNT,hidden:!0},symmetryMandalaGuidesCount:{value:this.DEFAULT_SYMMETRY_MANDALA_GUIDES_COUNT,hidden:!0},symmetryMode:{value:this.DEFAULT_SYMMETRY_MODE,hidden:!0}};static DEFAULT_BINDINGS={dropper:[["AltLeft"]],thickness:[["ControlLeft"]],opacity:[["ShiftLeft"]],brightness:[["KeyV"]],zoom:[["KeyZ"]],zoomToPoint:[["KeyS"]],zoomReset:[["KeyA"]],mirror:[["CapsLock"]],palette:[["Tab"]],swap:[["KeyX"]],eraser:[["KeyC"]],grayscale:[["KeyW"]],
hand:[["Space"]],clear:[["KeyF"]],symmetry:[["KeyT"]],brushTool:[["KeyB"]],eraserTool:[["KeyE"]],save:[["ControlLeft","KeyS"]],undo:[["ControlLeft","KeyZ"]],redo:[["ControlLeft","KeyY"],["ControlLeft","ShiftLeft","KeyZ"]],save:[["ControlLeft","KeyS"]]};static NATIVE_BINDINGS_KEYS=new Set(["KeyE","KeyB","KeyZ"]);static MODULE={title:"Painter",dependencies:["GPDrawInterface_","GPColorUtils_","GPColorPicker_"]};static INIT(a,b){new GPPainter_(a.gpproxy,a.timer,a.reference,a.ac,b)}constructor(a,b,c,d,
e){super();this.gpproxy=a;this.timer=b;this.reference=c;this.ac=d;this.l=e;this.tools={dropper:{handler:this.dropperKeyDown,description:"\u0418\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442 \u041f\u0438\u043f\u0435\u0442\u043a\u0430 (\u0443\u0441\u0442\u0430\u043d\u0430\u0432\u043b\u0438\u0432\u0430\u0435\u0442 \u0446\u0432\u0435\u0442 \u043f\u043e\u0434 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c \u043c\u044b\u0448\u0438)"},thickness:{handler:this.thicknessKeyDown,description:"\u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0435 \u0442\u043e\u043b\u0449\u0438\u043d\u044b \u043a\u0438\u0441\u0442\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
opacity:{handler:this.opacityKeyDown,description:"\u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0435 \u043d\u0430\u0441\u044b\u0449\u0435\u043d\u043d\u043e\u0441\u0442\u0438 \u043a\u0438\u0441\u0442\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},brightness:{handler:this.brightnessKeyDown,description:"\u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0435 \u044f\u0440\u043a\u043e\u0441\u0442\u0438 \u0446\u0432\u0435\u0442\u0430 \u043a\u0438\u0441\u0442\u0438 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
zoom:{handler:this.zoomKeyDown,description:"\u041f\u0440\u0438\u0431\u043b\u0438\u0436\u0435\u043d\u0438\u0435/\u043e\u0442\u0434\u0430\u043b\u0435\u043d\u0438\u0435 \u0445\u043e\u043b\u0441\u0442\u0430 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},zoomToPoint:{handler:this.zoomToPoint,description:"\u041f\u0440\u0438\u0431\u043b\u0438\u0436\u0435\u043d\u0438\u0435/\u043e\u0442\u0434\u0430\u043b\u0435\u043d\u0438\u0435 \u0445\u043e\u043b\u0441\u0442\u0430 \u0432 \u0442\u043e\u0447\u043a\u0443 \u043f\u043e\u0434 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},
zoomReset:{handler:this.resetZoom,description:"\u0421\u0431\u0440\u043e\u0441 \u0443\u0440\u043e\u0432\u043d\u044f \u043f\u0440\u0438\u0431\u043b\u0438\u0436\u0435\u043d\u0438\u044f/\u043e\u0442\u0434\u0430\u043b\u0435\u043d\u0438\u044f \u0445\u043e\u043b\u0441\u0442\u0430"},mirror:{handler:this.mirror,description:"\u0418\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442 \u0417\u0435\u0440\u043a\u0430\u043b\u043e (\u043e\u0442\u0440\u0430\u0436\u0430\u0435\u0442 \u0445\u043e\u043b\u0441\u0442 \u043f\u043e \u0433\u043e\u0440\u0438\u0437\u043e\u043d\u0442\u0430\u043b\u0438)"},
palette:{handler:this.palette,description:"\u041e\u0442\u043e\u0431\u0440\u0430\u0436\u0430\u0435\u0442 \u043f\u0430\u043b\u0438\u0442\u0440\u0443 \u043f\u043e\u0434 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u0435\u043c"},swap:{handler:this.swap,description:"\u041c\u0435\u043d\u044f\u0435\u0442 \u043e\u0441\u043d\u043e\u0432\u043d\u043e\u0439 \u0438 \u0434\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0439 \u0446\u0432\u0435\u0442\u0430 \u043c\u0435\u0441\u0442\u0430\u043c\u0438 (\u043f\u0435\u0440\u0435\u043a\u043b\u044e\u0447\u0430\u0435\u0442 \u043d\u0430 \u0434\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0439 \u0446\u0432\u0435\u0442)"},
eraser:{handler:this.eraser,description:"\u0418\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442 \u041b\u0430\u0441\u0442\u0438\u043a (\u043f\u0440\u0438 \u0437\u0430\u0436\u0430\u0442\u0438\u0438 \u043a\u043b\u0430\u0432\u0438\u0448\u0438 - \u0430\u043a\u0442\u0438\u0432\u0438\u0440\u0443\u0435\u0442\u0441\u044f, \u043f\u0440\u0438 \u043e\u0442\u043f\u0443\u0441\u043a\u0430\u043d\u0438\u0438 - \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u0442 \u043f\u0440\u0435\u0434\u044b\u0434\u0443\u0449\u0438\u0439 \u0438\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442)"},
grayscale:{handler:this.grayscale,description:"\u0412\u043a\u043b\u044e\u0447\u0430\u0435\u0442 \u0447\u0451\u0440\u043d\u043e-\u0431\u0435\u043b\u044b\u0439 \u0444\u0438\u043b\u044c\u0442\u0440"},hand:{handler:this.handKeyDown,description:"\u0418\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442 \u0420\u0443\u043a\u0430 (\u043f\u0440\u0438 \u0437\u0430\u0436\u0430\u0442\u0438\u0438 \u043a\u043b\u0430\u0432\u0438\u0448\u0438 \u043f\u043e\u0437\u0432\u043e\u043b\u044f\u0435\u0442 \u043f\u0435\u0440\u0435\u043c\u0435\u0449\u0430\u0442\u044c \u0445\u043e\u043b\u0441\u0442 \u041b\u0435\u0432\u043e\u0439 \u043a\u043d\u043e\u043f\u043a\u043e\u0439 \u043c\u044b\u0448\u0438 \u0438\u043b\u0438 \u0441\u0442\u0438\u043b\u0443\u0441\u043e\u043c)"},
clear:{handler:this.clear,description:"\u041e\u0447\u0438\u0441\u0442\u043a\u0430 \u0445\u043e\u043b\u0441\u0442\u0430 (\u043d\u0435 \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442 \u0432 \u0440\u0435\u0436\u0438\u043c\u0430\u0445 \u0410\u043d\u0438\u043c\u0430\u0446\u0438\u044f, \u0424\u043e\u043d \u0438 \u0421\u043e\u043b\u043e)"},symmetry:{handler:this.symmetry,description:"\u041d\u0430\u043f\u0440\u0430\u0432\u043b\u044f\u044e\u0449\u0438\u0435 \u0441\u0438\u043c\u043c\u0435\u0442\u0440\u0438\u0447\u043d\u043e\u0433\u043e \u0440\u0438\u0441\u043e\u0432\u0430\u043d\u0438\u044f"},
brushTool:{handler:this.brushTool,description:"\u0418\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442 \u041a\u0438\u0441\u0442\u044c"},eraserTool:{handler:this.eraserTool,description:"\u0418\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442 \u041b\u0430\u0441\u0442\u0438\u043a"},undo:{handler:this.undo,repeat:!0,description:"\u041e\u0442\u043c\u0435\u043d\u0430 \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0435\u0433\u043e \u0448\u0442\u0440\u0438\u0445\u0430"},redo:{handler:this.redo,repeat:!0,
description:"\u0412\u043e\u0437\u0432\u0440\u0430\u0442 \u043e\u0442\u043c\u0435\u043d\u0435\u043d\u043d\u043e\u0433\u043e \u0448\u0442\u0440\u0438\u0445\u0430"},save:{handler:this.save,description:"\u0418\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442 \u041b\u0430\u0441\u0442\u0438\u043a"}};this.settings=this.buildSettingsAPI(Object.assign({},this.parseUISettings(GPPainter_.UI_SETTINGS),JSON.parse(window.localStorage.getItem("gp_painter"))));this.bindings=Object.assign({},JSON.parse(JSON.stringify(GPPainter_.DEFAULT_BINDINGS)),
JSON.parse(window.localStorage.getItem("gp_painter_bindings")));this.s=this.settings;this.areKeysLocked=!1;this.iface=new GPDrawInterface_(this,this.gpproxy,this.l);this.density=GPPainter_.DEFAULT_DENSITY;this.width=GPPainter_.ORIGINAL_WIDTH*this.density;this.height=GPPainter_.ORIGINAL_HEIGHT*this.density;this.style=document.documentElement.style;this.style.setProperty("--gp-painter-heigth-width",`${GPPainter_.ORIGINAL_WIDTH}px`);this.style.setProperty("--gp-painter-heigth",`${GPPainter_.ORIGINAL_HEIGHT}px`);
this.style.setProperty("--gp-painter-background-color",`${GPPainter_.BACKGROUND_COLOR}`);this.color=this.settings.defaultColor;this.color2=GPPainter_.BACKGROUND_COLOR;this.thickness=Math.max(this.settings.minThickness,Math.min(this.settings.maxThickness,this.settings.defaultThickness));a=Math.max(this.settings.minOpacity,this.settings.defaultOpacity);this.opacity=1===a?a:String(a);this.tool=GPPainter_.DEFAULT_TOOL;this.isNote=!1;this.searchTimer=null;this.strokeId=GPPainter_.FIRST_STROKE_ID;this.strokeOptions=
[];this.strokeCoords=[];this.history=[];this.undos=[];this.lastDrawData=this.backgroundData=null;this.lastDelimiterIndex=-1;this.isSigned=!1;this.mStrokeId=null;this.mStrokeOrigin=this.getRandomInt(GPPainter_.M_STROKE_RANGE);this.isSubscribed=!1;this.pointerY=this.pointerX=0;this.isSymmetryGuidesMoved=this.isSymmetryGuidesEditable=this.isSymmetryEnabled=this.isDrawing=this.isZoomedToPoint=this.isHand=this.isEraser=this.isMirrored=this.isZooming=this.isBrightnessSetting=this.isThicknessSetting=this.isOpacitySetting=
this.isDropperDown=this.isDropper=!1;this.symmetryStrokesOptions=[];this.symmetryCoords=[];this.symmetryStrokesGroups={};this.symmetryGuideX=Math.round(GPPainter_.ORIGINAL_WIDTH/2);this.symmetryGuideY=Math.round(GPPainter_.ORIGINAL_HEIGHT/2);this.radiansPerSymmetryRadialGuide=2*Math.PI/this.s.symmetryRadialGuidesCount;this.radiansPerSymmetryMandalaGuide=2*Math.PI/this.s.symmetryMandalaGuidesCount;this.isDisabled=!1;this.pointerMoveHandler=null;this.localization=this.gpproxy.getLocalization("draw");
this.isReadyWarningShown=!1;this.lineSmoothingCounter=1;this.background;this.backgroundCtx;this.lastDraw;this.lastDrawCtx;this.canvas;this.canvasCtx;this.stroke;this.strokeCtx;this.pointer;this.pointerCtx;this.colorPicker;this.colorPickerWidth=GPPainter_.COLOR_PICKER_WIDTH;this.colorPickerHeight=GPPainter_.COLOR_PICKER_HEIGHT;this.colorPickerHuePos=GPPainter_.COLOR_PICKER_HUE_POSITION;this.globalCoordsHandler=this.globalCoordsHandler.bind(this);this.keyDownHandler=this.keyDownHandler.bind(this);this.keyUpHandler=
this.keyUpHandler.bind(this);this.inject=this.inject.bind(this);this.searchDrawContainer=this.searchDrawContainer.bind(this);this.getFillData=this.getFillData.bind(this);this.saveImage=this.saveImage.bind(this);this.clearPointer=this.clearPointer.bind(this);this.middleButtonDown=this.middleButtonDown.bind(this);this.rightButtonDown=this.rightButtonDown.bind(this);this.strokeDown=this.strokeDown.bind(this);this.strokeUp=this.strokeUp.bind(this);this.strokeMove=this.strokeMove.bind(this);this.strokeProcess=
this.strokeProcess.bind(this);this.drawPointer=this.drawPointer.bind(this);this.dropperKeyDown=this.dropperKeyDown.bind(this);this.dropperKeyUp=this.dropperKeyUp.bind(this);this.dropperMove=this.dropperMove.bind(this);this.dropperDown=this.dropperDown.bind(this);this.dropperUp=this.dropperUp.bind(this);this.resetKeys=this.resetKeys.bind(this);this.thicknessKeyDown=this.thicknessKeyDown.bind(this);this.thicknessKeyUp=this.thicknessKeyUp.bind(this);this.thicknessDown=this.thicknessDown.bind(this);this.opacityKeyDown=
this.opacityKeyDown.bind(this);this.opacityKeyUp=this.opacityKeyUp.bind(this);this.opacityDown=this.opacityDown.bind(this);this.brightnessKeyDown=this.brightnessKeyDown.bind(this);this.brightnessKeyUp=this.brightnessKeyUp.bind(this);this.brightnessDown=this.brightnessDown.bind(this);this.zoomKeyDown=this.zoomKeyDown.bind(this);this.zoomKeyUp=this.zoomKeyUp.bind(this);this.zoomDown=this.zoomDown.bind(this);this.mouseZoom=this.mouseZoom.bind(this);this.handKeyDown=this.handKeyDown.bind(this);this.handKeyUp=
this.handKeyUp.bind(this);this.handDown=this.handDown.bind(this);this.symmetryGuidesDownHandler=this.symmetryGuidesDownHandler.bind(this);this.changeSymmetryRadialGuidesCount=this.changeSymmetryRadialGuidesCount.bind(this);this.changeSymmetryMandalaGuidesCount=this.changeSymmetryMandalaGuidesCount.bind(this);this.blockContextMenu=this.blockContextMenu.bind(this);this.resizeWindowHandler=this.resizeWindowHandler.bind(this);this.keysMap=this.buildKeysMap(this.bindings);this.pressedKeys=new Set;this.currentBinding=
null;this.addEventListener("stroke",({detail:{data:f,symmetryStrokesData:h=[]}})=>{this.drawFunction(this.canvasCtx,[f,...h]);this.strokeOptions=[];this.strokeCoords=[];this.symmetryCoords=[];h.length&&(this.symmetryStrokesGroups[f[1]]=f[1],h.map(k=>{this.symmetryStrokesGroups[k[1]]=f[1]}));this.clearStroke();this.history.push(f,...h);this.undos.length&&(this.undos=[]);this.shouldBeSigned()&&this.sign()});this.addEventListener("stroke_started",({detail:{data:f,symmetryStrokesData:h=[]}})=>{const k=
!!h.length,l=f[0];this.gpproxy.getSendQueueSize()&&this.isToolInTime(l)||(this.gpproxy.tool(1,f,k),h.forEach(m=>{this.gpproxy.tool(1,m,k)}))});this.addEventListener("stroke_process",({detail:{data:f,symmetryStrokesData:h=[]}})=>{const k=!!h.length;this.gpproxy.tool(3,f,k);h.forEach(l=>{this.gpproxy.tool(3,l,k)})});this.addEventListener("stroke_ended",({detail:{data:f,symmetryStrokesData:h=[]}})=>{const k=!!h.length,l=k||this.gpproxy.getSendQueueSize()&&this.isToolInTime(f[0])?1:3;this.gpproxy.tool(l,
f,k);h.forEach(m=>{this.gpproxy.tool(l,m,k)})});this.addEventListener("stroke_undo",({detail:{data:f,symmetryStrokesData:h=[]}})=>{const k=!!h.length;this.gpproxy.undo(f[1],k);h.forEach(l=>{this.gpproxy.undo(l[1],k)})});this.addEventListener("stroke_redo",({detail:{data:f,symmetryStrokesData:h=[]}})=>{const k=!!h.length;this.gpproxy.redo(f,k);h.forEach(l=>{this.gpproxy.redo(l,k)})});this.addEventListener("settings_updated",({detail:{settings:f}})=>{this.updateSettings(f);this.saveSettings()});this.gpproxy.addEventListener("localization",
({detail:{data:f,type:h}})=>{"draw"===h&&(this.localization=f)});this.gpproxy.addEventListener("turn_started",()=>{this.terminate();this.resetTurnSettings();this.setTimer()});this.gpproxy.addEventListener("turns_ended",f=>{this.terminate();this.stopTimer()});this.gpproxy.addEventListener("send_queue_updated",({detail:{size:f}})=>{this.iface.updateActionQueueSize(f)});this.iface.addEventListener("settings_updated",({detail:{settings:f}})=>{this.settings=Object.assign(this.settings,f);this.updateSettings(f);
this.saveSettings()});this.iface.addEventListener("bindings_updated",({detail:{bindings:f}})=>{this.updateBindings(f);this.saveBindings()});document.addEventListener("_url_changed",({detail:{path:f}})=>{"/draw"===f&&(this.enabled=this.isPermittedMode(),this.terminate(),this.inject())});document.addEventListener("_keys_lock",({detail:{state:f}})=>{this.setKeysLockState(f)});document.addEventListener("_subs_status",({detail:{status:f}})=>{this.isSubscribed=f});const g=this;Element.prototype.addEventListener=
new Proxy(Element.prototype.addEventListener,{apply(f,h,k){if(!(h.classList?.contains("drawingContainer")&&["mousedown","pointerdown","contextmenu","touchstart"].includes(k[0])&&g.isPermittedMode()))return f.apply(h,k)}});this.timer&&this.timer.addEventListener("finish",f=>{this.timer.settings.readyAfterTimeExpires&&this.gpproxy.isGameTime(GPProxy_.GAME_TIME.HOSTS_DECISION)&&this.gpproxy.isOwner()&&this.iface.readyBtn.click()});this.reference&&this.reference.addEventListener("state_changed",({detail:{isEnabled:f}})=>
{f&&this.resizeWindowHandler()})}buildKeysMap(a){const b={};for(let c in a)this.tools[c]&&a[c].forEach(d=>{const e=d.length;b[e]=b[e]||[];b[e].push({name:c,keys:d,...this.tools[c]})});return b}bindingHandler(a,b){const c=this.getBinding();c?(a.preventDefault(),a.stopPropagation(),a.repeat&&a.repeat!==!!c.repeat||!a.repeat&&c.name===this.currentBinding?.name||(c.handler.apply(this,[a]),this.currentBinding=c)):!b&&this.isNativeBinding(a.code)&&a.stopPropagation()}isNativeBinding(a){return GPPainter_.NATIVE_BINDINGS_KEYS.has(a)}getBinding(){var a=
this.pressedKeys.size;if(this.currentBinding){if(!a)return this.currentBinding=null;if(!this.keysMap[a])return this.currentBinding.keys.length>a&&(this.currentBinding=null),null}if(a=(this.keysMap[a]||[]).find(({keys:b})=>{const c=this.pressedKeys.values();return b.every(d=>d===c.next().value)}))return a;this.checkForMatchBinding()||(this.currentBinding=null);return null}checkForMatchBinding(){if(this.currentBinding){var a=this.pressedKeys.values();return this.currentBinding.keys.every(b=>b===a.next().value)}}keyDownHandler(a){this.isDisabled||
this.areKeysLocked||(this.pressedKeys.add(a.code),this.bindingHandler(a))}keyUpHandler(a){this.isDisabled||this.areKeysLocked||(this.pressedKeys.delete(a.code),this.bindingHandler(a,!0))}render(){this.container=document.createElement("div");this.container.className="gp-painter_";this.container.addEventListener("pointerdown",this.suppressEvents);this.container.addEventListener("pointermove",this.suppressEvents);this.container.addEventListener("mousedown",this.suppressEvents);this.container.addEventListener("mousemove",
this.suppressEvents);this.container.addEventListener("mouseup",this.suppressEvents);this.container.addEventListener("mousecancel",this.suppressEvents);this.container.addEventListener("touchstart",this.suppressEvents,!0);this.container.addEventListener("touchend",this.suppressEvents,!0);this.container.addEventListener("touchcancel",this.suppressEvents,!0);this.drawingArea=document.createElement("div");this.drawingArea.className="drawing-area";this.container.appendChild(this.drawingArea);this.background=
document.createElement("canvas");this.background.className="background_";this.background.classList.add("hidden");this.background.width=this.width;this.background.height=this.height;this.backgroundCtx=this.background.getContext("2d");this.backgroundCtx.fillStyle=GPPainter_.BACKGROUND_COLOR;this.backgroundCtx.fillRect(0,0,this.width,this.height);this.drawingArea.appendChild(this.background);this.lastDraw=document.createElement("canvas");this.lastDraw.className="last-draw_";this.lastDraw.classList.add("hidden");
this.lastDraw.width=this.width;this.lastDraw.height=this.height;this.lastDrawCtx=this.lastDraw.getContext("2d");this.drawingArea.appendChild(this.lastDraw);this.canvas=document.createElement("canvas");this.canvas.className="canvas_";this.canvas.width=this.width;this.canvas.height=this.height;this.canvasCtx=this.canvas.getContext("2d");this.drawingArea.appendChild(this.canvas);this.stroke=document.createElement("canvas");this.stroke.className="stroke_";this.stroke.width=this.width;this.stroke.height=
this.height;this.stroke.addEventListener("contextmenu",this.blockContextMenu);this.stroke.addEventListener("pointermove",this.drawPointer);this.stroke.addEventListener("pointerdown",this.middleButtonDown);this.stroke.addEventListener("pointerdown",this.rightButtonDown);this.stroke.addEventListener("pointerdown",this.strokeDown);this.stroke.addEventListener("pointerdown",this.dropperDown);this.stroke.addEventListener("pointerdown",this.thicknessDown);this.stroke.addEventListener("pointerdown",this.opacityDown);
this.stroke.addEventListener("pointerdown",this.brightnessDown);this.stroke.addEventListener("pointerdown",this.zoomDown);this.stroke.addEventListener("pointerdown",this.handDown);this.stroke.addEventListener("pointerout",this.clearPointer);this.stroke.addEventListener("wheel",this.mouseZoom);this.drawingArea.appendChild(this.stroke);this.strokeCtx=this.stroke.getContext("2d");this.strokeCtx.lineJoin="round";this.strokeCtx.lineCap="round";this.strokeCtx.strokeStyle=this.settings.defaultColor;this.strokeCtx.lineWidth=
this.settings.defaultThickness;this.strokeCtx.globalAlpha=this.settings.defaultOpacity;this.pointer=document.createElement("canvas");this.pointer.className="pointer_";this.pointer.width=this.width;this.pointer.height=this.height;this.drawingArea.appendChild(this.pointer);this.pointerCtx=this.pointer.getContext("2d");this.pointerCtx.lineWidth=this.density;this.symmetryGuides=document.createElement("canvas");this.symmetryGuides.className="symmetry-guides_";this.symmetryGuides.width=this.width;this.symmetryGuides.height=
this.height;this.symmetryGuidesCtx=this.symmetryGuides.getContext("2d");this.symmetryGuidesCtx.strokeStyle=this.s.symmetryGuidesColor;this.symmetryGuidesCtx.globalAlpha=this.s.symmetryGuidesOpacity;this.symmetryGuidesCtx.lineWidth=this.s.symmetryGuidesWidth*this.density;this.symmetryGuides.addEventListener("contextmenu",this.blockContextMenu);this.symmetryGuides.addEventListener("pointerdown",this.symmetryGuidesDownHandler);this.drawSymmetryGuides();this.drawingArea.appendChild(this.symmetryGuides);
this.zoomer=window.renderer({minScale:this.settings.minZoom,maxScale:this.settings.maxZoom,element:this.drawingArea,defaultScaleSensitivity:this.settings.zoomSensitivity});this.initColorPicker({width:this.settings.colorPickerWidth,height:this.settings.colorPickerHeight,huePos:this.settings.colorPickerHuePosition})}terminate(){this.container&&(clearTimeout(this.strokeTimer),clearTimeout(this.searchTimer),window.removeEventListener("blur",this.resetKeys),window.removeEventListener("focus",this.resetKeys),
window.removeEventListener("resize",this.resizeWindowHandler),document.removeEventListener("pointermove",this.globalCoordsHandler,!0),document.removeEventListener("keydown",this.keyDownHandler,!0),document.removeEventListener("keyup",this.keyUpHandler,!0),document.removeEventListener("contextmenu",this.blockContextMenu),this.stroke.removeEventListener("pointermove",this.strokeMove),this.stroke.removeEventListener("pointerup",this.strokeUp,{once:!0}),this.stroke.removeEventListener("pointermove",this.thicknessMoveHandler),
this.stroke.removeEventListener("pointermove",this.opacityMoveHandler),this.stroke.removeEventListener("pointermove",this.brightnessMoveHandler),this.stroke.removeEventListener("pointermove",this.zoomMoveHandler),this.stroke.removeEventListener("pointermove",this.handMoveHandler),this.clearPointer(),this.clearStroke(),this.clearCanvas(),this.clearBackground(),this.resetZoom(),this.resetMirror(),this.container.classList.remove("grayscale_"),this.background.classList.add("hidden"),this.lastDraw.classList.add("hidden"),
this.symmetryGuides.classList.remove("editable_"),this.colorPicker.hide(),this.iface.terminate(),this.reference?.terminate(),this.container.remove())}resetTurnSettings(){if(this.container){this.color=this.settings.defaultColor;this.color2=GPPainter_.BACKGROUND_COLOR;this.thickness=Math.max(this.settings.minThickness,Math.min(this.settings.maxThickness,this.settings.defaultThickness));var a=Math.max(this.settings.minOpacity,this.settings.defaultOpacity);this.opacity=1===a?a:String(a);this.tool=GPPainter_.DEFAULT_TOOL;
this.isSymmetryEnabled=!1;this.symmetryStrokesGroups={};this.symmetryGuides.classList.remove("shown_");this.isSigned=!1;this.mStrokeOrigin=this.getRandomInt(GPPainter_.M_STROKE_RANGE)}}init(){const a=this.gpproxy.getState(),b=this.gpproxy.getCurrentTurnId();this.searchTimer=null;this.strokeOptions=[];this.strokeCoords=[];this.history=a.draw||[];this.backgroundData=this.ac?.isSuspicious(`tbg_${b}`)?[]:a.background;this.lastDrawData=this.ac?.isSuspicious(`t_${b}`)?[]:a.lastDraw;this.lastDelimiterIndex=
this.history.findLastIndex(c=>11===c[0]);this.strokeId=this.calculateStrokeID();this.undos=[];this.pointerY=this.pointerX=0;this.isDrawing=this.isZoomedToPoint=this.isHand=this.isEraser=this.isMirrored=this.isZooming=this.isBrightnessSetting=this.isThicknessSetting=this.isOpacitySetting=this.isDropperDown=this.isDropper=this.areKeysLocked=!1;this.currentBinding=null;this.pressedKeys.clear();this.isSymmetryGuidesMoved=this.isSymmetryGuidesEditable=this.isReadyWarningShown=this.isNote=this.isDisabled=
!1;this.symmetryStrokesOptions=[];this.symmetryCoords=[];!this.isSubscribed&&!this.gpproxy.isSoloGame()&&1<this.s.symmetryMode&&(this.s.symmetryMode=GPPainter_.DEFAULT_SYMMETRY_MODE,this.drawSymmetryGuides());document.addEventListener("pointermove",this.globalCoordsHandler,!0);document.addEventListener("keydown",this.keyDownHandler,!0);document.addEventListener("keyup",this.keyUpHandler,!0);window.addEventListener("blur",this.resetKeys);window.addEventListener("focus",this.resetKeys);window.addEventListener("resize",
this.resizeWindowHandler);this.redrawBackground();this.redrawLastDraw();this.redrawCanvas();this.background.classList.toggle("hidden",!this.backgroundData);this.lastDraw.classList.toggle("hidden",!this.lastDrawData);this.zoomer.setContainerScale(this.getContainerScale());this.iface.init();this.reference?.init();this.gpproxy.isReady()&&this.iface.disableInterface()}inject(){this.enabled&&(this.container||this.render(),this.searchDrawContainer().then(a=>{a.appendChild(this.container);this.init()}))}searchDrawContainer(){return new Promise(a=>
{this.searchTimer=setTimeout(()=>{const b=document.querySelector(".drawingContainer");b?(clearTimeout(this.searchTimer),a(b)):this.searchDrawContainer()},GPPainter_.SEARCH_DRAW_CONTAINER_INTERVAL)})}isPermittedMode(){const {configs:a}=this.gpproxy.getState();for(let b in GPPainter_.DISABLED_MODE_OPTIONS)if(GPPainter_.DISABLED_MODE_OPTIONS[b].some(c=>c===a[b]))return!1;return!0}initColorPicker({width:a,height:b,huePos:c}={}){this.colorPickerWidth=a??this.colorPickerWidth;this.colorPickerHeight=b??
this.colorPickerHeight;this.colorPickerHuePos=c??this.colorPickerHuePos;this.colorPicker?.getElement()&&this.colorPicker.getElement().remove();this.colorPicker=new GPColorPicker_(this.colorPickerWidth,this.colorPickerHeight,this.colorPickerHuePos);this.colorPicker.setColor(this.color);this.colorPicker.hide();this.colorPicker.addEventListener("color",({detail:{color:d}})=>{this.color=d;this.iface.updateColorInput(d);this.iface.updateColorPicker(d);this.iface.resetPaletteColor()});document.body.appendChild(this.colorPicker.getElement())}calculateStrokeID(){const a=
[...this.history,...this.undos].reduceRight((b,c)=>c[1]>b?c[1]:b,GPPainter_.FIRST_STROKE_ID-1);return Math.max(a+1,GPPainter_.FIRST_STROKE_ID)}middleButtonDown(a){1!==a.button||this.isThicknessSetting||this.isOpacitySetting||this.isBrightnessSetting||this.isZooming||this.isHand||(this.handDown(a,!0),a.stopPropagation(),a.stopImmediatePropagation())}rightButtonDown(a){if(2===a.button){if(this.isThicknessSetting)this.stroke.removeEventListener("pointermove",this.thicknessMoveHandler),this.thickness=
this.settings.defaultThickness,this.iface.updateThickness(this.thickness),this.renderPointer(...this.getCoords(a),void 0,void 0,!0);else if(this.isOpacitySetting)this.stroke.removeEventListener("pointermove",this.opacityMoveHandler),this.setOpacity(this.settings.defaultOpacity),this.renderPointer(...this.getCoords(a),this.opacity,void 0,!0);else if(this.isBrightnessSetting){this.stroke.removeEventListener("pointermove",this.zoomMoveHandler);this.brightness=1;const [b,c]=GPColorUtils_.hexToHsv(this.color),
d=GPColorUtils_.hsvToHex(b,c,this.brightness);this.setColor(d);this.renderPointer(...this.getCoords(a),this.opacity,void 0,!0)}else this.isZooming?(this.stroke.removeEventListener("pointermove",this.zoomMoveHandler),this.resetZoom()):this.isHand?this.resetZoom():this.strokeDown(a,this.color2);document.addEventListener("contextmenu",this.blockContextMenu,{once:!0});a.stopPropagation();a.stopImmediatePropagation()}}strokeDown(a,b){if(!(this.isDropper||this.isDropperDown||this.isOpacitySetting||this.isThicknessSetting||
this.isBrightnessSetting||this.isZooming||this.isHand)){var c=this.getOCoords(a);this.strokeOptions=this.getStrokeOptions(this.tool,b);this.strokeCoords=[c];this.isSymmetryEnabled&&this.convertToSymmetryCoords(c).forEach((d,e)=>{const g=this.strokeOptions.slice();g[1]=this.strokeId++;this.symmetryStrokesOptions[e]=g;this.symmetryCoords[e]=[d]});this.lineSmoothingCounter=1;this.tool===GPPainter_.TOOL.FILL?(this.updateStrokeCoords(this.strokeCoords,this.getCoords(a)),a=this.buildStrokeData(this.strokeOptions,
this.strokeCoords),this.dispatchEvent(new CustomEvent("stroke_started",{detail:{data:a}})),this.dispatchEvent(new CustomEvent("stroke",{detail:{data:a}}))):(this.stroke.setPointerCapture(a.pointerId),this.stroke.addEventListener("pointermove",this.strokeMove),this.stroke.addEventListener("pointerup",this.strokeUp,{once:!0}),a=[...this.strokeOptions,...this.strokeCoords],b=this.buildSymmetryStrokesData(!0),this.drawFunction(this.strokeCtx,[a,...b],this.density,!1),clearTimeout(this.strokeTimer),!this.isSymmetryEnabled&&
this.isToolInTime(this.tool)&&(this.strokeTimer=setTimeout(this.strokeProcess,1E3),this.dispatchEvent(new CustomEvent("stroke_started",{detail:{data:a,symmetryStrokesData:b}}))),this.isDrawing=!0)}}buildSymmetryStrokesData(a=!1){const b=[];this.isSymmetryEnabled&&this.symmetryCoords.forEach((c,d)=>{b.push(this.buildStrokeData(this.symmetryStrokesOptions[d],c,a))});return b}rotatePoint(a,b,c,d,e){var g=Math.PI/180*e;e=Math.cos(g);g=Math.sin(g);return[e*(c-a)+g*(d-b)+a,e*(d-b)-g*(c-a)+b]}convertToSymmetryCoords([a,
b],c=this.s.symmetryMode){const d=this.isMirrored?GPPainter_.ORIGINAL_WIDTH-this.symmetryGuideX:this.symmetryGuideX,e=this.symmetryGuideY,g=[];switch(c){case GPPainter_.SYMMETRY_MODES.VERTICAL:g.push([d+(d-a),b]);break;case GPPainter_.SYMMETRY_MODES.HORIZONTAL:g.push([a,e+(e-b)]);break;case GPPainter_.SYMMETRY_MODES.QUADRANT:g.push([d+(d-a),b]);g.push([a,e+(e-b)]);g.push([d+(d-a),e+(e-b)]);break;case GPPainter_.SYMMETRY_MODES.RADIAL:c=this.s.symmetryRadialGuidesCount;var f=360/c;for(var h=1;h<c;h++){const [l,
m]=this.rotatePoint(d,e,a,b,h*f);g.push([Math.round(l),Math.round(m)])}break;case GPPainter_.SYMMETRY_MODES.MANDALA:c=e+(e-b);f=2*this.s.symmetryMandalaGuidesCount;h=360/f;const k=this.s.symmetryMandalaGuidesCount%2?2*h:3*h;for(let l=1;l<f;l++){let m,n;l%2?(m=l*h+k,n=c):(m=l*h,n=b);const [p,r]=this.rotatePoint(d,e,a,n,m);g.push([Math.round(p),Math.round(r)])}}return g}strokeMove(a){a=this.getOCoords(a);this.updateStrokeCoords(this.strokeCoords,a);this.isSymmetryEnabled&&(a=this.convertToSymmetryCoords(a),
this.updateSymmetryStrokeCoords(a));a=this.buildSymmetryStrokesData(!0);this.clearStroke();this.drawFunction(this.strokeCtx,[[...this.strokeOptions,...this.strokeCoords],...a],this.density,!1);this.lineSmoothingCounter++}strokeUp(a){clearTimeout(this.strokeTimer);this.s.lineSmoothingLevel&&this.lineSmoothingCounter%(this.s.lineSmoothingLevel+1)&&this.strokeCoords.push(this.getOCoords(a));a=this.buildStrokeData(this.strokeOptions,this.strokeCoords);const b=this.buildSymmetryStrokesData(),c=this.isToolInTime(this.tool)?
"stroke_ended":"stroke_started";this.dispatchEvent(new CustomEvent(c,{detail:{data:a,symmetryStrokesData:b}}));this.dispatchEvent(new CustomEvent("stroke",{detail:{data:a,symmetryStrokesData:b}}));this.isDrawing=!1;this.stroke.removeEventListener("pointermove",this.strokeMove)}strokeProcess(){let a;this.isSymmetryEnabled&&(a=[],this.symmetryCoords.forEach((b,c)=>{a.push(this.buildStrokeData(this.symmetryStrokesOptions[c],b))}));this.dispatchEvent(new CustomEvent("stroke_process",{detail:{data:[...this.strokeOptions,
...this.strokeCoords],symmetryStrokesData:a}}));!this.isSymmetryEnabled&&this.isToolInTime(this.tool)&&(clearTimeout(this.strokeTimer),this.strokeTimer=setTimeout(this.strokeProcess,1E3))}updateSymmetryStrokeCoords(a){a.forEach((b,c)=>{this.updateStrokeCoords(this.symmetryCoords[c],b)})}updateStrokeCoords(a,b){switch(this.tool){case GPPainter_.TOOL.BRUSH:case GPPainter_.TOOL.ERASER:case GPPainter_.TOOL.NOTE:this.s.lineSmoothingLevel&&(this.tool!==GPPainter_.TOOL.ERASER||this.s.eraserLineSmoothing)&&
this.lineSmoothingCounter%(this.s.lineSmoothingLevel+1)||a.push(b);break;case GPPainter_.TOOL.LINE:case GPPainter_.TOOL.RECTANGLE:case GPPainter_.TOOL.CIRCLE:case GPPainter_.TOOL.RECTANGLE_FILLED:case GPPainter_.TOOL.CIRCLE_FILLED:b=[a[0],b];a.splice(0,a.length);a.push(...b);break;case GPPainter_.TOOL.FILL:a.splice(0,a.length),a.push(...this.getFillData(b[0],b[1]))}}getStrokeOptions(a=this.tool,b=this.color,c=this.thickness){switch(a){case GPPainter_.TOOL.BRUSH:case GPPainter_.TOOL.LINE:case GPPainter_.TOOL.RECTANGLE:case GPPainter_.TOOL.CIRCLE:case GPPainter_.TOOL.RECTANGLE_FILLED:case GPPainter_.TOOL.CIRCLE_FILLED:return[a,
this.strokeId++,[b,c,this.opacity]];case GPPainter_.TOOL.ERASER:return[a,this.strokeId++,this.s.doubleEraserThickness?2*c:c];case GPPainter_.TOOL.FILL:return[a,this.strokeId++,[b,this.opacity]];case GPPainter_.TOOL.NOTE:return[a,this.strokeId++,null]}}buildStrokeData(a,b,c=!1){return[...a,...(!c&&this.isMirrored&&a[0]!==GPPainter_.TOOL.FILL?this.mirrorStrokeCoords(b):b)]}drawPointer(a,b,c){const [d,e]=this.getCoords(a);this.pointerX=d;this.pointerY=e;this.renderPointer(d,e,b,c)}renderPointer(a,b,
c,d=this.thickness,e){this.clearPointer();c=this.isOpacitySetting?this.opacity:c;d=this.isZooming?1:!e&&GPPainter_.TOOLS_THICKNESSES[this.tool]||d;this.tool===GPPainter_.TOOL.ERASER&&this.s.doubleEraserThickness&&(d*=2);e=this.pointerCtx;e.beginPath();e.arc(a,b,d/2*this.density,0,2*Math.PI);c&&(e.fillStyle=`rgba(${this.hexToRgb(this.color).join(",")},${c}`,e.fill());e.strokeStyle=GPPainter_.POINTER_COLOR;e.stroke();e.beginPath();e.arc(a,b,(d/2+1)*this.density,0,2*Math.PI);e.strokeStyle=GPPainter_.POINTER_OUTLINE_COLOR;
e.globalAlpha=this.settings.pointerOutlineOpacity;e.stroke();e.globalAlpha=this.settings.pointerOpacity;d<GPPainter_.POINTER_CROSSHAIR_MIN_THICKNESS&&(c=3*d*this.density,d=GPPainter_.POINTER_CROSSHAIR_LINE_LENGTH*this.density,e.strokeStyle=GPPainter_.POINTER_OUTLINE_COLOR,e.globalAlpha=this.settings.pointerOutlineOpacity,e.beginPath(),e.moveTo(a,b-c),e.lineTo(a,b-c-d),e.moveTo(a+c,b),e.lineTo(a+c+d,b),e.moveTo(a,b+c),e.lineTo(a,b+c+d),e.moveTo(a-c,b),e.lineTo(a-c-d,b),e.stroke(),e.globalAlpha=this.settings.pointerOpacity)}updatePointer(){this.renderPointer(this.pointerX,
this.pointerY)}setTool(a){this.tool=a;a=a===GPPainter_.TOOL.NOTE;const b=a!==this.isNote;this.isNote=a;b&&(this.redrawBackground(),this.redrawLastDraw(),this.redrawCanvas())}setColor(a,b=!1){this.color=a;this.colorPicker.setColor(a);this.iface.updateColorInput(a);this.iface.updateColorPicker(a,b);this.iface.resetPaletteColor()}setColor2(a){this.color2=a;this.iface.updateColor2Input(a)}getColor(){return this.color}setOpacity(a){this.opacity=String(a);this.iface.updateOpacity(a)}setThickness(a){this.thickness=
a}toggleLastDraw(a){this.lastDraw.classList.toggle("hidden",!a)}clearBackground(){this.backgroundCtx.fillStyle=GPPainter_.BACKGROUND_COLOR;this.backgroundCtx.fillRect(0,0,this.background.width,this.background.height)}clearLastDraw(){this.lastDrawCtx.clearRect(0,0,this.lastDraw.width,this.lastDraw.height)}clearCanvas(){this.canvasCtx.clearRect(0,0,this.canvas.width,this.canvas.height)}clearStroke(){this.strokeCtx.clearRect(0,0,this.stroke.width,this.stroke.height)}clearPointer(){this.pointerCtx.clearRect(0,
0,this.pointer.width,this.pointer.height)}redrawBackground(){this.clearBackground();this.backgroundData?.length&&this.drawFunction(this.backgroundCtx,this.backgroundData,this.density,!1,this.isNote)}redrawLastDraw(){this.clearLastDraw();this.lastDrawData?.length&&this.drawFunction(this.lastDrawCtx,this.lastDrawData,this.density,!0,this.isNote)}redrawCanvas(){this.clearCanvas();this.history.length&&this.drawFunction(this.canvasCtx,this.history,this.density,!0,this.isNote)}getCoords(a){const b=a.target.getBoundingClientRect(),
[c,d]=a.touches?[a.touches[0].clientX,a.touches[0].clientY]:[a.clientX,a.clientY],[e,g]=[c-b.left,d-b.top];return[Math.round(a.target.width/b.width*e),Math.round(a.target.height/b.height*g)]}getOCoords(a){const [b,c]=this.getCoords(a);return[Math.round(b/this.density),Math.round(c/this.density)]}globalCoordsHandler(a){this.cX=a.clientX;this.cY=a.clientY}resetKeys(a){this.container&&(this.drawingArea.classList.remove("dropper_"),this.drawingArea.classList.remove("dropper-s_"),this.drawingArea.classList.remove("hand_"),
this.drawingArea.classList.remove("hand-s_"),this.isHand=this.isEraser=this.isZooming=this.isBrightnessSetting=this.isThicknessSetting=this.isOpacitySetting=this.isDropperDown=this.isDropper=!1,this.stroke.removeEventListener("pointermove",this.thicknessMoveHandler),this.stroke.removeEventListener("pointermove",this.opacityMoveHandler),this.stroke.removeEventListener("pointermove",this.brightnessMoveHandler),this.stroke.removeEventListener("pointermove",this.zoomMoveHandler),this.stroke.removeEventListener("pointermove",
this.handMoveHandler),this.currentBinding=null,a&&(this.pressedKeys.clear(),this.bindingHandler(a)))}dropperKeyDown(a){a.preventDefault();this.isDropper=!0;this.drawingArea.classList.add("dropper_");document.addEventListener("keyup",this.dropperKeyUp,{once:!0})}dropperKeyUp(a){this.isDropper&&(a.preventDefault(),this.isDropper=!1,this.drawingArea.classList.remove("dropper_"),this.isDropperDown||this.stroke.removeEventListener("pointermove",this.dropperMove))}dropperDown(a){this.isDropper&&(this.isDropperDown=
!0,this.dropperMove(a),this.drawingArea.classList.add("dropper-s_"),this.stroke.setPointerCapture(a.pointerId),this.stroke.addEventListener("pointermove",this.dropperMove),this.stroke.addEventListener("pointerup",this.dropperUp,{once:!0}))}dropperMove(a){if(this.isDropper||this.isDropperDown){var [b,c]=this.getCoords(a);b=this.isMirrored?this.width-b:b;a=this.getPixelColor(b,c);this.setColor(a)}}dropperUp(a){let [b,c]=this.getCoords(a);b=this.isMirrored?this.width-b:b;a=this.getPixelColor(b,c);this.setColor(a);
this.isDropperDown=!1;this.drawingArea.classList.remove("dropper-s_");this.stroke.removeEventListener("pointermove",this.dropperMove)}getPixelColor(a,b){var c=document.createElement("canvas");c.width=1;c.height=1;c=c.getContext("2d");c.fillStyle=GPPainter_.BACKGROUND_COLOR;c.fillRect(0,0,1,1);this.backgroundData?.length&&c.drawImage(this.background,a,b,1,1,0,0,1,1);this.lastDrawData?.length&&c.drawImage(this.lastDraw,a,b,1,1,0,0,1,1);c.drawImage(this.canvas,a,b,1,1,0,0,1,1);const [d,e,g,f]=c.getImageData(0,
0,1,1).data;return f?`${this.rgbToHex(d,e,g)}`:GPPainter_.BACKGROUND_COLOR}thicknessKeyDown(a){this.isThicknessSetting=!0;this.renderPointer(this.pointerX,this.pointerY,void 0,void 0,!0);document.addEventListener("keyup",this.thicknessKeyUp,{once:!0})}thicknessKeyUp(a){this.isThicknessSetting&&(this.isThicknessSetting=!1)}thicknessDown(a){if(this.isThicknessSetting&&0===a.button){var [b,c]=this.getCoords(a);this.thicknessMoveHandler=this.thicknessMove(b,c,b,c);this.stroke.setPointerCapture(a.pointerId);
this.stroke.addEventListener("pointermove",this.thicknessMoveHandler);this.stroke.addEventListener("pointerup",d=>{this.stroke.removeEventListener("pointermove",this.thicknessMoveHandler);this.dispatchEvent(new CustomEvent("thickness",{detail:{thickness:this.thickness}}))},{once:!0});this.thicknessMoveHandler(a)}}thicknessMove(a,b,c,d){return e=>{const [g,f]=this.getCoords(e);e=Math.round(Math.max(Math.min(this.thickness+("horizontal"===this.settings.thicknessAxis?g-c:f-d)*("down / right"===this.settings.upThicknessDirection?
1:-1),this.settings.maxThickness),this.settings.minThickness));c=g;d=f;e&&(this.thickness=e,this.iface.updateThickness(e),this.renderPointer(a,b,void 0,void 0,!0))}}opacityKeyDown(a){this.isOpacitySetting=!0;this.renderPointer(this.pointerX,this.pointerY,this.opacity,void 0,!0);document.addEventListener("keyup",this.opacityKeyUp,{once:!0})}opacityKeyUp(a){this.isOpacitySetting&&(this.isOpacitySetting=!1)}opacityDown(a){if(this.isOpacitySetting&&0===a.button){var [b,c]=this.getCoords(a);this.opacityMoveHandler=
this.opacityMove(b,c,b,c);this.stroke.setPointerCapture(a.pointerId);this.stroke.addEventListener("pointermove",this.opacityMoveHandler);this.stroke.addEventListener("pointerup",d=>{this.stroke.removeEventListener("pointermove",this.opacityMoveHandler);this.drawPointer(d,null)},{once:!0});this.opacityMoveHandler(a)}}opacityMove(a,b,c,d){return e=>{const [g,f]=this.getCoords(e);e=Math.max(this.settings.minOpacity,Math.min(Math.round(100*(Number(this.opacity)+-Math.sign(("horizontal"===this.settings.opacityAxis?
g-c:f-d)*("up / left"===this.settings.upOpacityDirection?1:-1))*this.settings.opacityStep))/100,1));c=g;d=f;this.setOpacity(e);this.renderPointer(a,b,e,void 0,!0)}}brightnessKeyDown(a){this.isBrightnessSetting=!0;this.renderPointer(this.pointerX,this.pointerY,this.opacity,void 0,!0);document.addEventListener("keyup",this.brightnessKeyUp,{once:!0})}brightnessKeyUp(a){this.isBrightnessSetting&&(this.isBrightnessSetting=!1)}brightnessDown(a){if(this.isBrightnessSetting&&0===a.button){var [b,c,d]=GPColorUtils_.hexToHsv(this.color);
this.brightness=d;var [e,g]=this.getCoords(a);this.brightnessMoveHandler=this.brightnessMove(e,g,e,g,b,c);this.stroke.setPointerCapture(a.pointerId);this.stroke.addEventListener("pointermove",this.brightnessMoveHandler);this.stroke.addEventListener("pointerup",f=>{this.stroke.removeEventListener("pointermove",this.brightnessMoveHandler);this.drawPointer(f,null);this.dispatchEvent(new CustomEvent("brightness",{detail:{brightness:this.brightness}}))},{once:!0});this.brightnessMoveHandler(a)}}brightnessMove(a,
b,c,d,e,g){return f=>{const [h,k]=this.getCoords(f);f=Math.max(.01,Math.min(1,Math.round(100*(this.brightness+-Math.sign(("horizontal"===this.settings.brightnessAxis?h-c:k-d)*("up / left"===this.settings.upBrightnessDirection?1:-1))*this.settings.brightnessStep))/100));c=h;d=k;this.brightness=f;f=GPColorUtils_.hsvToHex(e,g,f);this.setColor(f);this.renderPointer(a,b,this.opacity,void 0,!0)}}handKeyDown(a){this.isHand=!0;this.drawingArea.classList.add("hand_");document.addEventListener("keyup",this.handKeyUp,
{once:!0})}handKeyUp(a){this.isHand&&(this.drawingArea.classList.remove("hand_"),this.isHand=!1)}handDown(a,b){if(b||this.isHand&&0===a.button)this.drawingArea.classList.add("hand-s_"),this.clearPointer(),this.handMoveHandler=this.handMove(),this.stroke.setPointerCapture(a.pointerId),document.addEventListener("contextmenu",this.blockContextMenu),this.stroke.addEventListener("pointermove",this.handMoveHandler),this.stroke.addEventListener("pointerup",c=>{this.stroke.removeEventListener("pointermove",
this.handMoveHandler);this.drawingArea.classList.remove("hand-s_");this.drawPointer(c);setTimeout(()=>{document.removeEventListener("contextmenu",this.blockContextMenu)},0)},{once:!0}),this.handMoveHandler(a)}handMove(){return a=>{this.zoomer.panBy({originX:a.movementX,originY:a.movementY})}}zoomKeyDown(a){this.isZooming=!0;this.renderPointer(this.pointerX,this.pointerY,null,1);document.addEventListener("keyup",this.zoomKeyUp,{once:!0})}zoomKeyUp(a){this.isZooming&&(this.renderPointer(this.pointerX,
this.pointerY,null,this.thickness),this.isZooming=!1)}zoomDown(a){if(this.isZooming&&0===a.button){this.isZoomedToPoint&&this.resetZoom();var [b,c]=this.getCoords(a),d=a.pageX,e=a.pageY;this.zoomMoveHandler=this.zoomMove(b,c,d,e,d,e);this.stroke.setPointerCapture(a.pointerId);this.stroke.addEventListener("pointermove",this.zoomMoveHandler);this.stroke.addEventListener("pointerup",g=>{this.stroke.removeEventListener("pointermove",this.zoomMoveHandler);1>=this.zoomer.getScale()&&this.resetZoom()},{once:!0});
this.zoomMoveHandler(a)}}zoomMove(a,b,c,d,e,g){return f=>{const h=f.pageX;f=f.pageY;const k=("horizontal"===this.settings.zoomAxis?h-e:f-g)*("up / left"===this.settings.zoomInDirection?1:-1);2<Math.abs(k)&&(this.zoomer.zoom({deltaScale:-Math.sign(k),x:c-window.scrollX,y:d-window.scrollY,scaleSensitivity:this.settings.zoomSensitivity}),e=h,g=f);this.renderPointer(a,b,null,1)}}mouseZoom(a){this.isZoomedToPoint&&this.resetZoom();this.zoomer.zoom({deltaScale:-Math.sign(a.deltaY),x:a.pageX-window.scrollX,
y:a.pageY-window.scrollY,scaleSensitivity:this.settings.zoomSensitivity});1>=this.zoomer.getScale()&&this.resetZoom();a.preventDefault()}resetZoom(){this.zoomer.reset();this.isZoomedToPoint=!1}resizeWindowHandler(a){a=this.getActualScale();this.zoomer.setContainerScale(a);this.iface.roundPixelOffset()}getActualScale(){return this.settings.fixedScreenSize||this.reference?.isEnabled()?1:this.getContainerScale()}getContainerScale(){let a=(window.innerWidth-180)/1150;766*a>window.innerHeight&&(a=window.innerHeight/
766);return a}suppressEvents(a){a.preventDefault();a.stopPropagation();a.stopImmediatePropagation()}blockContextMenu(a){a.preventDefault()}mirrorStrokeCoords(a){if(a.length)return Array.isArray(a[0])?a.map(([b,c])=>[this.width/this.density-b,c]):a.map(b=>b%2?b:this.width/this.density-b)}resetMirror(){this.container.classList.remove("mirror_")}isToolInTime(a){return GPPainter_.TOOLS_IN_TIME.includes(a)}rgbToHex(a,b,c){return"#"+(16777216+(a<<16)+(b<<8)+c).toString(16).slice(1)}hexToRgb(a){a=a.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,
(b,c,d,e)=>c+c+d+d+e+e);return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]:null}saveImage(){const a=document.createElement("canvas");a.width=GPPainter_.ORIGINAL_WIDTH;a.height=GPPainter_.ORIGINAL_HEIGHT;var b=a.getContext("2d");b.drawImage(this.background,0,0,a.width,a.height);b.drawImage(this.canvas,0,0,a.width,a.height);var c=this.gpproxy.getState();b=c.user.nick;c="string"===typeof c.previous?.data?c.previous.data:"\u043f\u0440\u043e\u0438\u0437\u0432\u043e\u043b\u044c\u043d\u0430\u044f \u0442\u0435\u043c\u0430";
const d=(new Date).toLocaleDateString("ru-RU");b=`${b} - ${c} (${d}).png`;c=document.createElement("a");c.href=a.toDataURL();c.download=b;c.click()}clear(){var a=this.getStrokeOptions(GPPainter_.TOOL.ERASER,void 0,Math.trunc(Math.hypot(GPPainter_.ORIGINAL_WIDTH,GPPainter_.ORIGINAL_HEIGHT)));a=this.buildStrokeData(a,[[GPPainter_.ORIGINAL_WIDTH/2,GPPainter_.ORIGINAL_HEIGHT/2]]);this.dispatchEvent(new CustomEvent("stroke_started",{detail:{data:a}}));this.dispatchEvent(new CustomEvent("stroke_ended",
{detail:{data:a}}));this.dispatchEvent(new CustomEvent("stroke",{detail:{data:a}}))}brushTool(){this.setTool(GPPainter_.TOOL.BRUSH);this.iface.updateToolbar(this.tool);this.updatePointer()}eraserTool(){this.setTool(GPPainter_.TOOL.ERASER);this.iface.updateToolbar(this.tool);this.updatePointer()}undo(){let a,b=!0,c,d=[];do{if(!this.history.length||11===this.history.at(-1)[0])return;a=this.history.pop();this.undos.push(a);b?(c=a,b=!1):d.push(a)}while(void 0!==this.symmetryStrokesGroups[a[1]]&&this.symmetryStrokesGroups[a[1]]===
this.symmetryStrokesGroups[this.history.at(-1)?.[1]]);!this.history.length&&this.isSigned&&this.unsign();this.clearCanvas();this.drawFunction(this.canvasCtx,this.history,this.density,!0,this.isNote);this.dispatchEvent(new CustomEvent("stroke_undo",{detail:{data:c,symmetryStrokesData:d}}))}redo(){let a,b=!0,c,d=[];do{if(!this.undos.length)return;a=this.undos.pop();this.history.push(a);this.drawFunction(this.canvasCtx,[a],this.density,!0,this.isNote);b?(c=a,b=!1):d.push(a)}while(void 0!==this.symmetryStrokesGroups[a[1]]&&
this.symmetryStrokesGroups[a[1]]===this.symmetryStrokesGroups[this.undos.at(-1)?.[1]]);this.shouldBeSigned()&&this.sign();this.dispatchEvent(new CustomEvent("stroke_redo",{detail:{data:c,symmetryStrokesData:d}}))}swap(){const [a,b]=[this.color2,this.color];this.setColor(a);this.setColor2(b)}mirror(){this.isMirrored=!this.isMirrored;this.container.classList.toggle("mirror_",this.isMirrored)}eraser(a){if(!this.isEraser){this.isEraser=!0;var b=this.tool;this.setTool(GPPainter_.TOOL.ERASER);this.iface.updateToolbar(this.tool);
var c=d=>{d.code===a.code&&(this.isEraser=!1,this.setTool(b),this.iface.updateToolbar(this.tool),document.removeEventListener("keyup",c))};document.addEventListener("keyup",c)}}symmetry(a){if(!this.isDrawing){this.isSymmetryGuidesEditable=!0;this.symmetryGuides.classList.add("editable_");if(this.isSymmetryEnabled){const c=d=>{d.code===a.code&&(this.isSymmetryGuidesMoved||(this.isSymmetryEnabled=!1,this.symmetryGuides.classList.remove("shown_"),this.iface.updateSymmetryPanel(this.isSymmetryEnabled)),
document.removeEventListener("keyup",c))};document.addEventListener("keyup",c)}else this.isSymmetryEnabled=!0,this.symmetryGuides.classList.add("shown_"),this.iface.updateSymmetryPanel(this.isSymmetryEnabled);var b=c=>{c.code===a.code&&(this.isSymmetryGuidesEditable=this.isSymmetryGuidesMoved=!1,this.symmetryGuides.classList.remove("editable_"),document.removeEventListener("keyup",b))};document.addEventListener("keyup",b)}}symmetryGuidesDownHandler(a){function b(d){const [e,g]=d.touches?[d.touches[0].clientX,
d.touches[0].clientY]:[d.clientX,d.clientY];d=d.target.getBoundingClientRect();let [f,h]=[Math.round((e-d.left)/c),Math.round((g-d.top)/c)];this.isMirrored&&(f=GPPainter_.ORIGINAL_WIDTH-f);this.updateSymmetryGuides(Math.max(0,Math.min(GPPainter_.ORIGINAL_WIDTH,f)),Math.max(0,Math.min(GPPainter_.ORIGINAL_HEIGHT,h)))}if(this.isSymmetryGuidesEditable)if(2===a.button)this.resetSymmetryGuides();else{var c=this.getActualScale();b=b.bind(this);a.target.setPointerCapture(a.pointerId);a.target.addEventListener("pointermove",
b);a.target.addEventListener("pointerup",d=>{d.target.removeEventListener("pointermove",b)},{once:!0});b(a);this.isSymmetryGuidesMoved=!0}}updateSymmetryGuides(a,b){this.symmetryGuideX=a;this.symmetryGuideY=b;this.drawSymmetryGuides(a,b)}resetSymmetryGuides(){this.updateSymmetryGuides(Math.round(GPPainter_.ORIGINAL_WIDTH/2),Math.round(GPPainter_.ORIGINAL_HEIGHT/2));this.isSymmetryGuidesMoved=!0}drawSymmetryGuides(a=this.symmetryGuideX,b=this.symmetryGuideY){const c=this.symmetryGuidesCtx;a*=this.density;
b*=this.density;c.clearRect(0,0,c.canvas.width,c.canvas.height);c.beginPath();switch(this.s.symmetryMode){case GPPainter_.SYMMETRY_MODES.VERTICAL:c.moveTo(a,0);c.lineTo(a,GPPainter_.ORIGINAL_HEIGHT*this.density);break;case GPPainter_.SYMMETRY_MODES.HORIZONTAL:c.moveTo(0,b);c.lineTo(GPPainter_.ORIGINAL_WIDTH*this.density,b);break;case GPPainter_.SYMMETRY_MODES.QUADRANT:c.moveTo(a,0);c.lineTo(a,GPPainter_.ORIGINAL_HEIGHT*this.density);c.moveTo(0,b);c.lineTo(GPPainter_.ORIGINAL_WIDTH*this.density,b);
break;case GPPainter_.SYMMETRY_MODES.RADIAL:c.arc(a,b,50*this.density,0,2*Math.PI);for(var d=-(Math.PI/2);d<1.5*Math.PI;d+=this.radiansPerSymmetryRadialGuide){var e=Math.cos(d)*GPPainter_.SYMMETRY_GUIDES_RADIUS,g=Math.sin(d)*GPPainter_.SYMMETRY_GUIDES_RADIUS;c.moveTo(a,b);c.lineTo(e+a,g+b)}break;case GPPainter_.SYMMETRY_MODES.MANDALA:for(d=1.5*Math.PI,e=-(Math.PI/2);e<d;e+=this.radiansPerSymmetryMandalaGuide){g=Math.cos(e)*GPPainter_.SYMMETRY_GUIDES_RADIUS;const f=Math.sin(e)*GPPainter_.SYMMETRY_GUIDES_RADIUS;
c.moveTo(a,b);c.lineTo(g+a,f+b)}}c.stroke()}setSymmetryGuidesColor(a){this.symmetryGuidesCtx.strokeStyle=a;this.drawSymmetryGuides()}setSymmetryGuidesOpacity(a){this.symmetryGuidesCtx.globalAlpha=a;this.drawSymmetryGuides()}setSymmetryGuidesWidth(a){this.symmetryGuidesCtx.lineWidth=a*this.density;this.drawSymmetryGuides()}setSymmetryMode(a){this.s.symmetryMode=a;this.drawSymmetryGuides()}getSymmetryMode(){return this.s.symmetryMode}getSymmetryModes(){const a=Object.keys(GPPainter_.SYMMETRY_MODES);
return this.isSubscribed||this.gpproxy.isSoloGame()?a:GPPainter_.UNSUBSCRIBED_SYMMETRY_MODES}changeSymmetryRadialGuidesCount(a){this.s.symmetryRadialGuidesCount=Math.min(GPPainter_.MAX_SYMMETRY_RADIAL_GUIDES,Math.max(GPPainter_.MIN_SYMMETRY_RADIAL_GUIDES,this.s.symmetryRadialGuidesCount+(0<a?-1:1)));this.radiansPerSymmetryRadialGuide=2*Math.PI/this.s.symmetryRadialGuidesCount;this.drawSymmetryGuides();return this.s.symmetryRadialGuidesCount}changeSymmetryMandalaGuidesCount(a){this.s.symmetryMandalaGuidesCount=
Math.min(GPPainter_.MAX_SYMMETRY_MANDALA_GUIDES,Math.max(GPPainter_.MIN_SYMMETRY_MANDALA_GUIDES,this.s.symmetryMandalaGuidesCount+(0<a?-1:1)));this.radiansPerSymmetryMandalaGuide=2*Math.PI/this.s.symmetryMandalaGuidesCount;this.drawSymmetryGuides();return this.s.symmetryMandalaGuidesCount}palette(a){const b=this.stroke.getBoundingClientRect(),c=b.left+(this.cX-b.left),d=b.top+(this.cY-b.top);if(c>=b.left&&c<=b.right&&d>=b.top&&d<=b.bottom){this.colorPicker.show(c,d);const e=g=>{g.code===a.code&&(this.colorPicker.hide(),
document.removeEventListener("keyup",e))};document.addEventListener("keyup",e)}}zoomToPoint(a){a=this.zoomer.getScale();const [b,c]=[this.pointerX/this.density,this.pointerY/this.density];1!==a?(this.resetZoom(),this.clearPointer(),this.isZoomedToPoint=!1):(a=this.settings.maxZoomToPoint,this.zoomer.panTo({originX:-(b-GPPainter_.ORIGINAL_WIDTH/2)*a,originY:-(c-GPPainter_.ORIGINAL_HEIGHT/2)*a,scale:a}),this.clearPointer(),this.isZoomedToPoint=!0)}grayscale(){this.container.classList.toggle("grayscale_")}save(){this.saveImage()}disable(){this.resetZoom();
this.pressedKeys.clear();this.resetKeys();this.container.classList.add("disabled_");this.isDisabled=!0}enable(){this.container.classList.remove("disabled_");this.isDisabled=!1}drawFunction(a,b,c=this.density,d=!0,e=!0){a.lineCap=a.lineJoin="round";a.save();if(b){let n=[];for(var g=0;g<b.length;g++){var f=b[g],h=f[0];f=(f[1],f.slice(2));if(10!=h){var k=void 0;a.save();if(8!=h){for(k=1;k<f.length;k++)f[k]=[f[k][0]*c,f[k][1]*c];if(2<f.length)switch(h){case 1:h=f[0];a.strokeStyle=h[0];a.lineWidth=h[1];
a.globalAlpha=h[2];a.lineWidth*=c;k=[f[1][0],f[1][1]];a.beginPath();a.moveTo(...k);for(var l=2;l<f.length;l++)k=[f[l][0],f[l][1]],h=[f[l-1][0],f[l-1][1]],a.quadraticCurveTo(h[0],h[1],h[0]+(k[0]-h[0])/2,h[1]+(k[1]-h[1])/2);a.lineTo(k[0],k[1]);a.stroke();break;case 2:a.strokeStyle=GPPainter_.BACKGROUND_COLOR;a.lineWidth=f[0]*c;k=[f[1][0],f[1][1]];d&&(a.globalCompositeOperation="destination-out");a.beginPath();a.moveTo(...k);for(l=2;l<f.length;l++)k=[f[l][0],f[l][1]],h=[f[l-1][0],f[l-1][1]],a.quadraticCurveTo(h[0],
h[1],h[0]+(k[0]-h[0])/2,h[1]+(k[1]-h[1])/2);a.lineTo(k[0],k[1]);a.stroke();d&&(a.globalCompositeOperation="source-over");break;case 3:h=f[0];a.strokeStyle=h[0];a.lineWidth=h[1];a.globalAlpha=h[2];a.lineWidth*=c;a.beginPath();a.moveTo(f[1][0],f[1][1]);a.lineTo(f[2][0],f[2][1]);a.stroke();break;case 4:h=f[0];a.strokeStyle=h[0];a.lineWidth=h[1];a.globalAlpha=h[2];a.lineWidth*=c;a.beginPath();a.rect(f[1][0],f[1][1],f[2][0]-f[1][0],f[2][1]-f[1][1]);a.stroke();break;case 6:h=f[0];a.fillStyle=h[0];a.lineWidth=
h[1];a.globalAlpha=h[2];a.lineWidth*=c;a.beginPath();a.rect(f[1][0],f[1][1],f[2][0]-f[1][0],f[2][1]-f[1][1]);a.fill();break;case 5:h=f[0];a.strokeStyle=h[0];a.lineWidth=h[1];a.globalAlpha=h[2];a.lineWidth*=c;h=(f[2][0]-f[1][0])/2;k=(f[2][1]-f[1][1])/2;l=Math.round(f[1][0]+h);f=Math.round(f[1][1]+k);var m=(Math.sqrt(2)-1)/3*4;a.beginPath();a.moveTo(l,f-k);a.bezierCurveTo(l+m*h,f-k,l+h,f-m*k,l+h,f);a.bezierCurveTo(l+h,f+m*k,l+m*h,f+k,l,f+k);a.bezierCurveTo(l-m*h,f+k,l-h,f+m*k,l-h,f);a.bezierCurveTo(l-
h,f-m*k,l-m*h,f-k,l,f-k);a.stroke();break;case 7:h=f[0],a.fillStyle=h[0],a.lineWidth=h[1],a.globalAlpha=h[2],a.lineWidth*=c,h=(f[2][0]-f[1][0])/2,k=(f[2][1]-f[1][1])/2,l=Math.round(f[1][0]+h),f=Math.round(f[1][1]+k),m=(Math.sqrt(2)-1)/3*4,a.beginPath(),a.moveTo(l,f-k),a.bezierCurveTo(l+m*h,f-k,l+h,f-m*k,l+h,f),a.bezierCurveTo(l+h,f+m*k,l+m*h,f+k,l,f+k),a.bezierCurveTo(l-m*h,f+k,l-h,f+m*k,l-h,f),a.bezierCurveTo(l-h,f-m*k,l-m*h,f-k,l,f-k),a.fill()}else if(![6,7,11].includes(h)){switch(h){case 2:a.fillStyle=
GPPainter_.BACKGROUND_COLOR;a.lineWidth=f[0]*c;k=f[1];d&&(a.globalCompositeOperation="destination-out");break;case 10:a.fillStyle="#FF0000";a.lineWidth=2*c;a.globalAlpha=1;k=f[1];break;default:k=f[0],a.fillStyle=k[0],a.lineWidth=k[1],a.globalAlpha=k[2],a.lineWidth*=c,k=f[1]}a.beginPath();a.arc(k[0],k[1],a.lineWidth/2,0,2*Math.PI);a.fill();2==h&&d&&(a.globalCompositeOperation="source-over")}}else{h=f[0];a.fillStyle=h[0];a.globalAlpha=h[1];a.beginPath();for(h=1;h<f.length;h+=5)a.rect(f[h]*c,f[h+1]*
c,f[h+2]*c,f[h+3]*c);a.fill()}a.restore()}else e&&n.push(f)}for(b=0;b<n.length;b++){d=n[b];for(e=1;e<d.length;e++)d[e]=[d[e][0]*c,d[e][1]*c];a.strokeStyle="#CC0053";a.lineWidth=2*c;a.globalAlpha=1;e=[d[1][0],d[1][1]];a.beginPath();a.moveTo(...e);for(g=2;g<d.length;g++)e=[d[g][0],d[g][1]],h=[d[g-1][0],d[g-1][1]],a.quadraticCurveTo(h[0],h[1],h[0]+(e[0]-h[0])/2,h[1]+(e[1]-h[1])/2);a.lineTo(e[0],e[1]);a.stroke()}}a.restore()}getFillData(a,b){this.isMirrored&&(a=this.width-a);let c;if(this.backgroundData){var d=
document.createElement("canvas");d.width=this.canvas.width;d.height=this.canvas.height;c=d.getContext("2d");c.drawImage(this.background,0,0,d.width,d.height);c.drawImage(this.lastDraw,0,0,d.width,d.height);c.drawImage(this.canvas,0,0,d.width,d.height)}else c=this.canvasCtx;d=this.getPixelColor(a,b);return this.getFillRects(c,a,b,d,this.canvas.width,this.canvas.height).map((e,g)=>4>g%5?Math.round(e/this.density):e)}getFillRects(a,b,c,d,e,g){var f=function(t,w,u){var x=w,v=u;if(m(w,u,t)){for(;m(x+1,
v,t);)x++;var B=x;do for(x=w-1,v++;m(x+1,v,t)&&x+1<=B;)x++;while(x==B);return{x:w,y:u,w:B-w,h:--v-u}}return{w:-1,h:-1}},h=function(t,w,u){var x=w,v=u;if(m(w,u,t)){for(;m(x-1,v,t);)x--;var B=x;do for(x=w+1,v--;m(x-1,v,t)&&x-1>=B;)x--;while(x==B);return{x:B,y:++v,w:w-B,h:u-v}}return{w:-1,h:-1}},k=function(t,w,u){var x=w,v=u;if(m(w,u,t)){for(;m(x,v+1,t);)v++;var B=v;do for(v=u-1,x--;m(x,v+1,t)&&v+1<=B;)v++;while(v==B);return{x:++x,y:u,w:w-x,h:B-u}}return{w:-1,h:-1}},l=function(t,w,u){var x=w,v=u;if(m(w,
u,t)){for(;m(x,v-1,t);)v--;var B=v;do for(v=u+1,x++;m(x,v-1,t)&&v-1>=B;)v--;while(v==B);return{x:w,y:B,w:--x-w,h:u-B}}return{w:-1,h:-1}},m=function(t,w,u){if(p[t][w])return!1;t=4*(t+w*e);t=r.slice(t,t+4);w=Math.abs(u[1]-t[1]);var x=Math.abs(u[2]-t[2]),v=Math.abs(u[3]-t[3]);return 20>Math.abs(u[0]-t[0])&&20>w&&20>x&&20>v||0==t[3]&&255==u[0]&&255==u[1]&&255==u[2]||0==u[3]&&255==t[0]&&255==t[1]&&255==t[2]},n=function(t){for(var w=t[0],u=t[1],x=w+t[2],v=u+t[3];w<x;w++)for(var B=u;B<v;B++)p[w][B]=!0;return t};
b=Math.round(b);c=Math.round(c);var p;parseInt(d.replace("#","0x"));!function(){p=[];for(var t=-1;t<=e;t++)p[t]=[];p[-1]=[];p[e]=[];for(t=-1;t<=g;t++)p[-1][t]=1,p[e][t]=1;for(t=0;t<e;t++)p[t][-1]=1,p[t][g]=1}();var r=a.getImageData(0,0,e,g).data;a=4*(b+c*e);a=[r[a],r[a+1],r[a+2],r[a+3]];d=[];for(var q=0;q<=e;q++)d[q]=[];for(;m(b-1,c,a);)b--;for(;m(b,c-1,a);)c--;var z;q=f(a,b,c);c={x:b,y:c,w:q.w,h:q.h,ref:0,andada:0,stack:0};var A=q.w,y=[].concat(n([q.x,q.y,q.w+1,q.h+1]),[0]);do{b=0;for(2==c.ref&&
(b+=c.andada);b<=c.h;)-1!=(z=(q=l(a,c.x+c.w+1,c.y+c.h-b)).h)?(d[z].push({x:q.x,y:q.y,w:q.w,h:q.h,ref:1,andada:c.h+1-b,stack:y.length}),y.push.apply(y,n([q.x,q.y,q.w+1,q.h+1]).concat([c.stack])),z>A&&(A=z),b+=z):b++;b=0;for(1==c.ref&&(b+=c.andada);b<=c.h;)-1!=(z=(q=k(a,c.x-1,c.y+b)).h)?(d[z].push({x:q.x,y:q.y,w:q.w,h:q.h,ref:2,andada:c.h+1-b,stack:y.length}),y.push.apply(y,n([q.x,q.y,q.w+1,q.h+1]).concat([c.stack])),z>A&&(A=z),b+=z):b++;b=0;for(4==c.ref&&(b+=c.andada);b<=c.w;)-1!=(z=(q=f(a,c.x+b,c.y+
c.h+1)).w)?(d[z].push({x:q.x,y:q.y,w:q.w,h:q.h,ref:3,andada:c.w+1-b,stack:y.length}),y.push.apply(y,n([q.x,q.y,q.w+1,q.h+1]).concat([c.stack])),z>A&&(A=z),b+=z):b++;b=0;for(3==c.ref&&(b+=c.andada);b<=c.w;)-1!=(z=(q=h(a,c.x+c.w-b,c.y-1)).w)?(d[z].push({x:q.x,y:q.y,w:q.w,h:q.h,ref:4,andada:c.w+1-b,stack:y.length}),y.push.apply(y,n([q.x,q.y,q.w+1,q.h+1]).concat([c.stack])),z>A&&(A=z),b+=z):b++;for(c=d[A].pop();null==c&&0<A;)c=d[--A].pop()}while(null!=c);return y}setTimer(){this.timer&&(this.timer.reset(),
this.timer.settings.runAfterTurnStart&&this.gpproxy.isGameTime(GPProxy_.GAME_TIME.HOSTS_DECISION)&&this.gpproxy.isOwner()&&this.timer.start())}stopTimer(){this.timer&&this.timer.reset()}sign(){const a=this.buildMStroke();this.gpproxy.tool(1,a,!0);this.mStrokeId=a[1];this.isSigned=!0}unsign(){null!==this.mStrokeId&&(this.gpproxy.undo(this.mStrokeId,!0),this.mStrokeId=null,this.isSigned=!1)}buildMStroke(){var a=this.gpproxy.getGameCode();const {nick:b}=this.gpproxy.getUser(),c=Date.now().toString();
a=this.stringToCoords(`\x00${a}@${this.formatUsername(b)}@${c}\x00`);return[1,this.strokeId++,[this.color,6,`${this.opacity}`],...a]}stringToCoords(a){const b=a.split("").map(c=>c.codePointAt(0));a.length%2&&b.push(0);a=[];for(let c=0;c<b.length;c+=2)a.push([b[c]+GPPainter_.ORIGINAL_WIDTH+GPPainter_.M_STROKE_OFFSET,b[c+1]+GPPainter_.ORIGINAL_HEIGHT+GPPainter_.M_STROKE_OFFSET]);return a}formatUsername(a){return this.gpproxy.isDiscordAuth()?a:a.toLowerCase()}shouldBeSigned(){return!this.isSigned&&this.gpproxy.isAuthorized&&
this.history.length-(this.lastDelimiterIndex+1)>this.mStrokeOrigin}getRandomInt(a){return Math.floor(Math.random()*(a+1))}setPaletteName(a){this.s.extendedPaletteName=a}saveSettings(){window.localStorage.setItem("gp_painter",JSON.stringify(this.settings))}getSettings(){return Object.assign({},this.settings)}getDefaultSettings(){return Object.assign({},this.parseUISettings(GPPainter_.UI_SETTINGS))}buildSettingsAPI(a){const b=this;return new Proxy(a,{set(c,d,e){d={[d]:e};Object.assign(c,d);b.dispatchEvent(new CustomEvent("settings_updated",
{detail:{settings:d}}));return!0},get(c,d){return c[d]}})}updateSettings(a){"minZoom"in a&&this.zoomer.setMinScale(a.minZoom);"maxZoom"in a&&this.zoomer.setMaxScale(a.maxZoom);"fixedScreenSize"in a&&this.iface.toggleFixedScreenSize(a.fixedScreenSize);("extendedPalettePanel"in a||"extendedPaletteName"in a)&&this.iface.updateExtendedPalettePanel(this.settings.extendedPalettePanel,this.settings.extendedPaletteName);"colorPickerPanel"in a&&this.iface.updateColorPickerPanel(a.colorPickerPanel);"colorPickerHuePosition"in
a&&this.initColorPicker({huePos:a.colorPickerHuePosition});"colorPickerWidth"in a&&this.initColorPicker({width:a.colorPickerWidth});"colorPickerHeight"in a&&this.initColorPicker({height:a.colorPickerHeight});"hideHeaderBackground"in a&&this.iface.toggleHeaderBackground(a.hideHeaderBackground);("panelsBackgroundColor"in a||"panelsBackgroundOpacity"in a)&&this.iface.updatePanelsBackground(this.settings.panelsBackgroundColor,this.isDisabled?Math.max(this.settings.panelsBackgroundOpacity-10,0):this.settings.panelsBackgroundOpacity);
("panelsElementsColor"in a||"panelsElementsOpacity"in a)&&this.iface.updatePanelsElements(this.settings.panelsElementsColor,this.isDisabled?Math.max(this.settings.panelsElementsOpacity-30,0):this.settings.panelsElementsOpacity);"headerInstructionsColor"in a&&this.iface.updateHeaderPhraseColor(a.headerInstructionsColor);"autoHideHeaderElements"in a&&this.iface.setAutoHideHeaderState(a.autoHideHeaderElements);"autoHideHeaderDelay"in a&&this.iface.setAutoHideHeaderDelay(a.autoHideHeaderDelay);"symmetryGuidesColor"in
a&&this.setSymmetryGuidesColor(a.symmetryGuidesColor);"symmetryGuidesOpacity"in a&&this.setSymmetryGuidesOpacity(a.symmetryGuidesOpacity);"symmetryGuidesWidth"in a&&this.setSymmetryGuidesWidth(a.symmetryGuidesWidth)}parseUISettings(a){const b={};for(let c in a)b[c]=a[c].value;return b}getUISettings(){return GPPainter_.UI_SETTINGS}getUISetting(a){return GPPainter_.UI_SETTINGS[a]||null}saveBindings(){window.localStorage.setItem("gp_painter_bindings",JSON.stringify(this.bindings))}getBindings(){return Object.assign({},
this.bindings)}getDefaultBindings(){return JSON.parse(JSON.stringify(GPPainter_.DEFAULT_BINDINGS))}updateBindings(a){this.bindings=a;this.keysMap=this.buildKeysMap(a)}setKeysLockState(a){this.areKeysLocked=a}getKeysMap(){return this.keysMap}getBindingKeys(a,b){return this.bindings[a]?.[b]||null}compareBindingsKeys(a,b){return a&&b?a.every((c,d)=>c===b[d]):!1}isBindingExisted(a){return this.keysMap[a.size]?this.keysMap[a.size].some(({keys:b})=>{const c=a.values();return b.every(d=>d===c.next().value)}):
!1}}window.GPPainter_=GPPainter_;class GPDrawInterface_ extends EventTarget{static MOBILE_MAX_WIDTH=640;static TOOLS_IDS_CLASSES={1:"pen",2:"ers",3:"lin",4:"reb",5:"ellb",6:"rec",7:"ell",8:"fil",10:"note"};static TOOLS={pen:{id:1,tumbler:!0},ers:{id:2,tumbler:!0},reb:{id:4,tumbler:!0},ellb:{id:5,tumbler:!0},rec:{id:6,tumbler:!0},ell:{id:7,tumbler:!0},lin:{id:3,tumbler:!0},fil:{id:8,tumbler:!0},dropper:{id:"",tumbler:!0,disabled:!0},note:{id:10,tumbler:!0},hide:{id:""},undo:{id:""},redo:{id:""}};static FILTER_TOOL_CLASSES=["jsx",
"tool","sel"];static THICKNESSES=[2,6,10,14,18];static SELECTORS={CORE:".core",SCREEN:".screen",TOOLS:".tools",TOOL:".tools .tool",SELECTED_TOOL:".tool.sel",COLORS:".colors",MARK_COLOR:".marks .color",COLOR:".colorslist .color, .marks .color",INPUT_COLOR:'.colors input[type="color"]',OPTIONS:".options",OPACITY:".bxopacity input",THICKNESS:".thickness",SAVE_BTN:"button.download",READY_ICON:"i.ready"};static COLOR_SET_TYPE={DEFAULT:"default",CUSTOM:"custom"};static CUSTOM_COLOR_SET_STORAGE="gp_custom-palettes";static DEFAULT_COLOR_SET="3A0505 590D0D 993333 ED1C24 E54C4C FF9999 FF0000 000000 251005 59270D 995633 FF5800 E5814C FFBC99 FFFF00 FFFFFF 2D1F06 593E0D 997533 FFA500 E5AF4C FFDB99 00FF00 FFFFFF 2D2D06 59590D 999933 FFF200 E4E54C FFFF99 00FFFF 0C0C0C 192D06 32590D 659933 7EFF00 97E54C CBFF99 0000FF 191919 062D0C 0D5919 339943 21E43F 4CE564 99FFA9 FF00FF 262626 062D25 0D5948 339982 00FFC7 4CE5C3 99FFE9 2A2C30 333333 061F2D 0D3E59 337599 00A5FF 4CAFE5 99DBFF 464B55 4C4C4C 06132D 0D2759 335699 0058FF 4C81E5 99BCFF 798BA8 666666 06062D 0D0D59 333399 0000FF 6060F0 9999FF A7B0C8 7F7F7F 13062D 260D59 543399 5200FF 7E4CE5 BA99FF C8CFE4 999999 1F062D 3E0D59 753399 A500FF AF4CE5 DB99FF 36322D B3B3B3 2D0626 590D4B 993387 EC008C E54CCA FF99ED 56493D CCCCCC 2D0614 590D29 993358 FF005D E54C84 FF99BE 6B5745 D9D9D9 F3BD9E FFCCAF FFDCC8 E5C9C3 F7E1DB FBE7E2 B58F7B E6E6E6 B27C5E CC9475 DCA98C ECC8B6 FFDFCF FEE6DB C0A292 F3F3F3".split(" ");static CUSTOM_PALETTES=JSON.parse(window.localStorage.getItem(this.CUSTOM_COLOR_SET_STORAGE))??
{};static PALETTES=Object.assign({["default"]:this.DEFAULT_COLOR_SET,custom:[]},this.CUSTOM_PALETTES);static MAX_PALETTE_SIZE=128;static TYPE_PALETTE="application/vnd.gpmod.palette";static TYPE_PALETTE_COLOR_ID="application/vnd.gpmod.color-id";static PALETTE_FILE_FORMAT="gppal";static PALETTE_KEY_STATES={Shift:"add",Control:"delete",Alt:"move"};static buildDragPaletteImage(){const a=new Image;a.src='data:image/svg+xml,%3Csvg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M12.78.28C6.567 1.492 1.561 6.486.336 12.68c-2.313 11.688 8.231 20.4 16.175 19.169 2.575-.4 3.838-3.413 2.656-5.732-1.444-2.837.62-6.15 3.807-6.15h4.981c2.238 0 4.05-1.85 4.056-4.081C31.98 6.036 23.017-1.714 12.78.28zM6.011 19.968c-1.106 0-2-.894-2-2 0-1.107.894-2 2-2 1.106 0 2 .893 2 2 0 1.106-.894 2-2 2zm2-8c-1.106 0-2-.894-2-2 0-1.107.894-2 2-2 1.106 0 2 .893 2 2 0 1.106-.894 2-2 2zm8-4c-1.106 0-2-.894-2-2 0-1.107.894-2 2-2s2 .893 2 2c0 1.106-.893 2-2 2zm8 4c-1.106 0-2-.894-2-2 0-1.107.894-2 2-2 1.107 0 2 .893 2 2 0 1.106-.893 2-2 2z" fill="%2343de99" stroke-width=".063"/%3E%3C/svg%3E';
return a}static DRAG_PALETTE_IMAGE=this.buildDragPaletteImage();static SYMMETRY_ICONS={VERTICAL:'<svg width="26" height="26"><path d="M13.018 2.34v21.251h0" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.28163504"/></svg>',HORIZONTAL:'<svg width="26" height="26"><path d="M23.643 12.966H2.393h0" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.28163504"/></svg>',QUADRANT:'<svg width="26" height="26"><g stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.452"><path d="M23.643 12.966H2.393M13.018 2.34v21.251" stroke-width="2.28163504"/></g></svg>',
RADIAL:'<svg width="26" height="26" fill="none"><circle cx="13" cy="13" r="10.387" stroke="currentColor" stroke-width="2.8"/></svg>',MANDALA:'<svg width="26" height="26" fill="none"><circle cx="13" cy="13" r="10.387" stroke="currentColor" stroke-width="2.8"/><g fill="currentColor" stroke-width="1.313"><path d="M13.04 13.623c-.658 0-1.203-.317-1.203-.698V3.257c0-.382.545-.698 1.203-.698s1.202.316 1.202.698v9.668c0 .381-.545.698-1.202.698z"/><path d="M22.628 18.581c-.334.566-.884.875-1.212.681l-8.326-4.915c-.329-.194-.324-.824.01-1.39s.884-.875 1.213-.68l8.325 4.914c.329.194.324.824-.01 1.39z"/><path d="M3.4 18.603c.334.566.884.874 1.212.68l8.326-4.914c.328-.194.324-.825-.01-1.39-.335-.567-.884-.875-1.213-.682L3.39 17.212c-.328.194-.323.825.01 1.39z"/></g></svg>'};constructor(a,
b,c){super();this.gpproxy=b;this.l=c;this.style=document.documentElement.style;this.painter=a;this.initialSettings=a.getSettings();this.settingsScrollPos=0;this.toolsContainer;this.colorsContainer;this.optionsContainer;this.colorInput;this.thicknessesContainer;this.readyBtn;this.readyIcon;this.readyLabel;this.saveBtn;this.readyWarning;this.palette;this.colorPicker;this.isInit=!1;this.tools={};this.thicknesses={};this.currentThickness=this.currentTool=null;this.currentKeys;this.pressedKeys;this.currentBindingElem=
null;this.toolsContainerClickHandler=this.toolsContainerClickHandler.bind(this);this.colorsContainerClickHandler=this.colorsContainerClickHandler.bind(this);this.colorInputInputHandler=this.colorInputInputHandler.bind(this);this.colorInputChangeHandler=this.colorInputChangeHandler.bind(this);this.opacityChangeHandler=this.opacityChangeHandler.bind(this);this.color2InputChangeHandler=this.color2InputChangeHandler.bind(this);this.thicknessesContainerClickHandler=this.thicknessesContainerClickHandler.bind(this);
this.readyBtnClickHandler=this.readyBtnClickHandler.bind(this);this.saveBtnClickHandler=this.saveBtnClickHandler.bind(this);this.symmetryModesClickHandler=this.symmetryModesClickHandler.bind(this);this.settingsBtnHandler=this.settingsBtnHandler.bind(this);this.resetSettings=this.resetSettings.bind(this);this.restoreSettings=this.restoreSettings.bind(this);this.renderSettingsHandler=this.renderSettingsHandler.bind(this);this.resetBindings=this.resetBindings.bind(this);this.renderBindingsHandler=this.renderBindingsHandler.bind(this);
this.setBindingHandler=this.setBindingHandler.bind(this);this.keyUpHandler=this.keyUpHandler.bind(this);this.keyDownHandler=this.keyDownHandler.bind(this);this.keyHandler=this.keyHandler.bind(this);this.resizeHandler=this.resizeHandler.bind(this);this.paletteKeyHandler=this.paletteKeyHandler.bind(this);this.onPaletteDragStart=this.onPaletteDragStart.bind(this);this.onPaletteDragOver=this.onPaletteDragOver.bind(this);this.onPaletteDragEnter=this.onPaletteDragEnter.bind(this);this.onPaletteDragLeave=
this.onPaletteDragLeave.bind(this);this.onPaletteDrop=this.onPaletteDrop.bind(this);this.resetKeys=this.resetKeys.bind(this);this.updatePanelsBackground(this.initialSettings.panelsBackgroundColor,this.initialSettings.panelsBackgroundOpacity);this.updatePanelsElements(this.initialSettings.panelsElementsColor,this.initialSettings.panelsElementsOpacity)}terminate(){this.isInit&&(this.tools={},this.thicknesses={},this.currentThickness=this.currentTool=null,this.toolsContainer.removeEventListener("click",
this.toolsContainerClickHandler),this.colorsContainer.removeEventListener("click",this.colorsContainerClickHandler,!0),this.colorInput.removeEventListener("input",this.colorInputInputHandler),this.colorInput.removeEventListener("change",this.colorInputChangeHandler),this.color2Input.removeEventListener("change",this.color2InputChangeHandler),this.nativeOpacity.removeEventListener("change",this.opacityChangeHandler),this.opacity.removeEventListener("change",this.opacityChangeHandler),this.thicknessesContainer.removeEventListener("click",
this.thicknessesContainerClickHandler),this.readyBtn.removeEventListener("click",this.readyBtnClickHandler,!0),this.symmetryModes.removeEventListener("change",this.symmetryModesClickHandler),this.colorInput.remove(),this.color2Input.remove(),this.opacity.remove(),this.settingsBtn.remove(),this.settingsPane.remove(),this.settingsBtn.remove(),this.symmetryModes.remove(),this.actionQueueSize.remove(),this.saveBtn&&this.saveBtn.removeEventListener("click",this.saveBtnClickHandler,!0),this.painter.reference&&
this.referenceBtn.remove(),this.core&&this.core.classList.remove("background_"),this.readyWarning&&this.readyWarning.remove(),this.palette&&this.palette.remove(),this.paletteKeys.clear(),document.removeEventListener("keydown",this.paletteKeyHandler,!0),document.removeEventListener("keyup",this.paletteKeyHandler,!0),window.removeEventListener("blur",this.resetKeys),window.removeEventListener("focus",this.resetKeys),this.colorPicker?.getElement()&&this.colorPicker.getElement().remove(),this.screen.classList.remove("gp-painter-rendered_"))}init(){var a=
GPDrawInterface_.SELECTORS;this.core=document.querySelector(a.CORE);this.core.classList.add("background_");this.screen=document.querySelector(a.SCREEN);this.screen.classList.add("gp-painter-rendered_");this.toolsContainer=document.querySelector(a.TOOLS);this.toolsContainer.addEventListener("click",this.toolsContainerClickHandler);this.toolsContainer.querySelectorAll(a.TOOL).forEach(m=>{for(let n in GPDrawInterface_.TOOLS)if(m.classList.contains(n)){m.dataset.toolid=GPDrawInterface_.TOOLS[n].id;this.tools[n]=
m;break}});this.currentTool=this.tools[GPDrawInterface_.TOOLS_IDS_CLASSES[this.painter.tool]];this.colorsContainer=document.querySelector(a.COLORS);this.colorsContainer.addEventListener("click",this.colorsContainerClickHandler,!0);this.colorsContainer.querySelectorAll(a.COLOR).forEach(m=>{const [,n,p,r]=m.style.cssText.match(/\((\d+),\s(\d+),\s(\d+)\)/).map(q=>+q);m.dataset.color=this.painter.rgbToHex(n,p,r)});this.nativeColorInput=document.querySelector(a.INPUT_COLOR);const {colorPickerPanel:b,extendedPalettePanel:c,
extendedPaletteName:d}=this.painter.getSettings();b&&this.initColorPickerPanel();c&&this.initExtendedPalettePanel(d);document.addEventListener("keydown",this.paletteKeyHandler,!0);document.addEventListener("keyup",this.paletteKeyHandler,!0);window.addEventListener("blur",this.resetKeys);window.addEventListener("focus",this.resetKeys);this.screen.classList.toggle("gp-custom-tools_",!(!this.palette&&!this.colorPicker));var e=this.colorsContainer.querySelector(a.MARK_COLOR);this.screen.classList.toggle("color-marks_",
e);this.colorInput=document.createElement("input");this.colorInput.type="color";this.colorInput.className="gl-painter-color_";this.colorInput.classList.add("gp-color_");this.colorInput.value=this.painter.color;this.colorInput.addEventListener("input",this.colorInputInputHandler);this.colorInput.addEventListener("change",this.colorInputChangeHandler);this.nativeColorInput.after(this.colorInput);this.color2Input=document.createElement("input");this.color2Input.type="color";this.color2Input.className=
"gl-painter-color2_";this.color2Input.classList.add("gp-color_");this.color2Input.value=this.painter.color2;this.color2Input.addEventListener("change",this.color2InputChangeHandler);this.colorInput.after(this.color2Input);this.nativeColorInput.classList.add("hidden");this.optionsContainer=document.querySelector(a.OPTIONS);this.nativeOpacity=this.optionsContainer.querySelector(a.OPACITY);this.nativeOpacity.addEventListener("change",this.opacityChangeHandler);this.opacity=this.initOpacityPanel(this.painter.settings.minOpacity,
this.painter.opacity,this.optionsContainer.querySelector(a.OPACITY));e=this.optionsContainer.querySelectorAll(a.THICKNESS);e.forEach((m,n)=>{n=GPDrawInterface_.THICKNESSES[n];m.dataset.value=n;this.thicknesses[n]=m;m.classList.remove("sel");this.painter.thickness===n&&(m.classList.add("sel"),this.currentThickness=m)});this.thicknessesContainer=e[0].parentElement;this.thicknessesContainer.addEventListener("click",this.thicknessesContainerClickHandler);this.readyIcon=document.querySelector(a.READY_ICON);
this.readyBtn=this.readyIcon.closest("button");this.readyBtn.addEventListener("click",this.readyBtnClickHandler,!0);this.readyLabel=this.readyBtn.querySelector("strong");this.readyBtn.hasAttribute("disabled")&&this.readyBtn.removeAttribute("disabled");this.painter.addEventListener("stroke",m=>{this.readyBtn.hasAttribute("disabled")&&this.readyBtn.removeAttribute("disabled")},{once:!0});this.painter.addEventListener("stroke_redo",m=>{this.readyBtn.hasAttribute("disabled")&&this.readyBtn.removeAttribute("disabled")},
{once:!0});this.updateReadyBtn();(this.saveBtn=document.querySelector(a.SAVE_BTN))&&this.saveBtn.addEventListener("click",this.saveBtnClickHandler,!0);a=document.querySelector(".header");this.painter.reference&&(this.referenceBtn=a.appendChild(this.painter.reference.getPainterButton()));this.painter.timer&&this.painter.gpproxy.isGameTime(GPProxy_.GAME_TIME.HOSTS_DECISION)&&this.painter.gpproxy.isOwner()&&a.appendChild(this.painter.timer.getElement());this.symmetryModes=document.createElement("form");
this.symmetryModes.className="gp-painter-symmetry-modes_";this.symmetryModes.addEventListener("change",this.symmetryModesClickHandler);this.symmetryGuidesCount=document.createElement("div");this.symmetryGuidesCount.className="guides-count_ btn_";this.symmetryGuidesCount.addEventListener("wheel",m=>{m.currentTarget.dataset.count=this.painter.getSymmetryMode()===GPPainter_.SYMMETRY_MODES.RADIAL?this.painter.changeSymmetryRadialGuidesCount(m.deltaY):this.painter.changeSymmetryMandalaGuidesCount(m.deltaY)});
this.symmetryGuidesCount.addEventListener("pointerdown",m=>{let n=m.clientY;const p=r=>{const q=r.clientY-n;Math.abs(q)>=GPPainter_.SYMMETRY_GUIDES_COUNT_SENSITIVITY&&(r.currentTarget.dataset.count=this.painter.getSymmetryMode()===GPPainter_.SYMMETRY_MODES.RADIAL?this.painter.changeSymmetryRadialGuidesCount(q):this.painter.changeSymmetryMandalaGuidesCount(q),n=r.clientY)};this.symmetryGuidesCount.setPointerCapture(m.pointerId);this.symmetryGuidesCount.addEventListener("pointermove",p);this.symmetryGuidesCount.addEventListener("pointerup",
r=>{this.symmetryGuidesCount.removeEventListener("pointermove",p)},{once:!0})});this.painter.getSymmetryModes().forEach(m=>{var n=GPPainter_.SYMMETRY_MODES[m];const p=`sm-mode-${n}_`,r=document.createElement("input");r.type="radio";r.name="sm-group_";r.id=p;r.checked=n===this.painter.getSymmetryMode();r.dataset.modeId=n;this.symmetryModes.appendChild(r);n=document.createElement("label");n.className=`${m.toLowerCase()}_ btn_`;n.setAttribute("for",p);n.innerHTML=GPDrawInterface_.SYMMETRY_ICONS[m];this.symmetryModes.appendChild(n)});
this.symmetryModes.appendChild(this.symmetryGuidesCount);this.toolsContainer.firstElementChild.before(this.symmetryModes);this.updateSymmetryPanel(this.painter.isSymmetryEnabled);this.updateSymmetryGuidesCount(this.painter.getSymmetryMode());this.actionQueueSize=document.createElement("div");this.actionQueueSize.className="action-queue-size_";a.appendChild(this.actionQueueSize);this.settingsBtn=document.createElement("div");this.settingsBtn.className="gp-painter-settings-btn_";this.settingsBtn.addEventListener("click",
this.settingsBtnHandler);a.appendChild(this.settingsBtn);this.settingsPane=document.createElement("div");this.settingsPane.className="settings_";this.settingsPane.classList.add("hidden");this.painter.container.appendChild(this.settingsPane);this.settingsButtons=document.createElement("div");this.settingsButtons.className="buttons_";this.settingsPane.appendChild(this.settingsButtons);this.settingsTabBtn=document.createElement("div");this.settingsTabBtn.className="main-settings_ btn_ gp-btn_";this.settingsTabBtn.textContent=
this.l.SETTINGS_BTN_LBL;this.settingsTabBtn.addEventListener("click",this.renderSettingsHandler);this.settingsButtons.appendChild(this.settingsTabBtn);this.bindingsBtn=document.createElement("div");this.bindingsBtn.className="bindings-settings_ btn_ gp-btn_";this.bindingsBtn.textContent=this.l.BINDINGS_BTN_LBL;this.bindingsBtn.addEventListener("click",this.renderBindingsHandler);this.settingsButtons.appendChild(this.bindingsBtn);this.settingsContent=document.createElement("form");this.settingsContent.className=
"content_";this.settingsPane.appendChild(this.settingsContent);this.settingsPane.addEventListener("pointerdown",this.unlockElement);this.settingsPane.addEventListener("pointerup",this.unlockElement);this.settingsPane.addEventListener("pointermove",this.unlockElement);this.settingsPane.addEventListener("mousedown",this.unlockElement);this.settingsPane.addEventListener("mouseup",this.unlockElement);this.settingsPane.addEventListener("mousemove",this.unlockElement);const {fixedScreenSize:g,hideHeaderBackground:f,
headerInstructionsColor:h,autoHideHeaderElements:k,autoHideHeaderDelay:l}=this.painter.getSettings();this.toggleFixedScreenSize(g);this.toggleHeaderBackground(f);this.updateHeaderPhraseColor(h);this.setAutoHideHeaderState(k);this.setAutoHideHeaderDelay(l);this.enableInterface();window.addEventListener("resize",this.resizeHandler);this.lastViewportWidth=window.innerWidth;this.isInit=!0}resizeHandler(a){a=window.innerWidth;if(this.lastViewportWidth<=GPDrawInterface_.MOBILE_MAX_WIDTH&&a>GPDrawInterface_.MOBILE_MAX_WIDTH||
this.lastViewportWidth>GPDrawInterface_.MOBILE_MAX_WIDTH&&a<=GPDrawInterface_.MOBILE_MAX_WIDTH)this.terminate(),this.init();this.lastViewportWidth=a}initOpacityPanel(a,b,c){const d=document.createElement("input");d.className="gp-opacity-slider_";d.type="range";d.min=a;d.max=1;d.step="0.01";d.value=b;d.addEventListener("change",this.opacityChangeHandler);c.after(d);return d}initExtendedPalettePanel(a){this.currentPaletteName=a;this.currentColorSet=GPDrawInterface_.PALETTES[a];this.isCustomPalette=
"default"!==a;this.paletteKeys=new Set;const b=()=>this.painter.getColor().slice(1);this.palette&&this.palette.remove();this.palette=document.createElement("div");this.palette.className="gp-palette-set_";this.palette.classList.toggle("custom_",this.isCustomPalette);this.palette.toggleAttribute("disabled",this.painter.isDisabled);this.palette.dataset.id=-1;this.renderPaletteColorSet();this.isCustomPalette&&(this.palette.draggable=!0,this.palette.addEventListener("dragstart",this.onPaletteDragStart),
this.palette.addEventListener("dragover",this.onPaletteDragOver),this.palette.addEventListener("dragenter",this.onPaletteDragEnter),this.palette.addEventListener("dragleave",this.onPaletteDragLeave),this.palette.addEventListener("drop",this.onPaletteDrop));this.palette.addEventListener("auxclick",c=>{this.isCustomPalette&&1===c.button&&this.currentColorSet.length&&(this.downloadPalette(),c.preventDefault())});this.palette.addEventListener("pointerdown",c=>{if(0===c.button)if(this.isCustomPalette){const d=
c.target.classList.contains("color_"),e=this.currentColorSet,g=d?this.getColorIndex(c.target):-1;c.shiftKey?(d?(e.splice(g,0,b()),e.length=Math.min(e.length,GPDrawInterface_.MAX_PALETTE_SIZE)):e.length<GPDrawInterface_.MAX_PALETTE_SIZE&&e.push(b()),this.renderPaletteColorSet(),this.saveCustomPalette()):c.ctrlKey?(d?e.splice(g,1):e.length&&e.pop(),this.renderPaletteColorSet(),this.saveCustomPalette()):c.altKey?d&&this.renderPaletteColorSet():d&&this.selectPaletteColor(c.target)}else this.selectPaletteColor(c.target)});
this.palette.addEventListener("wheel",c=>{const d=Object.keys(GPDrawInterface_.PALETTES),e=d.findIndex(g=>g===this.currentPaletteName);if(~e){const g=d.length;c=d[0>c.deltaY?(e+g-1)%g:(e+1)%g]}else c="default";this.painter.setPaletteName(c)});(this.colorPicker?.getElement()||this.nativeColorInput).before(this.palette);this.screen.classList.add("gp-extended-palette-panel_")}renderPaletteColorSet(){const a=this.currentColorSet;a.length=Math.min(a.length,GPDrawInterface_.MAX_PALETTE_SIZE);const [b,c,
d]=this.calculateColorSize(a.length);this.palette.classList.toggle("max-size_",c);this.palette.classList.toggle("empty_",!a.length);this.palette.style.setProperty("--gp-color-size",`${b}px`);this.palette.style.setProperty("--gp-palette-columns-count",`${d}`);this.palette.innerHTML="";a.forEach((e,g)=>{const f=document.createElement("div");f.className="color_";f.dataset.color=`#${e}`;f.style.backgroundColor=`#${e}`;this.isCustomPalette&&(f.draggable=!0,f.dataset.id=g);this.palette.appendChild(f)})}saveCustomPalette(){const {default:a,
...b}=GPDrawInterface_.PALETTES;window.localStorage.setItem(GPDrawInterface_.CUSTOM_COLOR_SET_STORAGE,JSON.stringify(b))}calculateColorSize(a){const b=[3,4,5,6,8];var c=b.map((g,f)=>Math.floor(292/(148/b[f]))*g).findIndex(g=>a<=g),d=~c?c:b.length-1;c=Math.floor((148-3*(b[d]-1))/b[d]);const e=b[d]===b.at(-1);d=~d?b[d]:b.at(-1);return[c,e,d]}getColorIndex(a){return[].indexOf.call(this.palette.children,a)}selectPaletteColor(a){this.painter.setColor(a.dataset.color);this.resetPaletteColor();a.classList.add("selected_")}resetPaletteColor(){if(this.palette){var a=
this.palette.querySelector(".color_.selected_");a&&a.classList.remove("selected_")}}paletteKeyHandler(a){if(this.palette&&!a.repeat){var b=GPDrawInterface_.PALETTE_KEY_STATES;a.key in b&&(a.getModifierState(a.key)?this.paletteKeys.add(a.key):this.paletteKeys.delete(a.key),(a=Object.keys(b).find(c=>this.paletteKeys.has(c)))?this.palette.dataset.state=b[a]:delete this.palette.dataset.state)}}resetKeys(a){this.palette&&(this.paletteKeys.clear(),delete this.palette.dataset.state)}serializePalette(a){return a.join("\n")}downloadPalette(){const {url:a,
filename:b}=this.buildSerializedPalette(),c=document.createElement("a");c.href=a;c.download=b;c.click();URL.revokeObjectURL(this.paletteURL)}buildSerializedPalette(){const a=`gp-palette by ${this.gpproxy.getUser().nick} (${this.getPaletteHash()}).${GPDrawInterface_.PALETTE_FILE_FORMAT}`,b=new Blob([this.serializePalette(this.currentColorSet)]);URL.revokeObjectURL(this.paletteURL);this.paletteURL=URL.createObjectURL(b);return{url:this.paletteURL,filename:a}}getPaletteHash(){let a=0;this.currentColorSet.forEach(b=>
{for(let c=0;c<b.length;c++){const d=b.charCodeAt(c);a=(a<<5)-a+d;a|=0}});return(a+2147483648).toString(36)}onPaletteDragStart(a){if(a.shiftKey||a.ctrlKey||a.altKey||!this.currentColorSet.length)a.altKey&&a.target!==a.currentTarget?(a.dataTransfer.setData(GPDrawInterface_.TYPE_PALETTE_COLOR_ID,a.target.dataset.id),a.dataTransfer.effectAllowed="move"):a.preventDefault();else{const {url:b,filename:c}=this.buildSerializedPalette();a.dataTransfer.setData("DownloadURL",`${GPDrawInterface_.TYPE_PALETTE}:${c}:${b}`);
a.dataTransfer.setDragImage(GPDrawInterface_.DRAG_PALETTE_IMAGE,0,0)}}onPaletteDragOver(a){a.preventDefault();a.dataTransfer.dropEffect="move"}onPaletteDragEnter(a){switch(a.dataTransfer.types[0]){case GPDrawInterface_.TYPE_PALETTE_COLOR_ID:~a.target.dataset.id&&a.target.classList.add("drag-over_");break;case "Files":a.currentTarget.classList.add("drag-over_")}}onPaletteDragLeave(a){a.target.classList.remove("drag-over_")}onPaletteDrop(a){switch(a.dataTransfer.types[0]){case GPDrawInterface_.TYPE_PALETTE_COLOR_ID:var b=
a.dataTransfer.getData(GPDrawInterface_.TYPE_PALETTE_COLOR_ID);if(b===a.target.dataset.id)break;this.moveColor(b,a.target.dataset.id);this.saveCustomPalette();break;case "Files":if(b=Array.from(a.dataTransfer.files).find(this.isPaletteFile)){const c=new FileReader;c.addEventListener("loadend",d=>{try{const e=this.parsePaletteFile(c.result);this.currentColorSet.length=0;this.currentColorSet.push(...e);this.renderPaletteColorSet();this.saveCustomPalette()}catch(e){console.error(e)}});c.readAsText(b)}}a.target.classList.remove("drag-over_");
a.currentTarget.classList.remove("drag-over_");a.preventDefault()}parsePaletteFile(a){const b=[];a=a.split(/\s+/);for(let c=0;c<a.length;c++){const d=(a[c].match(/^#?([0-9A-Fa-f]{6})$/)||[])[1];if(d&&(b.push(d),b.length===GPDrawInterface_.MAX_PALETTE_SIZE))break}return b}isPaletteFile(a){return a.name.toLowerCase().endsWith(`.${GPDrawInterface_.PALETTE_FILE_FORMAT}`)}moveColor(a,b){this.currentColorSet.splice(~b?b:this.currentColorSet.length,0,this.currentColorSet.splice(a,1)[0]);this.renderPaletteColorSet()}initColorPickerPanel(){this.colorPicker?.getElement()&&
this.colorPicker.getElement().remove();this.colorPicker=new GPColorPicker_(144,125);this.colorPicker.setColor(this.painter.color);this.colorPicker.getElement().toggleAttribute("disabled",this.painter.isDisabled);this.colorPicker.addEventListener("color",({detail:{color:a}})=>{this.painter.setColor(a,!0)});this.nativeColorInput.before(this.colorPicker.getElement());this.screen.classList.add("gp-color-picker-panel_")}toggleInterface(a){a?this.enableInterface():this.disableInterface()}disableInterface(){this.painter.disable();
this.toolsContainer.classList.add("disabled");this.colorsContainer.classList.add("disabled");this.optionsContainer.classList.add("disabled");this.opacity.setAttribute("disabled","");this.colorInput.setAttribute("disabled","");this.color2Input.setAttribute("disabled","");this.colorInput.value=this.painter.settings.panelsBackgroundColor;this.color2Input.value=this.painter.settings.panelsBackgroundColor;this.palette&&this.palette.setAttribute("disabled","");this.colorPicker&&this.colorPicker.getElement().setAttribute("disabled",
"");this.updatePanelsBackground(this.painter.settings.panelsBackgroundColor,Math.max(this.painter.settings.panelsBackgroundOpacity-10,0))}enableInterface(){this.painter.enable();this.toolsContainer.classList.remove("disabled");this.colorsContainer.classList.remove("disabled");this.optionsContainer.classList.remove("disabled");this.opacity.removeAttribute("disabled");this.colorInput.removeAttribute("disabled");this.color2Input.removeAttribute("disabled");this.colorInput.value=this.painter.color;this.color2Input.value=
this.painter.color2;this.palette&&this.palette.removeAttribute("disabled");this.colorPicker&&this.colorPicker.getElement().removeAttribute("disabled");this.updatePanelsBackground(this.painter.settings.panelsBackgroundColor,this.painter.settings.panelsBackgroundOpacity)}toggleFixedScreenSize(a){this.screen.classList.toggle("fixed-size_",!!a);this.painter.resizeWindowHandler()}toggleHeaderBackground(a){this.screen.classList.toggle("header-hidden_",!!a)}roundPixelOffset(){this.style.setProperty("--gp-pixel-offset-top",
"0px");this.style.setProperty("--gp-pixel-offset-left","0px");const {top:a,left:b}=window.getComputedStyle(this.screen),c=parseFloat(a)%1,d=parseFloat(b)%1;this.style.setProperty("--gp-pixel-offset-top",`${c}px`);this.style.setProperty("--gp-pixel-offset-left",`${d}px`)}unlockElement(a){a.stopPropagation()}toolsContainerClickHandler(a){if(a.target.classList.contains("tool")){a.stopImmediatePropagation();var b=a.target,c=this.filterToolClasses([...a.target.classList]),d=c[0];a=GPDrawInterface_.TOOLS[d];
if(!a.disabled){if(a.id)this.painter.setTool(a.id);else switch(d){case "hide":c="hideon"===c[1];b.classList.toggle("hideon",!c);this.painter.toggleLastDraw(c);break;case "undo":this.painter.undo();break;case "redo":this.painter.redo()}a.tumbler&&(this.currentTool.classList.remove("sel"),b.classList.add("sel"),this.currentTool=b)}}}filterToolClasses(a){return a.filter(b=>!GPDrawInterface_.FILTER_TOOL_CLASSES.some(c=>b.startsWith(c)))}colorsContainerClickHandler(a){a.target.classList.contains("color")&&
(a.stopPropagation(),this.painter.setColor(a.target.dataset.color))}colorInputInputHandler(a){this.painter.setColor(a.target.value)}colorInputChangeHandler(a){this.painter.setColor(a.target.value)}color2InputChangeHandler(a){this.painter.setColor2(a.target.value)}opacityChangeHandler(a){a.stopImmediatePropagation();this.painter.setOpacity(a.target.value)}thicknessesContainerClickHandler(a){a.stopPropagation();a.target.classList.contains("thickness")&&(a=+a.target.dataset.value,this.painter.setThickness(a),
this.updateThickness(a))}readyBtnClickHandler(a){a.stopPropagation();this.painter.gpproxy.isGameTime(GPProxy_.GAME_TIME.HOSTS_DECISION)&&this.painter.gpproxy.isOwner()&&this.painter.settings.readyConfirmation&&!this.painter.isReadyWarningShown?this.showReadyWarning():(this.painter.timer&&this.painter.gpproxy.isGameTime(GPProxy_.GAME_TIME.HOSTS_DECISION)&&this.painter.gpproxy.isOwner()&&this.painter.timer.reset(),a=!this.painter.gpproxy.isReady(),this.updateReadyBtn(a),this.toggleInterface(!a),this.painter.gpproxy.ready())}showReadyWarning(){this.readyWarning=
document.createElement("div");this.readyWarning.className="ready-warning_";var a=document.createElement("div");a.className="window_";this.readyWarning.appendChild(a);var b=document.createElement("div");b.className="label_";b.textContent="\u0417\u0430\u0432\u0435\u0440\u0448\u0438\u0442\u044c \u0445\u043e\u0434?";a.appendChild(b);b=document.createElement("div");b.className="buttons_";a.appendChild(b);a=document.createElement("div");a.className="ok-btn_ btn_";a.textContent="OK";a.addEventListener("click",
c=>{this.readyWarning.remove();this.painter.isReadyWarningShown=!0;this.readyBtn.click()});b.appendChild(a);a=document.createElement("div");a.className="cancel-btn_ btn_";a.textContent="\u041e\u0442\u043c\u0435\u043d\u0430";a.addEventListener("click",c=>{this.readyWarning.remove()});b.appendChild(a);this.screen.appendChild(this.readyWarning)}saveBtnClickHandler(a){a.stopPropagation();this.painter.saveImage()}settingsBtnHandler(a){this.painter.resetZoom();this.settingsPane.classList.toggle("hidden");
this.screen.classList.toggle("gp-settings-shown_");this.renderSettings(this.painter.getSettings())}symmetryModesClickHandler(a){a=+a.target.dataset.modeId;this.painter.setSymmetryMode(a);this.updateSymmetryGuidesCount(a)}updateSymmetryGuidesCount(a){switch(a){case GPPainter_.SYMMETRY_MODES.RADIAL:this.symmetryGuidesCount.dataset.count=this.painter.getSettings().symmetryRadialGuidesCount;break;case GPPainter_.SYMMETRY_MODES.MANDALA:this.symmetryGuidesCount.dataset.count=this.painter.getSettings().symmetryMandalaGuidesCount}}renderSettingsHandler(a){this.renderSettings(this.painter.getSettings())}renderBindingsHandler(a){this.renderBindings(this.painter.getBindings())}renderSettings(a){this.settingsContent.innerHTML=
"";const b=document.createElement("div");b.className="controls_ gp-scrollbar_";b.addEventListener("scroll",e=>{this.settingsScrollPos=e.target.scrollTop});this.settingsContent.appendChild(b);var c=document.createElement("div");c.className="buttons_";this.settingsContent.appendChild(c);var d=document.createElement("div");d.className="gp-btn_ btn_ restore-btn_";d.textContent=this.l.RESTORE_SETTINGS_BTN_LBL;d.title=this.l.RESTORE_SETTINGS_BTN_TTL;d.addEventListener("click",this.restoreSettings);c.appendChild(d);
d=document.createElement("div");d.className="gp-btn_ btn_ default-btn_";d.textContent=this.l.RESET_SETTINGS_BTN_LBL;d.title=this.l.RESET_SETTINGS_BTN_TTL;d.addEventListener("click",this.resetSettings);c.appendChild(d);c=document.createDocumentFragment();d=this.painter.getUISettings();for(let e in d){const {type:g,args:f,description:h,text:k,inputTrigger:l}=this.painter.getUISetting(e)||{};if(e.startsWith("_")){d=document.createElement("div");d.className="group-label_";d.textContent=k;c.appendChild(d);
continue}if(!g)continue;d=document.createElement("div");d.className="label_";d.title=h;d.textContent=e.split(/(?=[A-Z])/).join(" ");let m=document.createElement("div");m.className="control_";let n;switch(g){case "range":const p=document.createElement("div");p.className="preview_ gp-range-preview_";p.textContent=a[e];const [r,q,z]=f;n=document.createElement("input");n.className="gp-range_";n.type=g;n.min=r;n.max=q;n.step=z;n.value=a[e];n.name=e;n.addEventListener("input",t=>{p.textContent=t.target.value});
m.appendChild(n);m.appendChild(p);break;case "list":n=document.createElement("select");n.className="gp-list_";n.name=e;f.forEach(t=>{const w=document.createElement("option");w.value=t;w.textContent=t;n.appendChild(w)});n.value=a[e];m.appendChild(n);break;case "checkbox":n=document.createElement("div");n.className="gp-tumbler_";const A=document.createElement("input");A.id=`ctrl-${e}_`;A.type="checkbox";A.name=e;A.checked=a[e];n.appendChild(A);const y=document.createElement("label");y.for=`ctrl-${e}_`;
y.addEventListener("click",t=>{A.click()});n.appendChild(y);m.appendChild(n);break;case "color":n=document.createElement("input"),n.className="gp-color_",n.type=g,n.value=a[e],n.name=e,m.appendChild(n)}n.addEventListener(l?"input":"change",p=>{this.dispatchEvent(new CustomEvent("settings_updated",{detail:{settings:{[p.target.name]:this.parseSettingsValue(p.target)}}}))});c.appendChild(d);c.appendChild(m)}b.appendChild(c);this.toggleScrollbar(b);b.scrollTop=this.settingsScrollPos}getInitialSettings(){return Object.assign({},
this.initialSettings)}parseSettingsValue(a){switch(a.type){case "range":return Number.parseFloat(a.value);case "checkbox":return a.checked;default:return a.value}}resetSettings(a){a=this.painter.getDefaultSettings();this.renderSettings(a);this.dispatchEvent(new CustomEvent("settings_updated",{detail:{settings:a}}))}restoreSettings(a){a=this.getInitialSettings();this.renderSettings(a);this.dispatchEvent(new CustomEvent("settings_updated",{detail:{settings:a}}))}renderBindings(a){this.settingsContent.innerHTML=
"";const b=document.createElement("div");b.className="bindings_ gp-scrollbar_";this.settingsContent.appendChild(b);var c=document.createElement("div");c.className="buttons_";this.settingsContent.appendChild(c);var d=document.createElement("div");d.className="reset-btn_ btn_ gp-btn_";d.textContent=this.l.RESET_SETTINGS_BTN_LBL;d.title=this.l.RESET_SETTINGS_BTN_TTL;d.addEventListener("click",this.resetBindings);c.appendChild(d);c=document.createDocumentFragment();for(let e in a){if(!this.painter.tools[e])continue;
d=document.createElement("div");d.className="label_";d.title=this.painter.tools[e].description;d.textContent=e.split(/(?=[A-Z])/).join(" ");c.appendChild(d);const g=document.createElement("div");g.className="keys-bindings_";a[e].length?a[e].forEach((f,h)=>{f=this.renderBindingKeys(e,h,f,g,b);g.appendChild(f)}):(d=this.renderBindingKeys(e,-1,[],g,b),d.classList.add("empty_"),g.appendChild(d));c.appendChild(g)}b.appendChild(c);this.toggleScrollbar(b)}renderBindingKeys(a,b,c,d,e){c=this.formatKeys(c);
const g=document.createElement("div");g.className="keys-binding_";var f=document.createElement("div");f.className="keys_";f.textContent=c;f.dataset.name=a;f.dataset.index=b;f.dataset.initialValue=c;f.addEventListener("click",this.setBindingHandler);g.appendChild(f);c=document.createElement("div");c.className="buttons_";g.appendChild(c);f=document.createElement("div");f.className="add-btn_ btn_ gp-btn_";f.textContent="+";f.addEventListener("click",h=>{h=this.renderBindingKeys(a,-1,[],d,e);d.appendChild(h);
this.toggleScrollbar(e)});c.appendChild(f);f=document.createElement("div");f.className="delete-btn_ btn_ gp-btn_";f.textContent="-";f.addEventListener("click",h=>{this.deleteBinding(a,b,g);this.toggleScrollbar(e)});c.appendChild(f);f=document.createElement("div");f.className="accept-btn_ btn_ gp-btn_";f.textContent="\u2713";f.addEventListener("click",h=>{this.isAcceptedBinding(this.currentKeys,this.pressedKeys)?this.acceptBinding(this.currentBindingElem,this.pressedKeys):this.cancelBinding(this.currentBindingElem)});
c.appendChild(f);return g}deleteBinding(a,b,c){~b?(c=this.painter.getBindings(),c[a].splice(b,1),this.renderBindings(c),this.dispatchEvent(new CustomEvent("bindings_updated",{detail:{bindings:c}}))):c.remove()}setBindingHandler(a){this.currentBindingElem&&this.cancelBinding(this.currentBindingElem);this.painter.setKeysLockState(!0);a=a.target;this.currentKeys=this.painter.getBindingKeys(a.dataset.name,+a.dataset.index);this.pressedKeys=new Set;this.currentBindingElem=a;a.parentElement.classList.add("process_");
a.textContent=this.getPlaceholderKeys();document.addEventListener("keydown",this.keyDownHandler,!0);document.addEventListener("keyup",this.keyUpHandler,!0)}keyDownHandler(a){a.preventDefault();a.stopPropagation();if(!a.repeat){var b=this.currentBindingElem;switch(a.code){case "Escape":this.cancelBinding(b);break;case "Enter":case "NumpadEnter":this.isAcceptedBinding(this.currentKeys,this.pressedKeys)?this.acceptBinding(b,this.pressedKeys):this.cancelBinding(b);break;default:this.pressedKeys.add(a.code),
this.keyHandler(a)}}}keyUpHandler(a){this.pressedKeys.delete(a.code);this.keyHandler(a)}keyHandler(a){a=this.currentBindingElem;a.classList.remove("existed_");if(this.pressedKeys.size){a.textContent=this.formatKeys(this.pressedKeys);const b=this.isSameBindingKeys(this.currentKeys,this.pressedKeys)||this.isBindingExists(this.pressedKeys);a.classList.toggle("existed_",b)}else a.textContent=this.getPlaceholderKeys()}isAcceptedBinding(a,b){return!(0===b.size||this.isSameBindingKeys(a,b)||this.isBindingExists(b))}isBindingExists(a){return this.painter.isBindingExisted(a)}isSameBindingKeys(a,
b){return this.painter.compareBindingsKeys(a,b)}acceptBinding(a,b){b=Array.from(b).map(this.formatKey).join(" + ");a.textContent=b;a.dataset.initialValue=b;this.updateBindingsSettings(a.dataset.name,a.dataset.index);this.endBinding(a)}cancelBinding(a){a.textContent=a.dataset.initialValue;this.endBinding(a)}endBinding(a){this.painter.setKeysLockState(!1);a.parentElement.classList.remove("process_");a.classList.remove("existed_");document.removeEventListener("keydown",this.keyDownHandler,!0);document.removeEventListener("keyup",
this.keyUpHandler,!0);this.currentBindingElem=null}resetBindings(a){a=this.painter.getDefaultBindings();this.renderBindings(a);this.dispatchEvent(new CustomEvent("bindings_updated",{detail:{bindings:a}}))}updateBindingsSettings(a,b){const c=this.painter.getBindings();b=~b?b:c[a].length;c[a][b]=[...this.pressedKeys];this.renderBindings(c);this.dispatchEvent(new CustomEvent("bindings_updated",{detail:{bindings:c}}))}getPlaceholderKeys(){return"\u00a0"}formatKeys(a){return a?Array.from(a).map(this.formatKey).join(" + "):
this.getPlaceholderKeys()}formatKey(a){return a.replace(/^Key/,"").replace(/((?:Left)|(?:Right))$/," ($1)")}toggleScrollbar(a){a.classList.toggle("scrollbar_",a.scrollHeight>a.clientHeight)}updateToolbar(a){this.currentTool.classList.remove("sel");this.currentTool=this.tools[GPDrawInterface_.TOOLS_IDS_CLASSES[a]];this.currentTool.classList.add("sel")}updateColorInput(a){this.colorInput.value=a}updateColor2Input(a){this.color2Input.value=a}updateOpacity(a){this.opacity.value=a}updateThickness(a){a=
this.thicknesses[a];this.currentThickness&&(this.currentThickness.classList.remove("sel"),this.currentThickness=null);a&&(a.classList.add("sel"),this.currentThickness=a)}updateReadyBtn(a){a??this.painter.gpproxy.isReady()?(this.readyIcon.classList.replace("ready","pencil"),this.readyLabel.textContent=this.painter.localization.edit):(this.readyIcon.classList.replace("pencil","ready"),this.readyLabel.textContent=this.painter.localization.ready)}updateColorPicker(a,b){this.colorPicker&&!b&&this.colorPicker.setColor(a)}updateExtendedPalettePanel(a,
b){a?this.initExtendedPalettePanel(b):this.palette&&(this.palette.remove(),this.palette=null,this.screen.classList.remove("gp-extended-palette-panel_"));this.screen.classList.toggle("gp-custom-tools_",!(!this.palette&&!this.colorPicker))}updateColorPickerPanel(a){a?this.initColorPickerPanel():this.colorPicker&&(this.colorPicker.getElement().remove(),this.colorPicker=null,this.screen.classList.remove("gp-color-picker-panel_"));this.screen.classList.toggle("gp-custom-tools_",!(!this.palette&&!this.colorPicker))}updatePanelsBackground(a,
b){const c=parseInt(a.substr(1,2),16),d=parseInt(a.substr(3,2),16),e=parseInt(a.substr(5,2),16);this.style.setProperty("--gp-panels-bg-color",`rgb(${c} ${d} ${e} / ${b}%)`);const [g,f,h]=GPColorUtils_.rgbToHsv(c,d,e),[k,l,m]=GPColorUtils_.hsvToRgb(Math.max(g-.04246122552758713,0),Math.max(f-.012523565849717255,0),Math.max(h-.05882352941176472,0));this.style.setProperty("--gp-panels-elems2-color",`rgb(${k}, ${l}, ${m})`);this.painter.isDisabled&&(this.updateColorInput(a),this.updateColor2Input(a))}updatePanelsElements(a,
b){const c=parseInt(a.substr(1,2),16),d=parseInt(a.substr(3,2),16);a=parseInt(a.substr(5,2),16);this.style.setProperty("--gp-panels-elems-rgb",`${c} ${d} ${a}`);this.style.setProperty("--gp-panels-elems-rgb-opacity",`${b}%`)}updateHeaderPhraseColor(a){this.style.setProperty("--gp-header-phrase-color",a)}updateActionQueueSize(a){this.actionQueueSize.textContent=a||""}setAutoHideHeaderState(a){this.screen.classList.toggle("gp-auto-hide-header_",a)}setAutoHideHeaderDelay(a){this.style.setProperty("--gp-header-auto-hide-delay",
`${a}s`)}updateSymmetryPanel(a){this.screen.classList.toggle("gp-symmetry-panel_",a)}}window.GPDrawInterface_=GPDrawInterface_;class GPReference_ extends EventTarget{static CONTAINER_HEIGHT=698;static CONTAINER_MIN_WIDTH=256;static QUERY_INPUT_HEIGHT=56;static BORDER_SIZE=4;static PREVIEW_MAX_HEIGHT=180;static DEFAULT_COLUMNS_COUNT=4;static RESULTS_COLUMN_MIN_WIDTH=125;static MAX_ZOOM_SENSITIVITY=20;static ALIGNMENT_ICONS={center:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23dee0ed' viewBox='0 0 13 13'%3E%3Crect width='3' height='6' x='2' y='3.5' rx='1'/%3E%3Crect width='3' height='6' x='8' y='3.5' rx='1'/%3E%3Cpath d='M6 1h1v11H6z'/%3E%3C/svg%3E",
"flex-start":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23dee0ed' viewBox='0 0 13 13'%3E%3Crect width='3' height='6' x='6' y='3.5' rx='1'/%3E%3Crect width='3' height='6' x='2' y='3.5' rx='1'/%3E%3Cpath d='M1 1h1v11H1z'/%3E%3C/svg%3E","flex-end":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23dee0ed' viewBox='0 0 13 13'%3E%3Crect width='3' height='6' transform='scale(-1,1)' rx='1' y='3.5' x='-7'/%3E%3Crect width='3' height='6' transform='scale(-1,1)' rx='1' y='3.5' x='-11'/%3E%3Cpath d='m12 1h-1v11h1z'/%3E%3C/svg%3E",
"space-between":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23dee0ed' viewBox='0 0 13 13'%3E%3Crect width='3' height='6' x='8' y='3.5' rx='1'/%3E%3Crect width='3' height='6' x='2' y='3.5' rx='1'/%3E%3Cpath d='M1 1h1v11H1zM11 1h1v11h-1z'/%3E%3C/svg%3E","space-around":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23dee0ed' viewBox='0 0 13 13'%3E%3Crect width='3' height='6' x='7.25' y='3.5' rx='1'/%3E%3Crect width='3' height='6' x='2.75' y='3.5' rx='1'/%3E%3Cpath d='M1 1h1v11H1zM11 1h1v11h-1z'/%3E%3C/svg%3E",
"space-evenly":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23dee0ed' viewBox='0 0 13 13'%3E%3Crect width='3' height='6' x='7' y='3.5' rx='1'/%3E%3Crect width='3' height='6' x='3' y='3.5' rx='1'/%3E%3Cpath d='M1 1h1v11H1zM11 1h1v11h-1z'/%3E%3C/svg%3E"};static URL_PATTERN=/^https?:\/\/\w/;static IMAGE_TYPES=new Set("image/jpeg image/png image/gif image/webp image/svg+xml image/bmp".split(" "));static SEARCH_ENGINES={GOOGLE:"google",PINTEREST:"pinterest",UNSPLASH:"unsplash"};static INTERFACE_ALIGNMENT={CENTER:"center",
RIGHT:"flex-start",LEFT:"flex-end",SPACE_BETWEEN:"space-between",SPACE_AROUND:"space-around",SPACE_EVENLY:"space-evenly"};static DEFAULT_SETTINGS={enabled:!1,searchEngine:this.SEARCH_ENGINES.GOOGLE,interfaceAlignment:this.INTERFACE_ALIGNMENT.CENTER,containerMaxWidth:"none",zoomSensitivity:10,minZoom:1,maxZoom:30};static SETTINGS_UI={interfaceAlignment:{type:"list-i",data:{icons:this.ALIGNMENT_ICONS},description:"\u0412\u044b\u0440\u0430\u0432\u043d\u0438\u0432\u0430\u043d\u0438\u0435 \u043e\u043a\u043e\u043d \u043c\u043e\u0434\u0443\u043b\u0435\u0439 Reference \u0438 Painter \u043e\u0442\u043d\u043e\u0441\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u0434\u0440\u0443\u0433 \u0434\u0440\u0443\u0433\u0430"},
minZoom:{type:"range",args:[.1,1,.1],description:"\u041c\u0438\u043d\u0438\u043c\u0430\u043b\u044c\u043d\u044b\u0439 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u043f\u0440\u0438\u0431\u043b\u0438\u0436\u0435\u043d\u0438\u044f \u0440\u0435\u0444\u0435\u0440\u0435\u043d\u0441\u0430"},maxZoom:{type:"range",args:[2,60,1],description:"\u041c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u044b\u0439 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u043f\u0440\u0438\u0431\u043b\u0438\u0436\u0435\u043d\u0438\u044f \u0440\u0435\u0444\u0435\u0440\u0435\u043d\u0441\u0430"},
zoomSensitivity:{type:"range",args:[1,this.MAX_ZOOM_SENSITIVITY,1,!0],formatter:this.zoomSensitivityFormatter.bind(this),description:"\u0427\u0443\u0432\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c \u043f\u0440\u0438\u0431\u043b\u0438\u0436\u0435\u043d\u0438\u044f \u0440\u0435\u0444\u0435\u0440\u0435\u043d\u0441\u0430"}};static zoomSensitivityFormatter(a){return this.MAX_ZOOM_SENSITIVITY-(a-1)}static MODULE={title:"Reference",settings:{storage:"gp_reference",defaultSettings:this.DEFAULT_SETTINGS,
ui:this.SETTINGS_UI}};static INIT(a){a.reference=new GPReference_(a.gpproxy,a.sm)}constructor(a,b){super();this.gpproxy=a;this.s=b.setSettings(this,this.updateSettings);this.history=new Map;this.searchData=this.pendingSearch=this.pendingImage=this.lastQuery=null;this.isRefOpened=this.isLastPage=!1;this.scrollPos=0;this.resizeStartX;this.resizeInitialWidth;this.resizeTimer;this.isReRenderNeeded=this.isResizing=!1;this.columns=[];this.columnsCount=GPReference_.DEFAULT_COLUMNS_COUNT;this.lastColumnsCount=
null;this.downloadImage=this.downloadImage.bind(this);this.onScroll=this.onScroll.bind(this);this.openImage=this.openImage.bind(this);this.closeImage=this.closeImage.bind(this);this.onImageWheel=this.onImageWheel.bind(this);this.onImageDown=this.onImageDown.bind(this);this.onImageMove=this.onImageMove.bind(this);this.onImageDblClick=this.onImageDblClick.bind(this);this.resizeDown=this.resizeDown.bind(this);this.resizeMove=this.resizeMove.bind(this);this.resizeUp=this.resizeUp.bind(this);this.resizeDblClick=
this.resizeDblClick.bind(this);this.handleResizeWindow=this.handleResizeWindow.bind(this);this.onResize=this.onResize.bind(this);document.addEventListener("_ref_progress",({detail:{percentage:c}})=>{this.updateProgress(c)});document.addEventListener("_ref_results",({detail:{images:c,isLastPage:d,isFirstPage:e,searchEngine:g,query:f}})=>{g===this.pendingSearch&&(this.searchData=e?c:[...this.searchData,...c],this.pendingSearch=null,this.isLastPage=d,this.renderImages({images:c,isFirstPage:e,query:f}),
this.hideProgress(),this.closeImage())});document.addEventListener("_ref_complete",({detail:{base64:c,width:d,height:e,url:g,query:f,type:h,isFromHistory:k}})=>{g===this.pendingImage&&(k||this.addToHistory(g,d,e,f),this.pendingImage=null,this.showPreview(c,d,e,{query:f,type:h,url:g}),this.hideProgress())});document.addEventListener("_ref_complete",()=>{this.historyBtn.removeAttribute("hidden")},{once:!0});document.addEventListener("_ref_error",({detail:{type:c,previewURL:d,width:e,height:g,query:f,
isFromHistory:h}})=>{"search"===c?this.pendingSearch=null:"image"===c&&d?this.downloadImage(d,e,g,f,null,h):(this.pendingImage=null,this.hideProgress())});this.gpproxy.addEventListener("turn_started",c=>{this.container&&(this.isLastPage=this.isRefOpened=!1,this.lastQuery=this.lastColumnsCount=null,this.queryInput.value="",this.scrollPos=0,this.searchData=null,this.results.innerHTML="",delete this.results.dataset.query)});this.createPainterBtn()}toggle(a){this.s.enabled=a??!document.getElementById("__next")?.classList.contains("gp-reference-rendered_");
this.s.enabled?this.enable():this.disable()}enable(){document.getElementById("__next").classList.add("gp-reference-rendered_");setTimeout(this.calculateColumnsCount.bind(this),1E3);this.dispatchEvent(new CustomEvent("state_changed",{detail:{isEnabled:!0}}))}disable(){document.getElementById("__next").classList.remove("gp-reference-rendered_");this.dispatchEvent(new CustomEvent("state_changed",{detail:{isEnabled:!1}}))}init(){this.container||this.render();window.addEventListener("resize",this.handleResizeWindow);
this.screen=document.querySelector("#content > .screen");this.screen.before(this.container);this.s.enabled?this.enable():this.disable()}terminate(){this.container&&(this.pendingSearch=this.pendingImage=null,this.isReRenderNeeded=this.isResizing=!1,this.container.remove(),this.container.classList.remove("image-opened_"),this.zoomer.reset(),window.removeEventListener("resize",this.handleResizeWindow),this.disable())}render(){this.container=document.createElement("div");this.container.className="gp-reference_";
this.style=this.container.style;this.style.setProperty("--gp-ref-max-width",`${this.s.containerMaxWidth}`);this.style.setProperty("--gp-ref-column-flex",`${Math.floor(100/this.columnsCount)}%`);document.documentElement.style.setProperty("--gp-ref-alignment",`${this.s.interfaceAlignment}`);var a=this.container;a.addEventListener("dropenter",()=>{},!0);a.addEventListener("dropleave",()=>{},!0);a.addEventListener("drop",async c=>{c.preventDefault();let d;c.dataTransfer.items&&"file"===c.dataTransfer.items[0].kind?
d=c.dataTransfer.items[0].getAsFile():c.dataTransfer.files.length&&(d=c.dataTransfer.files[0]);if(d&&GPReference_.IMAGE_TYPES.has(d.type)){const e=new FileReader;e.addEventListener("loadend",g=>{this.showPreview(e.result,0,0,{query:"file",type:d.type})});e.readAsDataURL(d)}},!0);a.addEventListener("dragover",c=>{c.preventDefault();c.dataTransfer.dropEffect="move"},!0);a=document.createElement("div");a.className="wrapper_";this.container.appendChild(a);var b=document.createElement("div");b.className=
"header_";b.addEventListener("animationend",c=>{"gp-ref-fade-out_"===c.animationName&&this.style.setProperty("--gp-ref-progress","0%")});b.addEventListener("pointerleave",c=>{this.historyList.classList.remove("shown_")});a.appendChild(b);this.queryInput=document.createElement("input");this.queryInput.className="query_";this.queryInput.autocomplete="off";this.queryInput.addEventListener("keydown",c=>{if("Enter"===c.key){const d=c.target.value.trim();GPReference_.URL_PATTERN.test(d)?this.openImageURL(d):
d&&d!==this.lastQuery&&(this.lastQuery=d,this.searchImages(d,!1));c.target.blur()}else"Escape"===c.key&&c.target.blur()});this.queryInput.addEventListener("focus",c=>{c.target.select();document.dispatchEvent(new CustomEvent("_keys_lock",{detail:{state:!0}}));document.addEventListener("pointerdown",d=>{d.target!==this.queryInput&&this.queryInput.blur()},{once:!0,capture:!0})});this.queryInput.addEventListener("blur",c=>{window.getSelection().removeAllRanges();document.dispatchEvent(new CustomEvent("_keys_lock",
{detail:{state:!1}}))});b.appendChild(this.queryInput);this.historyBtn=document.createElement("div");this.historyBtn.className="history-btn_";this.historyBtn.setAttribute("hidden","");this.historyBtn.addEventListener("pointerdown",c=>{0===c.button&&this.history.size&&(this.historyList.classList.toggle("shown_"),this.historyList.scrollTop=0)});b.appendChild(this.historyBtn);this.historyList=document.createElement("div");this.historyList.className="history-list_";this.historyList.addEventListener("pointerup",
c=>{if(c=c.target.closest(".history-item_")){var {url:d,width:e,height:g,query:f}=c.dataset;this.downloadImage(d,e,g,f,null,!0);this.historyList.classList.remove("shown_")}});b.appendChild(this.historyList);this.searchEnginesMenu=document.createElement("div");this.searchEnginesMenu.className="search-engines-menu_";b.appendChild(this.searchEnginesMenu);this.searchEngines=document.createElement("div");this.searchEngines.className="search-engines_";this.searchEngines.addEventListener("pointerdown",c=>
{0===c.button&&(this.searchEngines.classList.contains("shown_")?c.target===this.searchEngines&&this.searchEngines.classList.remove("shown_"):this.searchEngines.classList.add("shown_"))});this.searchEngines.addEventListener("click",c=>{c.target.matches(".search-engine_.selected_")&&this.searchEngines.classList.remove("shown_")});this.searchEngines.addEventListener("pointerup",c=>{if(c.target.classList.contains("search-engine_")){var d=c.target.dataset.searchEngine;if(d!==this.s.searchEngine){this.s.searchEngine=
d;const e=this.queryInput.value.trim();this.searchByEngine(e,d);Array.from(this.searchEngines.children).forEach(g=>{g.style.order=+(g!==c.target)});this.searchEngines.classList.remove("shown_");this.searchEngines.title=c.target.title}}});Object.values(GPReference_.SEARCH_ENGINES).forEach(c=>{const d=document.createElement("div");d.className=`search-engine_ ${c}_`;d.title=c[0].toUpperCase()+c.slice(1);d.dataset.searchEngine=c;this.searchEngines.appendChild(d)});b=this.searchEngines.querySelector(`[data-search-engine="${this.s.searchEngine}"]`);
b.classList.add("selected_");this.searchEngines.title=b.title;this.searchEnginesMenu.appendChild(this.searchEngines);Array.from(this.searchEngines.children).forEach(c=>{c.style.order=+(c.dataset.searchEngine!==this.s.searchEngine)});this.results=document.createElement("div");this.results.className="results_";this.results.addEventListener("click",this.openImage);this.results.addEventListener("scroll",this.onScroll);this.results.addEventListener("contextmenu",this.blockContextMenu);a.appendChild(this.results);
this.imageObserver=new IntersectionObserver(c=>{c.forEach(d=>{const e=d.target;d.isIntersecting&&(e.src=e.dataset.src,this.imageObserver.unobserve(e))})},{root:this.results});this.imageWrapper=document.createElement("div");this.imageWrapper.className="image-wrapper_";this.imageWrapper.addEventListener("wheel",this.onImageWheel);this.imageWrapper.addEventListener("pointerdown",this.onImageDown);this.imageWrapper.addEventListener("dblclick",this.onImageDblClick);this.imageWrapper.addEventListener("contextmenu",
this.blockContextMenu);a.appendChild(this.imageWrapper);this.image=document.createElement("div");this.image.className="image_";this.imageWrapper.appendChild(this.image);this.zoomer=window.renderer({minScale:this.s.minZoom,maxScale:this.s.maxZoom,element:this.image,defaultScaleSensitivity:this.s.zoomSensitivity});b=document.createElement("div");b.className="resizer_ left_";b.dataset.dir="left";b.addEventListener("pointerdown",this.resizeDown);b.addEventListener("pointerup",this.resizeUp);b.addEventListener("dblclick",
this.resizeDblClick);a.appendChild(b);b=document.createElement("div");b.className="resizer_ right_";b.dataset.dir="right";b.addEventListener("pointerdown",this.resizeDown);b.addEventListener("pointerup",this.resizeUp);b.addEventListener("dblclick",this.resizeDblClick);a.appendChild(b)}createPainterBtn(){this.painterBtn=document.createElement("div");this.painterBtn.className="gp-reference-btn_";this.painterBtn.addEventListener("click",()=>{this.toggle()})}searchByEngine(a,b){a&&(this.lastQuery=a,this.searchImages(a,
!1));(a=this.searchEngines.querySelector(".selected_"))&&a.classList.remove("selected_");this.searchEngines.querySelector(`[data-search-engine=${b}]`).classList.add("selected_")}searchImages(a,b){a&&(this.pendingImage=null,this.pendingSearch=this.s.searchEngine,document.dispatchEvent(new CustomEvent("_ref_search",{detail:{searchEngine:this.s.searchEngine,next:!!b,query:a}})),this.container.classList.remove("complete_"))}renderImages({images:a,isFirstPage:b,query:c,scrollPos:d}){if(a?.length){var e=
Array(this.columnsCount).fill(0),g=Array(this.columnsCount).fill().map(()=>document.createDocumentFragment());if(b)for(this.results.innerHTML="",this.results.scrollTop=0,this.results.dataset.query=c,this.columns=[],b=0;b<this.columnsCount;b++){const f=document.createElement("div");f.className="column_";f.dataset.index=`${b}`;this.columns[b]=f;this.results.appendChild(f)}else e.map((f,h)=>+this.columns[h].dataset.height);a.forEach(f=>{var h=f.image.width/f.image.height;const k=document.createElement("div");
k.className="preview_";k.style.backgroundColor=f.dominantColor;k.dataset.url=f.image.url;k.dataset.previewURL=f.preview.url;k.dataset.width=f.image.width;k.dataset.height=f.image.height;k.dataset.aspectRatio=h;const l=new Image;l.width=h*GPReference_.PREVIEW_MAX_HEIGHT;l.height=GPReference_.PREVIEW_MAX_HEIGHT;l.dataset.src=f.preview.url;k.appendChild(l);this.imageObserver.observe(l);h=this.getMinHeightColumnIndex(e);g[h].appendChild(k);e[h]+=f.image.height/f.image.width});this.columns.forEach((f,
h)=>{f.dataset.height=e[h];f.appendChild(g[h])});a=!!this.results.getBoundingClientRect().height;void 0!==d&&setTimeout(()=>{this.results.scrollTop=d},a?0:500);a&&setTimeout(()=>{this.isNextPageNeeded()&&this.searchImages(c,!0)},a?0:500)}}getMinHeightColumnIndex(a){return a.reduce((b,c,d,e)=>c<e[b]?d:b,0)}isNextPageNeeded(){return!this.isLastPage&&!this.pendingSearch&&this.columns.some(a=>{const b=this.results.scrollTop,c=this.results.getBoundingClientRect().height;a=a.getBoundingClientRect().height;
return b+c>=a})}calculateColumnsCount(a){a=a||this.results.getBoundingClientRect().width||this.imageWrapper.getBoundingClientRect().width;this.columnsCount=Math.floor(a/GPReference_.RESULTS_COLUMN_MIN_WIDTH);this.style.setProperty("--gp-ref-column-flex",`${Math.floor(100/this.columnsCount)}%`)}onScroll(){!this.isResizing&&this.isNextPageNeeded()&&this.searchImages(this.lastQuery,!0);this.scrollPos=this.results.scrollTop}updateProgress(a){this.container.classList.toggle("progress_",!~a);this.style.setProperty("--gp-ref-progress",
`${a}%`)}hideProgress(){this.container.classList.remove("progress_");this.container.classList.add("complete_")}downloadImage(a,b,c,d,e,g){this.pendingImage=a;document.dispatchEvent(new CustomEvent("_ref_image",{detail:{searchEngine:this.s.searchEngine,url:a,width:b,height:c,query:d,previewURL:e,isFromHistory:g}}));this.container.classList.remove("complete_")}async showPreview(a,b,c,{query:d,type:e,url:g}){b&&c||([b,c]=await this.getImageDimensions(a));this.image.metadata={base64:a,query:d,type:e,
url:g};this.image.style.backgroundImage=`url(${a})`;this.image.style.aspectRatio=`${b} / ${c}`;this.container.classList.add("image-opened_");(a=this.history.get(g)?.pos)?this.zoomer.setState(a):this.zoomer.reset();this.isRefOpened=!0}async getImageDimensions(a){return new Promise((b,c)=>{const d=new Image;d.onload=()=>{b([d.naturalWidth,d.naturalHeight])};d.onerror=c;d.src=a})}onImageDown(a){switch(a.button){case 0:a.ctrlKey?this.saveImage():(a.target.setPointerCapture(a.pointerId),a.target.addEventListener("pointermove",
this.onImageMove),a.target.addEventListener("pointerup",b=>{b.target.removeEventListener("pointermove",this.onImageMove);this.updateHistoryState()},{once:!0}));break;case 1:this.zoomer.reset();this.updateHistoryState();break;case 2:this.closeImage()}a.preventDefault()}onImageMove(a){this.zoomer.panBy({originX:a.movementX,originY:a.movementY})}onImageDblClick(a){this.zoomer.reset();this.updateHistoryState()}onImageWheel(a){a.preventDefault();this.zoomer.zoom({deltaScale:-Math.sign(a.deltaY),x:a.pageX-
window.scrollX,y:a.pageY-window.scrollY,scaleSensitivity:this.s.zoomSensitivity});1===this.zoomer.getMinScale()&&1>=this.zoomer.getScale()&&this.zoomer.reset();this.updateHistoryState()}openImageURL(a){this.downloadImage(a,0,0,"url",null,null)}openImage(a){if(a.target.classList.contains("preview_")){var {url:b,width:c,height:d,previewURL:e}=a.target.dataset;this.downloadImage(b,c,d,this.results.dataset.query,e,null)}}closeImage(a){this.results.dataset.query&&(this.isRefOpened=!1,this.zoomer.reset(),
this.container.classList.remove("image-opened_"),this.isReRenderNeeded&&(this.calculateColumnsCount(),this.renderImages({images:this.searchData,isFirstPage:!0,query:this.results.dataset.query})))}saveImage(){const {base64:a,query:b,type:c}=this.image.metadata,d=c.split("/")[1].split("+")[0],e=document.createElement("a");e.href=a;e.download=`${b}.${d}`;e.click()}addToHistory(a,b,c,d){this.history.delete(a);this.history.set(a,{width:b,height:c,query:d});this.renderHistory()}updateHistoryState(){const a=
this.history.get(this.image.metadata.url);a&&(a.pos=this.zoomer.getState())}renderHistory(){this.historyList.innerHTML="";const a=document.createDocumentFragment();Array.from(this.history).reverse().forEach(([b,{width:c,height:d,query:e}],g)=>{const f=document.createElement("div");f.className="history-item_";f.dataset.url=b;f.dataset.width=c;f.dataset.height=d;f.dataset.query=e;b=document.createElement("div");b.className="index_";b.textContent=`${this.history.size-g}.`;f.appendChild(b);g=document.createElement("div");
g.className="label_";g.textContent=e;f.appendChild(g);a.appendChild(f)});this.historyList.appendChild(a)}blockContextMenu(a){a.preventDefault()}resizeDown(a){a.target.setPointerCapture(a.pointerId);this.resizeStartX=a.pageX;this.resizeInitialWidth=this.getContainerWidth();this.lastColumnsCount=this.columnsCount;a.target.addEventListener("pointermove",this.resizeMove);this.isResizing=!0}resizeMove(a){const b=a.pageX-this.resizeStartX;this.style.setProperty("--gp-ref-max-width",`${Math.max(this.resizeInitialWidth+
2*("left"===a.target.dataset.dir?-b:b),GPReference_.CONTAINER_MIN_WIDTH)}px`);this.isRefOpened?this.isReRenderNeeded=!0:this.calculateColumnsCount()}resizeUp(a){var b=this.getContainerWidth();if(b!==this.resizeInitialWidth){this.style.setProperty("--gp-ref-max-width","none");const c=this.getContainerWidth();b=b<c?`${b}px`:"none";this.s.containerMaxWidth=b;this.style.setProperty("--gp-ref-max-width",b)}a.target.removeEventListener("pointermove",this.resizeMove);this.isResizing=!1;!this.isRefOpened&&
this.searchData&&this.columnsCount!==this.lastColumnsCount&&this.renderImages({images:this.searchData,isFirstPage:!0,query:this.results.dataset.query})}resizeDblClick(a){a="none"===window.getComputedStyle(this.container).maxWidth?`${GPReference_.CONTAINER_MIN_WIDTH}px`:"none";this.s.containerMaxWidth=a;this.style.setProperty("--gp-ref-max-width",a);this.isRefOpened?this.isReRenderNeeded=!0:(this.calculateColumnsCount(),this.renderImages({images:this.searchData,isFirstPage:!0,query:this.results.dataset.query}))}getContainerWidth(){return this.container.getBoundingClientRect().width-
2*GPReference_.BORDER_SIZE}handleResizeWindow(a){clearTimeout(this.resizeTimer);this.resizeTimer=setTimeout(this.onResize,250)}onResize(){this.isRefOpened?this.isReRenderNeeded=!0:(this.calculateColumnsCount(),this.renderImages({images:this.searchData,isFirstPage:!0,query:this.results.dataset.query}))}isEnabled(){return this.s.enabled}getPainterButton(){return this.painterBtn}updateSettings({detail:{settings:a}}){"interfaceAlignment"in a&&document.documentElement.style.setProperty("--gp-ref-alignment",
`${a.interfaceAlignment}`);this.container&&("minZoom"in a&&this.zoomer.setMinScale(a.minZoom),"maxZoom"in a&&this.zoomer.setMaxScale(a.maxZoom))}}window.GPReference_=GPReference_;class GPPlayersManager_ extends EventTarget{static DISPLAY_MODE={NORMAL:"normal",EXPANDED:"expanded",FULLSCREEN:"fullscreen"};static PREVIEW_PANEL_PATHS=["write","memory"];static DEFAULT_SETTINGS={autoplay:!0,openPlayerWithDoubleClick:!1,defaultDisplayMode:this.DISPLAY_MODE.NORMAL};static SETTINGS_UI={autoplay:{type:"checkbox",description:"\u0410\u0432\u0442\u043e\u0432\u043e\u0441\u043f\u0440\u043e\u0438\u0437\u0432\u0435\u0434\u0435\u043d\u0438\u0435 \u043f\u0440\u043e\u0446\u0435\u0441\u0441\u0430 \u0440\u0438\u0441\u043e\u0432\u0430\u043d\u0438\u044f \u0441\u0440\u0430\u0437\u0443 \u043f\u043e\u0441\u043b\u0435 \u043e\u0442\u043a\u0440\u044b\u0442\u0438\u044f \u043f\u043b\u0435\u0435\u0440\u0430 \u0432 \u0430\u043b\u044c\u0431\u043e\u043c\u0435"},
openPlayerWithDoubleClick:{type:"checkbox",description:"\u041e\u0442\u043a\u0440\u044b\u0432\u0430\u0442\u044c \u043f\u043b\u0435\u0435\u0440 \u0441 \u043f\u043e\u043c\u043e\u0449\u044c\u044e \u0434\u0432\u043e\u0439\u043d\u043e\u0433\u043e \u043a\u043b\u0438\u043a\u0430 \u043f\u043e \u0440\u0438\u0441\u0443\u043d\u043a\u0443 \u0432 \u0430\u043b\u044c\u0431\u043e\u043c\u0435"},defaultDisplayMode:{type:"list",args:Object.values(this.DISPLAY_MODE),description:"\u0420\u0435\u0436\u0438\u043c \u043e\u0442\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u043e\u043a\u043d\u0430 \u043f\u043b\u0435\u0435\u0440\u0430 \u043f\u0440\u0438 \u043e\u0442\u043a\u0440\u044b\u0442\u0438\u0438 \u0432 \u0430\u043b\u044c\u0431\u043e\u043c\u0435"}};static MODULE={title:"Timelapse Player",
dependencies:["GPTimelapsePlayer_"],settings:{storage:"gp_timelapse-player",defaultSettings:this.DEFAULT_SETTINGS,ui:this.SETTINGS_UI}};static INIT(a){new GPPlayersManager_(a.gpproxy,a.sm)}constructor(a,b){super();this.gpproxy=a;this.s=b.setSettings(this);this.currentPath=null;this.onAlbumMiddleClick=this.onAlbumMiddleClick.bind(this);this.onAlbumDoubleClick=this.onAlbumDoubleClick.bind(this);this.onImageMiddleClick=this.onImageMiddleClick.bind(this);this.onImageDoubleClick=this.onImageDoubleClick.bind(this);
document.addEventListener("_url_changed",({detail:{path:c}})=>{this.currentPath=c.slice(1)});this.gpproxy.addEventListener("data",({detail:{event:c}})=>{c===GPProxy_.EVENT.TURN_STARTED?this.closePlayers():c===GPProxy_.EVENT.GAME_STARTED?(document.addEventListener("pointerdown",this.onImageMiddleClick),document.addEventListener("dblclick",this.onImageDoubleClick)):[GPProxy_.EVENT.ALBUM_INFO,GPProxy_.EVENT.NEW_GAME,GPProxy_.EVENT.ALBUM_SCORE,GPProxy_.EVENT.GAME_QUIT].includes(c)?(this.closePlayers(),
c!==GPProxy_.EVENT.ALBUM_INFO&&(document.removeEventListener("pointerdown",this.onAlbumMiddleClick),document.removeEventListener("dblclick",this.onAlbumDoubleClick))):c===GPProxy_.EVENT.GALLERY_SETTINGS&&(document.addEventListener("pointerdown",this.onAlbumMiddleClick),document.addEventListener("dblclick",this.onAlbumDoubleClick),document.removeEventListener("pointerdown",this.onImageMiddleClick),document.removeEventListener("dblclick",this.onImageDoubleClick))});this.gpproxy.addEventListener("album_rejoin",
()=>{document.addEventListener("pointerdown",this.onAlbumMiddleClick);document.addEventListener("dblclick",this.onAlbumDoubleClick)});this.gpproxy.addEventListener("game_rejoin",()=>{document.addEventListener("pointerdown",this.onImageMiddleClick);document.addEventListener("dblclick",this.onImageDoubleClick)})}onImageMiddleClick(a){1===a.button&&this.handleImageClick(a)}onImageDoubleClick(a){0===a.button&&this.s.openPlayerWithDoubleClick&&this.handleImageClick(a)}handleImageClick(a){if(this.isPreviewPanelShown()&&
"CANVAS"===a.target.tagName&&a.target.parentElement.parentElement.classList.contains("core")){const b={data:this.gpproxy.getPrevImageData(),meta:{author:"",title:"",date:Date.now()}};a=a.target.parentElement.parentElement;const c=document.querySelector(".screen");a.isPlayerRendered||this.renderPlayer(b,a,c,GPTimelapsePlayer_.DISPLAY_MODE.NORMAL,!1,!0)}}isPreviewPanelShown(){return GPPlayersManager_.PREVIEW_PANEL_PATHS.includes(this.currentPath)}onAlbumMiddleClick(a){1===a.button&&this.handleAlbumClick(a)}onAlbumDoubleClick(a){0===
a.button&&this.s.openPlayerWithDoubleClick&&this.handleAlbumClick(a)}handleAlbumClick(a){if("CANVAS"===a.target.tagName&&!a.target.parentElement.classList.contains("animation")){var b=a.target.closest(".item");if(b){a=[...b.parentElement.children].filter(d=>d.classList.contains("item")).indexOf(b);a=this.gpproxy.getAlbumItem(a);b=b.querySelector(".balloon");var c=document.querySelector(".screen");b.isPlayerRendered||this.renderPlayer(a,b,c)}}}renderPlayer(a,b,c,d,e,g){const f=new GPTimelapsePlayer_({image:a,
container:b,mainContainer:c},d||this.s.defaultDisplayMode,g);(e??this.s.autoplay)&&f.addEventListener("data-loaded",()=>{f.play()})}closePlayers(){GPTimelapsePlayer_.closeAll()}}window.GPPlayersManager_=GPPlayersManager_;class GPTimelapsePlayer_ extends EventTarget{static players=new Set;static CACHE_ENABLE=!0;static CACHE_INTERVAL=1E3;static ORIGINAL_WIDTH=758;static ORIGINAL_HEIGHT=424;static DENSITY=1;static WIDTH=this.ORIGINAL_WIDTH*this.DENSITY;static HEIGHT=this.ORIGINAL_HEIGHT*this.DENSITY;static BACKGROUND_COLOR="#FFFFFF";static STROKE_OFFSET=3;static SPEEDS=[[1,1],[5,1],[15,1],[30,1],[50,1],[0,1],[0,2],[0,4],[0,8],[0,16],[0,32]];static SPEED=0;static SPEED_SLIDER_WIDTH=130;static SPEED_SLIDER_HEIGHT=16;static SPEED_SLIDER_THUMB_WIDTH=14;static M_STROKE_OFFSET=67;static DISPLAY_MODE={NORMAL:"normal",
EXPANDED:"expanded",FULLSCREEN:"fullscreen"};static DEFAULT_DISPLAY_MODE=GPTimelapsePlayer_.DISPLAY_MODE.NORMAL;static FV2_DATE=1681366233E3;constructor({image:{data:a,background:b,auth:c,meta:{author:d,title:e,date:g}},container:f,mainContainer:h},k=GPTimelapsePlayer_.DEFAULT_DISPLAY_MODE,l=!1){super();GPTimelapsePlayer_.players.add(this);this.density=GPTimelapsePlayer_.DENSITY;this.width=GPTimelapsePlayer_.WIDTH;this.height=GPTimelapsePlayer_.HEIGHT;this.originalData=a.slice();const [m,n]=this.handleDelimiters(a,
b);this.data=m;this.background=n;this.auth=c;this.author=d;this.title=e;this.date=new Date(g);this.fi=g&&this.date.getTime()>GPTimelapsePlayer_.FV2_DATE?5:4;this.container=f;this.container.isPlayerRendered=!0;this.mainContainer=h;this.defaultDisplayMode=k;this.defaultDisplayModeDensity=this.getModeDensity(k);this.cache;this.canvas;this.ctx;this.isPlaying=!1;this.currentSpeed=JSON.parse(window.localStorage.getItem("gp-timelapse-player-speed"))||GPTimelapsePlayer_.SPEED;this.speed=GPTimelapsePlayer_.SPEEDS[this.currentSpeed];
this.sPos=this.pos=0;this.lastContainerDimension={width:0,height:0};this.isContextLayoutShown=this.isFullscreen=this.isExpanded=!1;this.isContextMenuDisabled=l;this.progressBarPointerMoveHandler=this.progressBarPointerMoveHandler.bind(this);this.resizeHandler=this.resizeHandler.bind(this);this.toggleFullscreen=this.toggleFullscreen.bind(this);this.playPause=this.playPause.bind(this);this.drawing=this.drawing.bind(this);this.expand=this.expand.bind(this);this.terminate=this.terminate.bind(this);this.toggleContextLayout=
this.toggleContextLayout.bind(this);this.saveImage=this.saveImage.bind(this);this.speedViewPointerMoveHandler=this.speedViewPointerMoveHandler.bind(this);window.addEventListener("resize",this.resizeHandler);this.addEventListener("cache-updated",this.updateCacheHandler);this.initData();this.initCacheWorker()}static closeAll(){GPTimelapsePlayer_.players.forEach(a=>{a.terminate()})}updateCacheHandler({detail:{density:a}}){if(a===this.defaultDisplayModeDensity){this.render();switch(this.defaultDisplayMode){case GPTimelapsePlayer_.DISPLAY_MODE.EXPANDED:this.expand(!0);
break;case GPTimelapsePlayer_.DISPLAY_MODE.FULLSCREEN:this.player.requestFullscreen()}this.seek(this.data.length);this.dispatchEvent(new Event("image-rendered"));this.dispatchEvent(new CustomEvent("data-loaded",{detail:{author:this.author,title:this.title,date:this.date.toISOString()}}));this.removeEventListener("cache-updated",this.updateCacheHandler)}}getModeDensity(a){switch(a){case GPTimelapsePlayer_.DISPLAY_MODE.NORMAL:const {width:b,height:c}=getComputedStyle(this.container);return this.getDensityByDimensions(parseInt(b),
parseInt(c)).density;case GPTimelapsePlayer_.DISPLAY_MODE.EXPANDED:const {width:d,height:e}=getComputedStyle(this.mainContainer);return this.getDensityByDimensions(parseInt(d),parseInt(e)).density;case GPTimelapsePlayer_.DISPLAY_MODE.FULLSCREEN:return this.getDensityByDimensions(window.screen.width,window.screen.height).density}}terminate(){this.pause();this.worker.terminate();this.cache=this.originalData=this.data=null;this.player.remove();this.container.isPlayerRendered=!1;this.container=null;this.speedInput&&
this.speedInput.remove();window.removeEventListener("resize",this.resizeHandler);GPTimelapsePlayer_.players.delete(this);this.dispatchEvent(new Event("terminated"))}initData(){const a=[];for(let b=0;b<this.data.length;b++)this.data[b].index=b,this.isMStroke(this.data[b])&&a.push(b);a.reverse().forEach(b=>{this.data.splice(b,1)})}isMStroke(a){return!(1===a[0]&&a[3][0]>GPTimelapsePlayer_.ORIGINAL_WIDTH&&a[3][1]>GPTimelapsePlayer_.ORIGINAL_HEIGHT)||a[3][0]-GPTimelapsePlayer_.ORIGINAL_WIDTH-GPTimelapsePlayer_.M_STROKE_OFFSET||
a.at(-1)[1]-GPTimelapsePlayer_.ORIGINAL_HEIGHT-GPTimelapsePlayer_.M_STROKE_OFFSET?!1:!0}render(){this.player=document.createElement("div");this.player.className="timelapse-player_";this.player.addEventListener("click",e=>{e.stopPropagation()});this.player.addEventListener("pointerdown",e=>{e.stopPropagation()});this.player.addEventListener("pointerup",e=>{e.stopPropagation()});this.player.addEventListener("mouseup",e=>{e.stopPropagation()});this.player.addEventListener("mousedown",e=>{e.preventDefault();
e.stopPropagation();1===e.button&&(this.isFullscreen?this.toggleFullscreen():this.expand())},!0);this.player.addEventListener("contextmenu",e=>{e.stopPropagation();e.preventDefault();this.toggleContextLayout()});this.player.addEventListener("fullscreenchange",e=>{this.isFullscreen=!!document.fullscreenElement;this.player.classList.toggle("fullscreen_",this.isFullscreen);this.mainContainer.classList.toggle("gp-tp-fullscreen_",this.isFullscreen);this.resizeHandler()});this.bgCanvas=document.createElement("canvas");
this.bgCanvas.className="background-canvas_";this.bgCanvas.width=this.width;this.bgCanvas.height=this.height;this.player.appendChild(this.bgCanvas);this.bgCtx=this.bgCanvas.getContext("2d");this.bgCtx.fillStyle=GPTimelapsePlayer_.BACKGROUND_COLOR;this.bgCtx.fillRect(0,0,this.bgCanvas.width,this.bgCanvas.height);this.background&&this.drawFunction(this.bgCtx,this.background,this.density,!1);this.canvas=document.createElement("canvas");this.canvas.className="canvas_";this.canvas.width=this.width;this.canvas.height=
this.height;this.player.appendChild(this.canvas);this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0});this.strokeCanvas=document.createElement("canvas");this.strokeCanvas.className="stroke-canvas_";this.strokeCanvas.width=this.width;this.strokeCanvas.height=this.height;this.player.appendChild(this.strokeCanvas);this.strokeCtx=this.strokeCanvas.getContext("2d");var a=document.createElement("div");a.className="event-catcher_";a.addEventListener("click",this.playPause);a.addEventListener("dblclick",
this.toggleFullscreen);this.player.appendChild(a);a=document.createElement("div");a.className="controls_";a.style.cssText="";this.player.appendChild(a);const b=document.createElement("div");b.className="progress-bar_";b.addEventListener("pointermove",e=>{const [g,,f]=this.getCoords(e);d.style.width=`${100*Math.max(0,Math.min(1,g/f))}%`},!0);b.addEventListener("pointerdown",e=>{if(0===e.button){var g=this.isPlaying;this.progress.classList.remove("smooth_");this.player.classList.toggle("finished_",
this.pos===this.data.length-1);this.progressBarPointerMoveHandler(e);b.setPointerCapture(e.pointerId);b.addEventListener("pointermove",this.progressBarPointerMoveHandler);b.addEventListener("pointerup",f=>{b.removeEventListener("pointermove",this.progressBarPointerMoveHandler);this.progress.classList.add("smooth_");this.player.classList.toggle("finished_",this.pos===this.data.length);g&&this.pos<this.data.length&&this.play()},{once:!0})}});a.appendChild(b);var c=document.createElement("div");c.className=
"progress-bar-bg_";b.appendChild(c);const d=document.createElement("div");d.className="progress-hover_";b.appendChild(d);this.progress=document.createElement("div");this.progress.className="progress_ smooth_";this.updateProgress();b.appendChild(this.progress);c=document.createElement("div");c.className="play-btn_ btn_";c.title="\u0417\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c/\u041e\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c \u043f\u0440\u043e\u0438\u0433\u0440\u044b\u0432\u0430\u043d\u0438\u0435";
a.appendChild(c);c.addEventListener("click",e=>{this.playPause()});c=document.createElement("div");c.className="first-frame-btn_ btn_";c.title="\u041a \u043f\u0435\u0440\u0432\u043e\u043c\u0443 \u0448\u0442\u0440\u0438\u0445\u0443";c.addEventListener("click",e=>{this.seek(0);this.updateProgress();this.player.classList.remove("finished_")});a.appendChild(c);c=document.createElement("div");c.className="speed-down-btn_ btn_";c.title="\u0423\u043c\u0435\u043d\u044c\u0448\u0438\u0442\u044c \u0441\u043a\u043e\u0440\u043e\u0441\u0442\u044c";
c.addEventListener("click",e=>{this.changeSpeed(-1)});a.appendChild(c);c=document.createElement("div");c.className="speed-up-btn_ btn_";c.title="\u0423\u0432\u0435\u043b\u0438\u0447\u0438\u0442\u044c \u0441\u043a\u043e\u0440\u043e\u0441\u0442\u044c";c.addEventListener("click",e=>{this.changeSpeed(1)});a.appendChild(c);c=document.createElement("div");c.className="last-frame-btn_ btn_";c.title="\u041a \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0435\u043c\u0443 \u0448\u0442\u0440\u0438\u0445\u0443";
c.addEventListener("click",e=>{this.seek(this.data.length);this.updateProgress();this.player.classList.add("finished_")});a.appendChild(c);this.speedView=document.createElement("div");this.speedView.className="speed_";this.speedView.title="\u0422\u0435\u043a\u0443\u0449\u0430\u044f \u0441\u043a\u043e\u0440\u043e\u0441\u0442\u044c";this.speedView.textContent=" ";this.updateSpeedView();a.appendChild(this.speedView);this.speedView.addEventListener("pointerdown",e=>{const {x:g,y:f}=this.player.getBoundingClientRect(),
h=(e.clientY-f-(e.clientY-e.target.getBoundingClientRect().y))/this.scaleY;this.renderSpeedInput((e.clientX-g)/this.scaleX,h);this.speedView.setPointerCapture(e.pointerId);this.speedView.addEventListener("pointermove",this.speedViewPointerMoveHandler);this.speedView.addEventListener("pointerup",k=>{this.speedView.removeEventListener("pointermove",this.speedViewPointerMoveHandler);this.speedInput?.remove()},{once:!0})});this.strokeNumView=document.createElement("div");this.strokeNumView.className=
"stroke_";this.strokeNumView.title="\u0422\u0435\u043a\u0443\u0449\u0438\u0439 \u0448\u0442\u0440\u0438\u0445";this.strokeNumView.textContent=" ";this.updateStrokeView();a.appendChild(this.strokeNumView);a.appendChild(document.createElement("span"));c=document.createElement("div");c.className="expand-btn_ btn_";c.title="\u0420\u0430\u0437\u0432\u0435\u0440\u043d\u0443\u0442\u044c/\u0421\u0432\u0435\u0440\u043d\u0443\u0442\u044c";c.addEventListener("click",e=>{this.expand()});a.appendChild(c);c=document.createElement("div");
c.className="fullscreen-btn_ btn_";c.title="\u0420\u0430\u0437\u0432\u0435\u0440\u043d\u0443\u0442\u044c \u043d\u0430 \u0432\u0435\u0441\u044c \u044d\u043a\u0440\u0430\u043d";c.addEventListener("click",this.toggleFullscreen);a.appendChild(c);a=document.createElement("div");a.className="close-btn_";a.title="\u0417\u0430\u043a\u0440\u044b\u0442\u044c \u043f\u0440\u043e\u0438\u0433\u0440\u044b\u0432\u0430\u0442\u0435\u043b\u044c";a.addEventListener("click",this.terminate);this.player.appendChild(a);
this.contextLayout=document.createElement("div");this.contextLayout.className="context-layout_";this.contextLayout.addEventListener("click",this.toggleContextLayout);a=document.createElement("div");a.className="save-img-data-btn_ btn_";a.title="\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0438\u0441\u0445\u043e\u0434\u043d\u0438\u043a";a.addEventListener("click",e=>{e.stopPropagation();this.saveImageData()});this.contextLayout.appendChild(a);a=document.createElement("div");a.className=
"save-img-btn_ btn_";a.title="\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435";a.addEventListener("click",e=>{e.stopPropagation();this.saveImage()});this.contextLayout.appendChild(a);this.player.appendChild(this.contextLayout);this.container.firstElementChild.before(this.player);this.resizeHandler()}toggleContextLayout(){this.isContextMenuDisabled||(this.pause(),this.isContextLayoutShown=!this.isContextLayoutShown,this.player.classList.toggle("context-menu_",
this.isContextLayoutShown))}updateSpeedView(){let a=Number(!this.speed[0]);this.speedView.firstChild.nodeValue=`x${a?100*this.speed[a]:this.speed[a]}`}updateStrokeView(){this.strokeNumView.firstChild.nodeValue=`${this.pos} / ${this.data.length}`}resizeHandler(){const a=this.isPlaying;this.pause();if(document.fullscreenElement===this.player)this.setSize(document.documentElement.clientWidth,document.documentElement.clientHeight);else{const d=this.isExpanded?this.mainContainer:this.container;let {width:e,
height:g}=getComputedStyle(d);e=parseInt(e);g=parseInt(g);const {width:f,height:h}=this.lastContainerDimension;if(d!==this.mainContainer||e!==f||g!==h)this.setSize(e,g),this.lastContainerDimension={width:e,height:g}}a&&this.play();const {width:b,height:c}=this.mainContainer.getBoundingClientRect();this.scaleX=b/this.mainContainer.offsetWidth;this.scaleY=c/this.mainContainer.offsetHeight}getDensityByDimensions(a,b){a=Math.min(Math.ceil(a/GPTimelapsePlayer_.ORIGINAL_WIDTH),Math.ceil(b/GPTimelapsePlayer_.ORIGINAL_HEIGHT));
return{density:a,canvasWidth:GPTimelapsePlayer_.ORIGINAL_WIDTH*a,canvasHeight:GPTimelapsePlayer_.ORIGINAL_HEIGHT*a}}setSize(a,b){const {density:c,canvasWidth:d,canvasHeight:e}=this.getDensityByDimensions(a,b),{width:g,height:f}=this.calculateAspectRatioFit(GPTimelapsePlayer_.ORIGINAL_WIDTH,GPTimelapsePlayer_.ORIGINAL_HEIGHT,a,b);a=document.documentElement.style;a.setProperty("--timelapse-player-width",`${Math.round(g)}px`);a.setProperty("--timelapse-player-height",`${Math.round(f)}px`);this.density=
c;this.width=d;this.height=e;this.bgCanvas.width=d;this.bgCanvas.height=e;this.canvas.width=d;this.canvas.height=e;this.strokeCanvas.width=d;this.strokeCanvas.height=e;this.redraw()}redraw(){this.pause();if(this.background){this.clearBackground();var a=this.getCache();this.cache[this.density]?(a=a.at(-1),this.bgCtx.putImageData(a,0,0)):this.drawFunction(this.bgCtx,this.background,this.density,!1)}else this.bgCtx.fillStyle=GPTimelapsePlayer_.BACKGROUND_COLOR,this.bgCtx.fillRect(0,0,this.bgCanvas.width,
this.bgCanvas.height);this.clearCanvas();a=this.data.slice(0,this.pos);this.draw(this.ctx,a);this.clearStroke();this.stroke&&(a=this.stroke.slice(0,GPTimelapsePlayer_.STROKE_OFFSET+this.sPos+1),this.draw(this.strokeCtx,[a],this.density,!1))}calculateAspectRatioFit(a,b,c,d){c=Math.min(c/a,d/b);return{width:a*c,height:b*c}}expand(a){this.isExpanded=a??!this.isExpanded;this.player.classList.toggle("expanded_",this.isExpanded);this.isExpanded?this.mainContainer.appendChild(this.player):this.container.appendChild(this.player);
this.resizeHandler()}playPause(){this.isPlaying?this.pause():this.play()}play(a=this.pos){a||this.clearCanvas();this.isPlaying=!0;this.updateProgress();this.player.classList.add("playing_");setTimeout(()=>{this.player.classList.remove("finished_")},24);this.timer=requestAnimationFrame(this.drawing)}pause(){this.isPlaying=!1;cancelAnimationFrame(this.timer);this.player.classList.remove("playing_")}stop(){this.pause();this.pos=0;this.updateProgress()}seek(a){this.pause();a=Math.max(0,Math.min(this.data.length,
a));if(a!==this.pos||!a){this.clearStroke();if(a<this.pos||!this.pos){this.clearCanvas();var b=this.data.slice(0,a)}else b=this.data.slice(this.pos,a);this.draw(this.ctx,b);this.pos=a;this.sPos=0;this.stroke=null;this.updateStrokeView()}}drawing(){if(this.stroke)this.drawingStroke(this.stroke);else if(this.pos<this.data.length){const a=this.data.slice(this.pos,this.pos+this.speed[1]),b=a.at(-1);this.speed[0]&&[1,2].includes(b[0])?(this.sPos=0,this.stroke=b,this.drawingStroke(b)):(this.draw(this.ctx,
a),this.pos=Math.min(this.data.length,this.pos+this.speed[1]),this.pos<this.data.length?this.timer=requestAnimationFrame(this.drawing):(this.player.classList.add("finished_"),this.pause()),this.updateProgress(),this.updateStrokeView())}else this.pos=0,this.updateProgress(),this.play()}drawingStroke(a){if(this.speed[0]&&this.sPos<a.length-GPTimelapsePlayer_.STROKE_OFFSET){const b=a.slice(0,GPTimelapsePlayer_.STROKE_OFFSET+this.sPos+1);this.sPos+=this.speed[0];this.clearStroke();this.draw(this.strokeCtx,
[b],this.density,!1);this.timer=requestAnimationFrame(()=>{this.drawingStroke(a)})}else this.sPos=0,this.pos=Math.min(this.data.length,this.pos+this.speed[1]),this.clearStroke(),this.draw(this.ctx,[a]),this.updateProgress(),this.updateStrokeView(),this.stroke=null,this.pos<this.data.length?this.timer=requestAnimationFrame(this.drawing):(this.player.classList.add("finished_"),this.pause())}changeSpeed(a,b){this.currentSpeed=Math.max(0,Math.min(GPTimelapsePlayer_.SPEEDS.length-1,b??this.currentSpeed+
a));this.speed=GPTimelapsePlayer_.SPEEDS[this.currentSpeed];window.localStorage.setItem("gp-timelapse-player-speed",JSON.stringify(this.currentSpeed));this.updateSpeedView()}speedViewPointerMoveHandler(a){a=(a.clientX-this.player.getBoundingClientRect().x)/this.scaleX;a=Math.round(Math.max(0,Math.min(GPTimelapsePlayer_.SPEED_SLIDER_WIDTH-GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH,a-this.speedInput.currentX))/((GPTimelapsePlayer_.SPEED_SLIDER_WIDTH-GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH)/(GPTimelapsePlayer_.SPEEDS.length-
1)));this.speedInput.value=a;this.changeSpeed(null,a)}renderSpeedInput(a,b){if(!this.speedInput){this.speedInput=document.createElement("input");this.speedInput.className="speed-slider_";this.speedInput.type="range";this.speedInput.min=0;this.speedInput.max=GPTimelapsePlayer_.SPEEDS.length-1;this.speedInput.style.width=`${GPTimelapsePlayer_.SPEED_SLIDER_WIDTH}px`;this.speedInput.style.height=`${GPTimelapsePlayer_.SPEED_SLIDER_HEIGHT}px`;var c=GPTimelapsePlayer_.SPEEDS.findIndex(([d])=>!d);this.speedInput.style.setProperty("--bg-separator",
`${Math.round(c/GPTimelapsePlayer_.SPEEDS.length*100)+Math.round(GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH/GPTimelapsePlayer_.SPEED_SLIDER_WIDTH*100)/2}%`)}this.speedInput.value=this.currentSpeed;c=(GPTimelapsePlayer_.SPEED_SLIDER_WIDTH-GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH)/(GPTimelapsePlayer_.SPEEDS.length-1)*Number(this.speedInput.value);this.speedInput.style.top=`${b-GPTimelapsePlayer_.SPEED_SLIDER_HEIGHT-10}px`;this.speedInput.style.left=`${a-c-GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH/
2}px`;this.player.appendChild(this.speedInput);this.speedInput.currentX=a-c}clearBackground(){this.bgCtx.fillStyle=GPTimelapsePlayer_.BACKGROUND_COLOR;this.bgCtx.fillRect(0,0,this.width,this.height)}clearCanvas(){this.ctx.clearRect(0,0,this.width,this.height)}clearStroke(){this.strokeCtx.clearRect(0,0,this.width,this.height)}updateProgress(a=this.pos){this.progress.style.width=`${Math.round(a/this.data.length*100)}%`}splitStroke(a){const [b,c,d,...e]=a;if(1===b||2===b){a=[];for(let g=1;g<=e.length;g++)a.push([b,
c,d,...e.slice(0,g)]);return a}return[a]}getCoords(a,b){b=(b||a.target).getBoundingClientRect();const [c,d]=a.touches?[a.touches[0].clientX,a.touches[0].clientY]:[a.clientX,a.clientY],[e,g]=[c-b.left,d-b.top];return[Math.round(e),Math.round(g),b.width,b.height]}progressBarPointerMoveHandler(a){const [b,,c]=this.getCoords(a);a=Math.max(0,Math.min(1,b/c));const d=Math.round(this.data.length*a);this.progress.style.width=`${100*a}%`;this.seek(d)}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():
(this.expand(!1),this.player.requestFullscreen())}saveImage(){var a=document.createElement("canvas");a.width=this.width;a.height=this.height;var b=a.getContext("2d");this.draw(b,this.data,this.density,!0);b=document.createElement("canvas");b.width=this.width;b.height=this.height;var c=b.getContext("2d");c.fillStyle=GPTimelapsePlayer_.BACKGROUND_COLOR;c.fillRect(0,0,this.width,this.height);if(this.background){var d=this.getCache();this.cache[this.density]?(d=d.at(-1),c.putImageData(d,0,0)):this.drawFunction(c,
this.background,this.density,!1)}c=document.createElement("canvas");c.width=this.width;c.height=this.height;d=c.getContext("2d");d.drawImage(b,0,0,this.width,this.height);d.drawImage(a,0,0,this.width,this.height);a=this.date.toLocaleDateString("ru-RU");a=`${this.author} - ${this.title} (${a}).png`;b=document.createElement("a");b.href=c.toDataURL();b.download=a;b.click()}async saveImageData(){var a=this.date.toLocaleDateString("ru-RU");a=`${this.author} - ${this.title} (${a}).gpimg`;var b={m:{a:this.author,
t:this.title,d:this.date.toISOString()},d:this.originalData};this.background&&(b.b=this.background);this.auth&&(b.a=this.auth);b=await GPUtils_.wCompressData(b);GPUtils_.saveBlob(b,a)}getCache(){this.cache?.[this.density]||this.updateCache();return this.cache[this.density]}updateCache(){const a=this.cache||{};a[this.density]||this.worker.postMessage({type:"get-cache",density:this.density});this.cache=a}draw(a,b,c,d,e=!0){if(b){var g=GPTimelapsePlayer_.CACHE_INTERVAL;if(GPTimelapsePlayer_.CACHE_ENABLE&&
e&&b.length>g)if(e=this.getCache(),!this.cache[this.density]&&b.at(-1).index+1<g)this.drawFunction(a,b,c,d);else{const f=Math.floor((b.at(-1).index+1)/g)-1;a.putImageData(e[f],0,0);b=b.slice(-(b.at(-1).index+1-(f+1)*g));this.drawFunction(a,b,c,d)}else this.drawFunction(a,b,c,d)}}drawFunction(a,b,c=this.density,d=!0,e=!1){a.lineCap=a.lineJoin="round";a.save();if(b){let n=[];for(var g=0;g<b.length;g++){var f=b[g],h=f[0];f=(f[1],f.slice(2));if(10!=h){var k=void 0;a.save();if(8!=h){for(k=1;k<f.length;k++)f[k]=
[f[k][0]*c,f[k][1]*c];if(2<f.length)switch(h){case 1:h=f[0];a.strokeStyle=h[0];a.lineWidth=h[1];a.globalAlpha=h[2];a.lineWidth*=c;k=[f[1][0],f[1][1]];a.beginPath();a.moveTo(...k);for(var l=2;l<f.length;l++)k=[f[l][0],f[l][1]],h=[f[l-1][0],f[l-1][1]],a.quadraticCurveTo(h[0],h[1],h[0]+(k[0]-h[0])/2,h[1]+(k[1]-h[1])/2);a.lineTo(k[0],k[1]);a.stroke();break;case 2:a.strokeStyle="#FFFFFF";a.lineWidth=f[0]*c;k=[f[1][0],f[1][1]];d&&(a.globalCompositeOperation="destination-out");a.beginPath();a.moveTo(...k);
for(l=2;l<f.length;l++)k=[f[l][0],f[l][1]],h=[f[l-1][0],f[l-1][1]],a.quadraticCurveTo(h[0],h[1],h[0]+(k[0]-h[0])/2,h[1]+(k[1]-h[1])/2);a.lineTo(k[0],k[1]);a.stroke();d&&(a.globalCompositeOperation="source-over");break;case 3:h=f[0];a.strokeStyle=h[0];a.lineWidth=h[1];a.globalAlpha=h[2];a.lineWidth*=c;a.beginPath();a.moveTo(f[1][0],f[1][1]);a.lineTo(f[2][0],f[2][1]);a.stroke();break;case 4:h=f[0];a.strokeStyle=h[0];a.lineWidth=h[1];a.globalAlpha=h[2];a.lineWidth*=c;a.beginPath();a.rect(f[1][0],f[1][1],
f[2][0]-f[1][0],f[2][1]-f[1][1]);a.stroke();break;case 6:h=f[0];a.fillStyle=h[0];a.lineWidth=h[1];a.globalAlpha=h[2];a.lineWidth*=c;a.beginPath();a.rect(f[1][0],f[1][1],f[2][0]-f[1][0],f[2][1]-f[1][1]);a.fill();break;case 5:h=f[0];a.strokeStyle=h[0];a.lineWidth=h[1];a.globalAlpha=h[2];a.lineWidth*=c;h=(f[2][0]-f[1][0])/2;k=(f[2][1]-f[1][1])/2;l=Math.round(f[1][0]+h);f=Math.round(f[1][1]+k);var m=(Math.sqrt(2)-1)/3*4;a.beginPath();a.moveTo(l,f-k);a.bezierCurveTo(l+m*h,f-k,l+h,f-m*k,l+h,f);a.bezierCurveTo(l+
h,f+m*k,l+m*h,f+k,l,f+k);a.bezierCurveTo(l-m*h,f+k,l-h,f+m*k,l-h,f);a.bezierCurveTo(l-h,f-m*k,l-m*h,f-k,l,f-k);a.stroke();break;case 7:h=f[0],a.fillStyle=h[0],a.lineWidth=h[1],a.globalAlpha=h[2],a.lineWidth*=c,h=(f[2][0]-f[1][0])/2,k=(f[2][1]-f[1][1])/2,l=Math.round(f[1][0]+h),f=Math.round(f[1][1]+k),m=(Math.sqrt(2)-1)/3*4,a.beginPath(),a.moveTo(l,f-k),a.bezierCurveTo(l+m*h,f-k,l+h,f-m*k,l+h,f),a.bezierCurveTo(l+h,f+m*k,l+m*h,f+k,l,f+k),a.bezierCurveTo(l-m*h,f+k,l-h,f+m*k,l-h,f),a.bezierCurveTo(l-
h,f-m*k,l-m*h,f-k,l,f-k),a.fill()}else if(![6,7,11].includes(h)){switch(h){case 2:a.fillStyle="#FFFFFF";a.lineWidth=f[0]*c;k=f[1];d&&(a.globalCompositeOperation="destination-out");break;case 10:a.fillStyle="#FF0000";a.lineWidth=2*c;a.globalAlpha=1;k=f[1];break;default:k=f[0],a.fillStyle=k[0],a.lineWidth=k[1],a.globalAlpha=k[2],a.lineWidth*=c,k=f[1]}a.beginPath();a.arc(k[0],k[1],a.lineWidth/2,0,2*Math.PI);a.fill();2==h&&d&&(a.globalCompositeOperation="source-over")}}else{h=f[0];a.fillStyle=h[0];a.globalAlpha=
h[1];a.beginPath();for(h=1;h<f.length;h+=this.fi)a.rect(f[h]*c,f[h+1]*c,f[h+2]*c,f[h+3]*c);a.fill()}a.restore()}else e&&n.push(f)}for(b=0;b<n.length;b++){d=n[b];for(e=1;e<d.length;e++)d[e]=[d[e][0]*c,d[e][1]*c];a.strokeStyle="#CC0053";a.lineWidth=2*c;a.globalAlpha=1;e=[d[1][0],d[1][1]];a.beginPath();a.moveTo(...e);for(g=2;g<d.length;g++)e=[d[g][0],d[g][1]],h=[d[g-1][0],d[g-1][1]],a.quadraticCurveTo(h[0],h[1],h[0]+(e[0]-h[0])/2,h[1]+(e[1]-h[1])/2);a.lineTo(e[0],e[1]);a.stroke()}}a.restore()}handleDelimiters(a,
b){const c=a.findLastIndex(d=>11===d[0]);if(~c){const d=a.slice(c+1);a=(b??[]).concat(a.slice(0,c).filter(e=>11!==e[0]));return[d,a]}return[a,b]}initCacheWorker(){let {width:a,height:b}=getComputedStyle(this.container);a=parseInt(a);b=parseInt(b);var {density:c}=this.getDensityByDimensions(a,b);let {width:d,height:e}=getComputedStyle(this.mainContainer);d=parseInt(d);e=parseInt(e);const {density:g}=this.getDensityByDimensions(d,e),{density:f}=this.getDensityByDimensions(window.screen.width,window.screen.height),
h=[...(new Set([c,g,f]))];this.worker||(c=URL.createObjectURL(new Blob([this.getFuncBody(this.cacheWorkerBody)])),this.worker=new Worker(c),URL.revokeObjectURL(c),this.worker.addEventListener("message",({data:k})=>{"worker-ready"===k.type?h.forEach(l=>{this.worker.postMessage({type:"get-cache",density:l})}):"cache-updated"===k.type&&(this.cache=k.cache,this.dispatchEvent(new CustomEvent("cache-updated",{detail:{density:k.density}})))}));this.worker.postMessage({type:"init",data:this.data,background:this.background,
draw:this.getFuncBody(this.drawFunction),fi:this.fi,CACHE_INTERVAL:GPTimelapsePlayer_.CACHE_INTERVAL,ORIGINAL_WIDTH:GPTimelapsePlayer_.ORIGINAL_WIDTH,ORIGINAL_HEIGHT:GPTimelapsePlayer_.ORIGINAL_HEIGHT,BACKGROUND_COLOR:GPTimelapsePlayer_.BACKGROUND_COLOR})}cacheWorkerBody(){function a(g){var f=b*g,h=c*g;if(!this.cache[g]){this.cache[g]=[];const l=e,m=Math.floor(self.data.length/l);f=new OffscreenCanvas(f,h);h=f.getContext("2d",{willReadFrequently:!0});let n;self.background&&(h.fillStyle=d,h.fillRect(0,
0,f.width,f.height),self.draw(h,this.background,g,!1),n=h.getImageData(0,0,f.width,f.height),h.clearRect(0,0,f.width,f.height));for(let p=0;p<m;p++){var k=p*l;k=self.data.slice(k,k+l);self.draw(h,k,g);k=h.getImageData(0,0,f.width,f.height);this.cache[g].push(k)}self.background&&this.cache[g].push(n)}}let b,c,d,e;self.data;self.draw;self.cache=[];self.addEventListener("message",({data:g})=>{"init"===g.type?(self.data=g.data,self.background=g.background,self.fi=g.fi,self.draw=new Function("a","l","f",
"g","h",`var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var l=0;return function(){return l<a.length?{done:!1,value:a[l++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var l="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return l?l.call(a):$jscomp.arrayIterator(a)};$jscomp.arrayFromIterator=function(a){for(var l,f=[];!(l=a.next()).done;)f.push(l.value);return f};$jscomp.arrayFromIterable=function(a){return a instanceof Array?a:$jscomp.arrayFromIterator($jscomp.makeIterator(a))};f=void 0===f?this.density:f;g=void 0===g?!0:g;h=void 0===h?!1:h;a.lineCap=a.lineJoin="round";a.save();if(l){for(var n=[],m=0;m<l.length;m++){var b=l[m],c=b[0];b=(b[1],b.slice(2));if(10!=c){var d;a.save();if(8!=c){for(d=1;d<b.length;d++)b[d]=[b[d][0]*f,b[d][1]*f];if(2<b.length)switch(c){case 1:c=b[0];a.strokeStyle=c[0];a.lineWidth=c[1];a.globalAlpha=c[2];a.lineWidth*=f;d=[b[1][0],b[1][1]];a.beginPath();a.moveTo.apply(a,$jscomp.arrayFromIterable(d));for(var e=2;e<b.length;e++)d=[b[e][0],b[e][1]],c=[b[e-1][0],b[e-1][1]],a.quadraticCurveTo(c[0],c[1],c[0]+(d[0]-c[0])/2,c[1]+(d[1]-c[1])/2);a.lineTo(d[0],d[1]);a.stroke();break;case 2:a.strokeStyle="#FFFFFF";a.lineWidth=b[0]*f;d=[b[1][0],b[1][1]];g&&(a.globalCompositeOperation="destination-out");a.beginPath();a.moveTo.apply(a,$jscomp.arrayFromIterable(d));for(e=2;e<b.length;e++)d=[b[e][0],b[e][1]],c=[b[e-1][0],b[e-1][1]],a.quadraticCurveTo(c[0],c[1],c[0]+(d[0]-c[0])/2,c[1]+(d[1]-c[1])/2);a.lineTo(d[0],d[1]);a.stroke();g&&(a.globalCompositeOperation="source-over");break;case 3:c=b[0];a.strokeStyle=c[0];a.lineWidth=c[1];a.globalAlpha=c[2];a.lineWidth*=f;a.beginPath();a.moveTo(b[1][0],b[1][1]);a.lineTo(b[2][0],b[2][1]);a.stroke();break;case 4:c=b[0];a.strokeStyle=c[0];a.lineWidth=c[1];a.globalAlpha=c[2];a.lineWidth*=f;a.beginPath();a.rect(b[1][0],b[1][1],b[2][0]-b[1][0],b[2][1]-b[1][1]);a.stroke();break;case 6:c=b[0];a.fillStyle=c[0];a.lineWidth=c[1];a.globalAlpha=c[2];a.lineWidth*=f;a.beginPath();a.rect(b[1][0],b[1][1],b[2][0]-b[1][0],b[2][1]-b[1][1]);a.fill();break;case 5:c=b[0];a.strokeStyle=c[0];a.lineWidth=c[1];a.globalAlpha=c[2];a.lineWidth*=f;c=(b[2][0]-b[1][0])/2;d=(b[2][1]-b[1][1])/2;e=Math.round(b[1][0]+c);b=Math.round(b[1][1]+d);var k=(Math.sqrt(2)-1)/3*4;a.beginPath();a.moveTo(e,b-d);a.bezierCurveTo(e+k*c,b-d,e+c,b-k*d,e+c,b);a.bezierCurveTo(e+c,b+k*d,e+k*c,b+d,e,b+d);a.bezierCurveTo(e-k*c,b+d,e-c,b+k*d,e-c,b);a.bezierCurveTo(e-c,b-k*d,e-k*c,b-d,e,b-d);a.stroke();break;case 7:c=b[0],a.fillStyle=c[0],a.lineWidth=c[1],a.globalAlpha=c[2],a.lineWidth*=f,c=(b[2][0]-b[1][0])/2,d=(b[2][1]-b[1][1])/2,e=Math.round(b[1][0]+c),b=Math.round(b[1][1]+d),k=(Math.sqrt(2)-1)/3*4,a.beginPath(),a.moveTo(e,b-d),a.bezierCurveTo(e+k*c,b-d,e+c,b-k*d,e+c,b),a.bezierCurveTo(e+c,b+k*d,e+k*c,b+d,e,b+d),a.bezierCurveTo(e-k*c,b+d,e-c,b+k*d,e-c,b),a.bezierCurveTo(e-c,b-k*d,e-k*c,b-d,e,b-d),a.fill()}else if(![6,7,11].includes(c)){switch(c){case 2:a.fillStyle="#FFFFFF";a.lineWidth=b[0]*f;d=b[1];g&&(a.globalCompositeOperation="destination-out");break;case 10:a.fillStyle="#FF0000";a.lineWidth=2*f;a.globalAlpha=1;d=b[1];break;default:d=b[0],a.fillStyle=d[0],a.lineWidth=d[1],a.globalAlpha=d[2],a.lineWidth*=f,d=b[1]}a.beginPath();a.arc(d[0],d[1],a.lineWidth/2,0,2*Math.PI);a.fill();2==c&&g&&(a.globalCompositeOperation="source-over")}}else{c=b[0];a.fillStyle=c[0];a.globalAlpha=c[1];a.beginPath();for(c=1;c<b.length;c+=${self.fi})a.rect(b[c]*f,b[c+1]*f,b[c+2]*f,b[c+3]*f);a.fill()}a.restore()}else h&&n.push(b)}for(l=0;l<n.length;l++){g=n[l];for(h=1;h<g.length;h++)g[h]=[g[h][0]*f,g[h][1]*f];a.strokeStyle="#CC0053";a.lineWidth=2*f;a.globalAlpha=1;h=[g[1][0],g[1][1]];a.beginPath();a.moveTo.apply(a,$jscomp.arrayFromIterable(h));for(m=2;m<g.length;m++)h=[g[m][0],g[m][1]],c=[g[m-1][0],g[m-1][1]],a.quadraticCurveTo(c[0],c[1],c[0]+(h[0]-c[0])/2,c[1]+(h[1]-c[1])/2);a.lineTo(h[0],h[1]);a.stroke()}}a.restore();`),
e=g.CACHE_INTERVAL,b=g.ORIGINAL_WIDTH,c=g.ORIGINAL_HEIGHT,d=g.BACKGROUND_COLOR,self.postMessage({type:"worker-ready"})):"get-cache"===g.type&&(self.cache[g.density]||a(g.density),self.postMessage({type:"cache-updated",cache:self.cache,density:g.density}))})}getFuncBody(a){a=a.toString();return a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))}}window.GPTimelapsePlayer_=GPTimelapsePlayer_;
}).call(this)
