(function(){
class GPUtils_{static async compressImageData(a,b=!0){const {data:c,background:e,auth:d,meta:f}=a;a={m:{a:f.author,t:f.title,d:(new Date(f.date)).toISOString()},d:c};e&&(a.b=e);d&&(a.a=d);return b?this.wCompressData(a):this.compressData(a)}static async compressData(a){a=JSON.stringify(a);a=this.stringToArrayBuffer(a);a=await this.compressArrayBuffer(a);return this.arrayBufferToBlob(a)}static arrayBufferToBlob(a){return new Blob([a],{type:"octet/stream"})}static async compressArrayBuffer(a){var b=
new CompressionStream("deflate"),c=b.writable.getWriter();c.write(a);c.close();a=[];b=b.readable.getReader();for(c=0;;){const {value:e,done:d}=await b.read();if(d)break;a.push(e);c+=e.byteLength}b=new Uint8Array(c);c=0;for(const e of a)b.set(e,c),c+=e.byteLength;return b}static stringToArrayBuffer(a){return(new TextEncoder).encode(a)}static async decompressFile(a){return JSON.parse(await this.decompressBlob(a))}static async decompressBlob(a){let b=new DecompressionStream("deflate");a=a.stream().pipeThrough(b);
return await (new Response(a)).text()}static saveBlob(a,b=""){a=window.URL.createObjectURL(a);const c=document.createElement("a");c.href=a;c.download=b;c.click();window.URL.revokeObjectURL(a)}static wCompressData(a){return new Promise(b=>{const c=this.createWorker(this.compressWorkerBody);c.addEventListener("message",({data:e})=>{c.terminate();b(e)});c.postMessage(a)})}static compressWorkerBody(){self.work=new async function(){}.constructor("a",'a=JSON.stringify(a);a=(new TextEncoder).encode(a);var c=new CompressionStream("deflate"),b=c.writable.getWriter();b.write(a);b.close();a=[];c=c.readable.getReader();for(b=0;;){const {value:d,done:e}=await c.read();if(e)break;a.push(d);b+=d.byteLength}c=new Uint8Array(b);b=0;for(const d of a)c.set(d,b),b+=d.byteLength;return new Blob([c],{type:"octet/stream"})');
self.addEventListener("message",async({data:a})=>{self.postMessage(await self.work(a))})}static createWorker(a){a=URL.createObjectURL(new Blob([this.getFuncBody(a)]));const b=new Worker(a);URL.revokeObjectURL(a);return b}static getFuncBody(a){a=a.toString();return a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))}static setInputFocusBlurHandler(a){const b=c=>{c.target!==a&&(a.blur(),document.removeEventListener("pointerdown",b,!0))};a.addEventListener("focus",c=>{c.target.select();document.addEventListener("pointerdown",
b,!0)});a.addEventListener("blur",c=>{window.getSelection().removeAllRanges()})}static drawFunctionString='function(a,c,d,t,D,f){f&&(a.beginPath(),a.rect(0,0,1,1),a.fill());a.lineCap=a.lineJoin="round";a.save();if(c){f=[];let E=!0,O=!1,P=void 0;try{for(var C,F=c[Symbol.iterator]();!(E=(C=F.next()).done);E=!0){const x=C.value,w=x[0],b=x.slice(2);if(10!=w){c=void 0;a.save();if(12==w)t?a.clearRect(0,32*d,758*d,424*d):(a.fillStyle="#FFFFFF",a.beginPath(),a.rect(0,32*d,758*d,424*d),a.fill());else if(8!=w){for(var e=1;e<b.length;e++)b[e]=[b[e][0]*d,b[e][1]*d];if(2<b.length)switch(w){case 1:var G=b[0];a.strokeStyle=G[0];a.lineWidth=G[1];a.globalAlpha=G[2];a.lineWidth*=d;c=[b[1][0],b[1][1]];a.beginPath();a.moveTo.apply(a,c);for(e=2;e<b.length;e++){c=[b[e][0],b[e][1]];var y=[b[e-1][0],b[e-1][1]];a.quadraticCurveTo(y[0],y[1],y[0]+(c[0]-y[0])/2,y[1]+(c[1]-y[1])/2)}a.lineTo(c[0],c[1]);a.stroke();break;case 2:a.strokeStyle="#FFFFFF";a.lineWidth=b[0]*d;c=[b[1][0],b[1][1]];t&&(a.globalCompositeOperation="destination-out");a.beginPath();a.moveTo.apply(a,c);for(e=2;e<b.length;e++){c=[b[e][0],b[e][1]];var z=[b[e-1][0],b[e-1][1]];a.quadraticCurveTo(z[0],z[1],z[0]+(c[0]-z[0])/2,z[1]+(c[1]-z[1])/2)}a.lineTo(c[0],c[1]);a.stroke();t&&(a.globalCompositeOperation="source-over");break;case 3:var H=b[0];a.strokeStyle=H[0];a.lineWidth=H[1];a.globalAlpha=H[2];a.lineWidth*=d;a.beginPath();a.moveTo(b[1][0],b[1][1]);a.lineTo(b[2][0],b[2][1]);a.stroke();break;case 4:var I=b[0];a.strokeStyle=I[0];a.lineWidth=I[1];a.globalAlpha=I[2];a.lineWidth*=d;a.beginPath();a.rect(b[1][0],b[1][1],b[2][0]-b[1][0],b[2][1]-b[1][1]);a.stroke();break;case 6:var J=b[0];a.fillStyle=J[0];a.lineWidth=J[1];a.globalAlpha=J[2];a.lineWidth*=d;a.beginPath();a.rect(b[1][0],b[1][1],b[2][0]-b[1][0],b[2][1]-b[1][1]);a.fill();break;case 5:var K=b[0];a.strokeStyle=K[0];a.lineWidth=K[1];a.globalAlpha=K[2];a.lineWidth*=d;var p=(b[2][0]-b[1][0])/2,m=(b[2][1]-b[1][1])/2,g=Math.round(b[1][0]+p),h=Math.round(b[1][1]+m),u=(Math.sqrt(2)-1)/3*4;a.beginPath();a.moveTo(g,h-m);a.bezierCurveTo(g+u*p,h-m,g+p,h-u*m,g+p,h);a.bezierCurveTo(g+p,h+u*m,g+u*p,h+m,g,h+m);a.bezierCurveTo(g-u*p,h+m,g-p,h+u*m,g-p,h);a.bezierCurveTo(g-p,h-u*m,g-u*p,h-m,g,h-m);a.stroke();break;case 7:var L=b[0];a.fillStyle=L[0];a.lineWidth=L[1];a.globalAlpha=L[2];a.lineWidth*=d;var q=(b[2][0]-b[1][0])/2,n=(b[2][1]-b[1][1])/2,k=Math.round(b[1][0]+q),l=Math.round(b[1][1]+n),v=(Math.sqrt(2)-1)/3*4;a.beginPath();a.moveTo(k,l-n);a.bezierCurveTo(k+v*q,l-n,k+q,l-v*n,k+q,l);a.bezierCurveTo(k+q,l+v*n,k+v*q,l+n,k,l+n);a.bezierCurveTo(k-v*q,l+n,k-q,l+v*n,k-q,l);a.bezierCurveTo(k-q,l-v*n,k-v*q,l-n,k,l-n);a.fill()}else if(![6,7,11].includes(w)){switch(w){case 2:a.fillStyle="#FFFFFF";a.lineWidth=b[0]*d;c=b[1];t&&(a.globalCompositeOperation="destination-out");break;case 10:a.fillStyle="#FF0000";a.lineWidth=2*d;a.globalAlpha=1;c=b[1];break;default:var M=b[0];a.fillStyle=M[0];a.lineWidth=M[1];a.globalAlpha=M[2];a.lineWidth*=d;c=b[1]}a.beginPath();a.arc(c[0],c[1],a.lineWidth/2,0,2*Math.PI);a.fill();2==w&&t&&(a.globalCompositeOperation="source-over")}}else{var Q=b[0];a.fillStyle=Q[0];a.globalAlpha=Q[1];a.beginPath();for(c=1;c<b.length;c+=5)a.rect(b[c]*d,b[c+1]*d,b[c+2]*d,b[c+3]*d);a.fill()}a.restore()}else D&&f.push(b)}}catch(x){O=!0,P=x}finally{try{E||null==F.return||F.return()}finally{if(O)throw P;}}t=!0;D=!1;C=void 0;try{for(var R,N=f[Symbol.iterator]();!(t=(R=N.next()).done);t=!0){var r=R.value;for(f=1;f<r.length;f++)r[f]=[r[f][0]*d,r[f][1]*d];a.strokeStyle="#CC0053";a.lineWidth=2*d;a.globalAlpha=1;var A=[r[1][0],r[1][1]];a.beginPath();a.moveTo.apply(a,A);for(f=2;f<r.length;f++){A=[r[f][0],r[f][1]];var B=[r[f-1][0],r[f-1][1]];a.quadraticCurveTo(B[0],B[1],B[0]+(A[0]-B[0])/2,B[1]+(A[1]-B[1])/2)}a.lineTo(A[0],A[1]);a.stroke()}}catch(x){D=!0,C=x}finally{try{t||null==N.return||N.return()}finally{if(D)throw C;}}}a.restore()}';static drawFunction=(new Function(`return ${this.drawFunctionString}`))();}
window.GPUtils_=GPUtils_;class GPTimelapsePlayer_ extends EventTarget{static players=new Set;static CACHE_ENABLED=!0;static CACHE_INTERVAL=1E3;static ORIGINAL_WIDTH=758;static ORIGINAL_HEIGHT=424;static DENSITY=1;static WIDTH=this.ORIGINAL_WIDTH*this.DENSITY;static HEIGHT=this.ORIGINAL_HEIGHT*this.DENSITY;static BACKGROUND_COLOR="#FFFFFF";static STROKE_OFFSET=3;static SPEEDS=[[1,1],[5,1],[15,1],[30,1],[50,1],[0,1],[0,2],[0,4],[0,8],[0,16],[0,32]];static SPEED=0;static SPEED_SLIDER_WIDTH=130;static SPEED_SLIDER_HEIGHT=16;static SPEED_SLIDER_THUMB_WIDTH=14;static M_STROKE_OFFSET=67;static DISPLAY_MODE={NORMAL:"normal",
EXPANDED:"expanded",FULLSCREEN:"fullscreen"};static DEFAULT_DISPLAY_MODE=GPTimelapsePlayer_.DISPLAY_MODE.NORMAL;static FV2_DATE=1681366233E3;static GARTICPHONE_HOSTNAME_PATTERN=/(^|\.)garticphone\.com$/;constructor({image:{data:a,background:b,auth:c,meta:{author:e,title:d,date:f}},container:g,mainContainer:h},k=GPTimelapsePlayer_.DEFAULT_DISPLAY_MODE,l=!1){super();GPTimelapsePlayer_.players.add(this);this.density=GPTimelapsePlayer_.DENSITY;this.width=GPTimelapsePlayer_.WIDTH;this.height=GPTimelapsePlayer_.HEIGHT;
this.originalData=a.slice();const [p,n,m]=this.handleDelimiters(a,b);this.data=p;this.background=n;this.auth=c;this.author=e;this.title=d;this.date=new Date(f);this.eraserAlpha=!m;this.fi=f&&this.date.getTime()>GPTimelapsePlayer_.FV2_DATE?5:4;this.container=g;this.container.isPlayerRendered=!0;this.mainContainer=h;this.defaultDisplayMode=k;this.defaultDisplayModeDensity=this.getModeDensity(k);this.cache;this.canvas;this.ctx;this.isPlaying=!1;this.currentSpeed=JSON.parse(localStorage.getItem("gp-timelapse-player-speed"))||
GPTimelapsePlayer_.SPEED;this.speed=GPTimelapsePlayer_.SPEEDS[this.currentSpeed];this.sPos=this.pos=0;this.lastContainerDimension={width:0,height:0};this.isContextLayoutShown=this.expandStateBeforeFullscreen=this.isFullscreen=this.isExpanded=!1;this.isContextMenuDisabled=l;this.isStandalone=!GPTimelapsePlayer_.GARTICPHONE_HOSTNAME_PATTERN.test(location.hostname);this.progressBarPointerMoveHandler=this.progressBarPointerMoveHandler.bind(this);this.resizeHandler=this.resizeHandler.bind(this);this.toggleFullscreen=
this.toggleFullscreen.bind(this);this.playPause=this.playPause.bind(this);this.drawing=this.drawing.bind(this);this.expand=this.expand.bind(this);this.terminate=this.terminate.bind(this);this.toggleContextLayout=this.toggleContextLayout.bind(this);this.saveImage=this.saveImage.bind(this);this.speedViewPointerMoveHandler=this.speedViewPointerMoveHandler.bind(this);window.addEventListener("resize",this.resizeHandler);this.addEventListener("cache-updated",this.updateCacheHandler);this.initData();this.initCacheWorker()}static closeAll(){GPTimelapsePlayer_.players.forEach(a=>
{a.terminate()})}updateCacheHandler({detail:{density:a}}){if(a===this.defaultDisplayModeDensity){this.render();switch(this.defaultDisplayMode){case GPTimelapsePlayer_.DISPLAY_MODE.EXPANDED:this.expand(!0);break;case GPTimelapsePlayer_.DISPLAY_MODE.FULLSCREEN:this.player.requestFullscreen()}this.seek(this.data.length);this.dispatchEvent(new Event("image-rendered"));this.dispatchEvent(new CustomEvent("data-loaded",{detail:{author:this.author,title:this.title,date:this.date.toISOString()}}));this.removeEventListener("cache-updated",
this.updateCacheHandler)}}getModeDensity(a){switch(a){case GPTimelapsePlayer_.DISPLAY_MODE.NORMAL:const {width:b,height:c}=getComputedStyle(this.container);return this.getDensityByDimensions(parseInt(b),parseInt(c)).density;case GPTimelapsePlayer_.DISPLAY_MODE.EXPANDED:const {width:e,height:d}=getComputedStyle(this.mainContainer);return this.getDensityByDimensions(parseInt(e),parseInt(d)).density;case GPTimelapsePlayer_.DISPLAY_MODE.FULLSCREEN:return this.getDensityByDimensions(window.screen.width,
window.screen.height).density}}terminate(){document.fullscreenElement===this.player&&this.mainContainer.classList.remove("gp-tp-fullscreen_");this.pause();this.worker.terminate();this.cache=this.originalData=this.data=null;this.player.remove();this.container.isPlayerRendered=!1;this.container=null;this.speedInput&&this.speedInput.remove();window.removeEventListener("resize",this.resizeHandler);GPTimelapsePlayer_.players.delete(this);this.dispatchEvent(new Event("terminated"))}initData(){const a=[];
for(let b=0;b<this.data.length;b++)this.data[b].index=b,this.isMStroke(this.data[b])&&a.push(b);a.reverse().forEach(b=>{this.data.splice(b,1)})}isMStroke(a){return!(1===a[0]&&a[3][0]>GPTimelapsePlayer_.ORIGINAL_WIDTH&&a[3][1]>GPTimelapsePlayer_.ORIGINAL_HEIGHT)||a[3][0]-GPTimelapsePlayer_.ORIGINAL_WIDTH-GPTimelapsePlayer_.M_STROKE_OFFSET||a.at(-1)[1]-GPTimelapsePlayer_.ORIGINAL_HEIGHT-GPTimelapsePlayer_.M_STROKE_OFFSET?!1:!0}render(){this.player=document.createElement("div");this.player.className=
"timelapse-player_";this.player.addEventListener("click",d=>{d.stopPropagation()});this.player.addEventListener("pointerdown",d=>{d.stopPropagation()});this.player.addEventListener("pointerup",d=>{d.stopPropagation()});this.player.addEventListener("mouseup",d=>{d.stopPropagation()});this.player.addEventListener("mousedown",d=>{d.preventDefault();d.stopPropagation();1===d.button&&(this.isFullscreen?this.toggleFullscreen():this.expand())},!0);this.player.addEventListener("contextmenu",d=>{d.stopPropagation();
d.preventDefault();this.toggleContextLayout()});this.player.addEventListener("fullscreenchange",d=>{this.isFullscreen=!!document.fullscreenElement;this.player.classList.toggle("fullscreen_",this.isFullscreen);this.mainContainer.classList.toggle("gp-tp-fullscreen_",this.isFullscreen);this.isStandalone&&!this.isFullscreen?this.expand(this.expandStateBeforeFullscreen):this.resizeHandler()});this.bgCanvas=document.createElement("canvas");this.bgCanvas.className="background-canvas_";this.bgCanvas.width=
this.width;this.bgCanvas.height=this.height;this.player.appendChild(this.bgCanvas);this.bgCtx=this.bgCanvas.getContext("2d");this.bgCtx.fillStyle=GPTimelapsePlayer_.BACKGROUND_COLOR;this.bgCtx.fillRect(0,0,this.bgCanvas.width,this.bgCanvas.height);this.background&&this.drawFunction(this.bgCtx,this.background,this.density,!1);this.canvas=document.createElement("canvas");this.canvas.className="canvas_";this.canvas.width=this.width;this.canvas.height=this.height;this.player.appendChild(this.canvas);
this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0});this.strokeCanvas=document.createElement("canvas");this.strokeCanvas.className="stroke-canvas_";this.strokeCanvas.width=this.width;this.strokeCanvas.height=this.height;this.player.appendChild(this.strokeCanvas);this.strokeCtx=this.strokeCanvas.getContext("2d");var a=document.createElement("div");a.className="event-catcher_";a.addEventListener("click",this.playPause);a.addEventListener("dblclick",this.toggleFullscreen);this.player.appendChild(a);
a=document.createElement("div");a.className="controls_";a.style.cssText="";this.player.appendChild(a);const b=document.createElement("div");b.className="progress-bar_";b.addEventListener("pointermove",d=>{const [f,,g]=this.getCoords(d);e.style.width=`${100*Math.max(0,Math.min(1,f/g))}%`},!0);b.addEventListener("pointerdown",d=>{if(0===d.button){var f=this.isPlaying;this.progress.classList.remove("smooth_");this.player.classList.toggle("finished_",this.pos===this.data.length-1);this.progressBarPointerMoveHandler(d);
b.setPointerCapture(d.pointerId);b.addEventListener("pointermove",this.progressBarPointerMoveHandler);b.addEventListener("pointerup",g=>{b.removeEventListener("pointermove",this.progressBarPointerMoveHandler);this.progress.classList.add("smooth_");this.player.classList.toggle("finished_",this.pos===this.data.length);f&&this.pos<this.data.length&&this.play()},{once:!0})}});a.appendChild(b);var c=document.createElement("div");c.className="progress-bar-bg_";b.appendChild(c);const e=document.createElement("div");
e.className="progress-hover_";b.appendChild(e);this.progress=document.createElement("div");this.progress.className="progress_ smooth_";this.updateProgress();b.appendChild(this.progress);c=document.createElement("div");c.className="play-btn_ btn_";c.title="\u0417\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c/\u041e\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c \u043f\u0440\u043e\u0438\u0433\u0440\u044b\u0432\u0430\u043d\u0438\u0435";a.appendChild(c);c.addEventListener("click",d=>{this.playPause()});
c=document.createElement("div");c.className="first-frame-btn_ btn_";c.title="\u041a \u043f\u0435\u0440\u0432\u043e\u043c\u0443 \u0448\u0442\u0440\u0438\u0445\u0443";c.addEventListener("click",d=>{this.seek(0);this.updateProgress();this.player.classList.remove("finished_")});a.appendChild(c);c=document.createElement("div");c.className="speed-down-btn_ btn_";c.title="\u0423\u043c\u0435\u043d\u044c\u0448\u0438\u0442\u044c \u0441\u043a\u043e\u0440\u043e\u0441\u0442\u044c";c.addEventListener("click",d=>
{this.changeSpeed(-1)});a.appendChild(c);c=document.createElement("div");c.className="speed-up-btn_ btn_";c.title="\u0423\u0432\u0435\u043b\u0438\u0447\u0438\u0442\u044c \u0441\u043a\u043e\u0440\u043e\u0441\u0442\u044c";c.addEventListener("click",d=>{this.changeSpeed(1)});a.appendChild(c);c=document.createElement("div");c.className="last-frame-btn_ btn_";c.title="\u041a \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0435\u043c\u0443 \u0448\u0442\u0440\u0438\u0445\u0443";c.addEventListener("click",d=>
{this.seek(this.data.length);this.updateProgress();this.player.classList.add("finished_")});a.appendChild(c);this.speedView=document.createElement("div");this.speedView.className="speed_";this.speedView.title="\u0422\u0435\u043a\u0443\u0449\u0430\u044f \u0441\u043a\u043e\u0440\u043e\u0441\u0442\u044c";this.speedView.textContent=" ";this.updateSpeedView();a.appendChild(this.speedView);this.speedView.addEventListener("pointerdown",d=>{const {x:f,y:g}=this.player.getBoundingClientRect(),h=(d.clientY-
g-(d.clientY-d.target.getBoundingClientRect().y))/this.scaleY;this.renderSpeedInput((d.clientX-f)/this.scaleX,h);this.speedView.setPointerCapture(d.pointerId);this.speedView.addEventListener("pointermove",this.speedViewPointerMoveHandler);this.speedView.addEventListener("pointerup",k=>{this.speedView.removeEventListener("pointermove",this.speedViewPointerMoveHandler);this.speedInput?.remove()},{once:!0})});this.strokeNumView=document.createElement("div");this.strokeNumView.className="stroke_";this.strokeNumView.title=
"\u0422\u0435\u043a\u0443\u0449\u0438\u0439 \u0448\u0442\u0440\u0438\u0445";this.strokeNumView.textContent=" ";this.updateStrokeView();a.appendChild(this.strokeNumView);a.appendChild(document.createElement("span"));c=document.createElement("div");c.className="expand-btn_ btn_";c.title="\u0420\u0430\u0437\u0432\u0435\u0440\u043d\u0443\u0442\u044c/\u0421\u0432\u0435\u0440\u043d\u0443\u0442\u044c";c.addEventListener("click",d=>{this.expand()});a.appendChild(c);c=document.createElement("div");c.className=
"fullscreen-btn_ btn_";c.title="\u0420\u0430\u0437\u0432\u0435\u0440\u043d\u0443\u0442\u044c \u043d\u0430 \u0432\u0435\u0441\u044c \u044d\u043a\u0440\u0430\u043d";c.addEventListener("click",this.toggleFullscreen);a.appendChild(c);a=document.createElement("div");a.className="close-btn_";a.title="\u0417\u0430\u043a\u0440\u044b\u0442\u044c \u043f\u0440\u043e\u0438\u0433\u0440\u044b\u0432\u0430\u0442\u0435\u043b\u044c";a.addEventListener("click",this.terminate);this.player.appendChild(a);this.contextLayout=
document.createElement("div");this.contextLayout.className="context-layout_";this.contextLayout.addEventListener("click",this.toggleContextLayout);a=document.createElement("div");a.className="save-img-data-btn_ btn_";a.title="\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0438\u0441\u0445\u043e\u0434\u043d\u0438\u043a";a.addEventListener("click",d=>{d.stopPropagation();this.saveImageData()});this.contextLayout.appendChild(a);a=document.createElement("div");a.className="save-img-btn_ btn_";
a.title="\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0435";a.addEventListener("click",d=>{d.stopPropagation();this.saveImage()});this.contextLayout.appendChild(a);this.player.appendChild(this.contextLayout);this.container.firstElementChild.before(this.player);this.resizeHandler()}toggleContextLayout(){this.isContextMenuDisabled||(this.pause(),this.isContextLayoutShown=!this.isContextLayoutShown,this.player.classList.toggle("context-menu_",
this.isContextLayoutShown))}updateSpeedView(){let a=Number(!this.speed[0]);this.speedView.firstChild.nodeValue=`x${a?100*this.speed[a]:this.speed[a]}`}updateStrokeView(){this.strokeNumView.firstChild.nodeValue=`${this.pos} / ${this.data.length}`}resizeHandler(){const a=this.isPlaying;this.pause();if(document.fullscreenElement===this.player)this.setSize(document.documentElement.clientWidth,document.documentElement.clientHeight);else{const e=this.isExpanded?this.mainContainer:this.container;let {width:d,
height:f}=getComputedStyle(e);d=parseInt(d);f=parseInt(f);const {width:g,height:h}=this.lastContainerDimension;if(e!==this.mainContainer||d!==g||f!==h)this.setSize(d,f),this.lastContainerDimension={width:d,height:f}}a&&this.play();const {width:b,height:c}=this.mainContainer.getBoundingClientRect();this.scaleX=b/this.mainContainer.offsetWidth;this.scaleY=c/this.mainContainer.offsetHeight}getDensityByDimensions(a,b){a=Math.min(Math.ceil(a/GPTimelapsePlayer_.ORIGINAL_WIDTH),Math.ceil(b/GPTimelapsePlayer_.ORIGINAL_HEIGHT));
return{density:a,canvasWidth:GPTimelapsePlayer_.ORIGINAL_WIDTH*a,canvasHeight:GPTimelapsePlayer_.ORIGINAL_HEIGHT*a}}setSize(a,b){const {density:c,canvasWidth:e,canvasHeight:d}=this.getDensityByDimensions(a,b),{width:f,height:g}=this.calculateAspectRatioFit(GPTimelapsePlayer_.ORIGINAL_WIDTH,GPTimelapsePlayer_.ORIGINAL_HEIGHT,a,b);a=document.documentElement.style;a.setProperty("--timelapse-player-width",`${Math.round(f)}px`);a.setProperty("--timelapse-player-height",`${Math.round(g)}px`);this.density=
c;this.width=e;this.height=d;this.bgCanvas.width=e;this.bgCanvas.height=d;this.canvas.width=e;this.canvas.height=d;this.strokeCanvas.width=e;this.strokeCanvas.height=d;this.redraw()}redraw(){this.pause();if(this.background){this.clearBackground();var a=this.getCache();this.cache[this.density]?(a=a.at(-1),this.bgCtx.putImageData(a,0,0)):this.drawFunction(this.bgCtx,this.background,this.density,!1)}else this.bgCtx.fillStyle=GPTimelapsePlayer_.BACKGROUND_COLOR,this.bgCtx.fillRect(0,0,this.bgCanvas.width,
this.bgCanvas.height);this.clearCanvas();a=this.data.slice(0,this.pos);this.draw(this.ctx,a);this.clearStroke();this.stroke&&(a=this.stroke.slice(0,GPTimelapsePlayer_.STROKE_OFFSET+this.sPos+1),this.draw(this.strokeCtx,[a],this.density,!1))}calculateAspectRatioFit(a,b,c,e){c=Math.min(c/a,e/b);return{width:a*c,height:b*c}}expand(a){this.isExpanded=a??!this.isExpanded;this.player.classList.toggle("expanded_",this.isExpanded);this.isExpanded?this.mainContainer.appendChild(this.player):this.container.firstElementChild.before(this.player);
this.resizeHandler();this.isStandalone&&document.dispatchEvent(new CustomEvent("gp:player.display_mode_changed",{detail:{displayMode:this.isExpanded?GPTimelapsePlayer_.DISPLAY_MODE.EXPANDED:GPTimelapsePlayer_.DISPLAY_MODE.NORMAL}}))}playPause(){this.isPlaying?this.pause():this.play()}play(a=this.pos){a||this.clearCanvas();this.isPlaying=!0;this.updateProgress();this.player.classList.add("playing_");setTimeout(()=>{this.player.classList.remove("finished_")},24);this.timer=requestAnimationFrame(this.drawing)}pause(){this.isPlaying=
!1;cancelAnimationFrame(this.timer);this.player.classList.remove("playing_")}stop(){this.pause();this.pos=0;this.updateProgress()}seek(a){this.pause();a=Math.max(0,Math.min(this.data.length,a));if(a!==this.pos||!a){this.clearStroke();if(a<this.pos||!this.pos){this.clearCanvas();var b=this.data.slice(0,a)}else b=this.data.slice(this.pos,a);this.draw(this.ctx,b);this.pos=a;this.sPos=0;this.stroke=null;this.updateStrokeView()}}drawing(){if(this.stroke)this.drawingStroke(this.stroke);else if(this.pos<
this.data.length){const a=this.data.slice(this.pos,this.pos+this.speed[1]),b=a.at(-1);this.speed[0]&&[1,2].includes(b[0])?(this.sPos=0,this.stroke=b,this.drawingStroke(b)):(this.draw(this.ctx,a),this.pos=Math.min(this.data.length,this.pos+this.speed[1]),this.pos<this.data.length?this.timer=requestAnimationFrame(this.drawing):(this.player.classList.add("finished_"),this.pause()),this.updateProgress(),this.updateStrokeView())}else this.pos=0,this.updateProgress(),this.play()}drawingStroke(a){if(this.speed[0]&&
this.sPos<a.length-GPTimelapsePlayer_.STROKE_OFFSET){const b=a.slice(0,GPTimelapsePlayer_.STROKE_OFFSET+this.sPos+1);this.sPos+=this.speed[0];this.clearStroke();this.draw(this.strokeCtx,[b],this.density,!1);this.timer=requestAnimationFrame(()=>{this.drawingStroke(a)})}else this.sPos=0,this.pos=Math.min(this.data.length,this.pos+this.speed[1]),this.clearStroke(),this.draw(this.ctx,[a]),this.updateProgress(),this.updateStrokeView(),this.stroke=null,this.pos<this.data.length?this.timer=requestAnimationFrame(this.drawing):
(this.player.classList.add("finished_"),this.pause())}changeSpeed(a,b){this.currentSpeed=Math.max(0,Math.min(GPTimelapsePlayer_.SPEEDS.length-1,b??this.currentSpeed+a));this.speed=GPTimelapsePlayer_.SPEEDS[this.currentSpeed];localStorage.setItem("gp-timelapse-player-speed",JSON.stringify(this.currentSpeed));this.updateSpeedView()}speedViewPointerMoveHandler(a){a=(a.clientX-this.player.getBoundingClientRect().x)/this.scaleX;a=Math.round(Math.max(0,Math.min(GPTimelapsePlayer_.SPEED_SLIDER_WIDTH-GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH,
a-this.speedInput.currentX))/((GPTimelapsePlayer_.SPEED_SLIDER_WIDTH-GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH)/(GPTimelapsePlayer_.SPEEDS.length-1)));this.speedInput.value=a;this.changeSpeed(null,a)}renderSpeedInput(a,b){if(!this.speedInput){this.speedInput=document.createElement("input");this.speedInput.className="speed-slider_";this.speedInput.type="range";this.speedInput.min=0;this.speedInput.max=GPTimelapsePlayer_.SPEEDS.length-1;this.speedInput.style.width=`${GPTimelapsePlayer_.SPEED_SLIDER_WIDTH}px`;
this.speedInput.style.height=`${GPTimelapsePlayer_.SPEED_SLIDER_HEIGHT}px`;var c=GPTimelapsePlayer_.SPEEDS.findIndex(([e])=>!e);this.speedInput.style.setProperty("--bg-separator",`${Math.round(c/GPTimelapsePlayer_.SPEEDS.length*100)+Math.round(GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH/GPTimelapsePlayer_.SPEED_SLIDER_WIDTH*100)/2}%`)}this.speedInput.value=this.currentSpeed;c=(GPTimelapsePlayer_.SPEED_SLIDER_WIDTH-GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH)/(GPTimelapsePlayer_.SPEEDS.length-1)*Number(this.speedInput.value);
this.speedInput.style.top=`${b-GPTimelapsePlayer_.SPEED_SLIDER_HEIGHT-10}px`;this.speedInput.style.left=`${a-c-GPTimelapsePlayer_.SPEED_SLIDER_THUMB_WIDTH/2}px`;this.player.appendChild(this.speedInput);this.speedInput.currentX=a-c}clearBackground(){this.bgCtx.fillStyle=GPTimelapsePlayer_.BACKGROUND_COLOR;this.bgCtx.fillRect(0,0,this.width,this.height)}clearCanvas(){this.ctx.clearRect(0,0,this.width,this.height)}clearStroke(){this.strokeCtx.clearRect(0,0,this.width,this.height)}updateProgress(a=this.pos){this.progress.style.width=
`${Math.round(a/this.data.length*100)}%`}splitStroke(a){const [b,c,e,...d]=a;if(1===b||2===b){a=[];for(let f=1;f<=d.length;f++)a.push([b,c,e,...d.slice(0,f)]);return a}return[a]}getCoords(a,b){b=(b||a.target).getBoundingClientRect();const [c,e]=a.touches?[a.touches[0].clientX,a.touches[0].clientY]:[a.clientX,a.clientY],[d,f]=[c-b.left,e-b.top];return[Math.round(d),Math.round(f),b.width,b.height]}progressBarPointerMoveHandler(a){const [b,,c]=this.getCoords(a);a=Math.max(0,Math.min(1,b/c));const e=
Math.round(this.data.length*a);this.progress.style.width=`${100*a}%`;this.seek(e)}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():(this.expandStateBeforeFullscreen=this.isExpanded,this.expand(!1),this.player.requestFullscreen())}saveImage(){var a=document.createElement("canvas");a.width=this.width;a.height=this.height;var b=a.getContext("2d");this.draw(b,this.data,this.density,this.eraserAlpha);b=document.createElement("canvas");b.width=this.width;b.height=this.height;var c=
b.getContext("2d");c.fillStyle=GPTimelapsePlayer_.BACKGROUND_COLOR;c.fillRect(0,0,this.width,this.height);if(this.background){var e=this.getCache();this.cache[this.density]?(e=e.at(-1),c.putImageData(e,0,0)):this.drawFunction(c,this.background,this.density,!1)}c=document.createElement("canvas");c.width=this.width;c.height=this.height;e=c.getContext("2d");e.drawImage(b,0,0,this.width,this.height);e.drawImage(a,0,0,this.width,this.height);a=this.date.toLocaleDateString("ru-RU");a=`${this.author} - ${this.title} (${a}).png`;
b=document.createElement("a");b.href=c.toDataURL();b.download=a;b.click()}async saveImageData(){var a=this.date.toLocaleDateString("ru-RU");a=`${this.author} - ${this.title} (${a}).gpimg`;var b={m:{a:this.author,t:this.title,d:this.date.toISOString()},d:this.originalData};this.background&&(b.b=this.background);this.auth&&(b.a=this.auth);b=await GPUtils_.wCompressData(b);GPUtils_.saveBlob(b,a)}getCache(){this.cache?.[this.density]||this.updateCache();return this.cache[this.density]}updateCache(){const a=
this.cache||{};a[this.density]||this.worker.postMessage({type:"get-cache",density:this.density});this.cache=a}draw(a,b,c,e,d=!0){if(b){var f=GPTimelapsePlayer_.CACHE_INTERVAL;if(GPTimelapsePlayer_.CACHE_ENABLED&&d&&b.length>f)if(d=this.getCache(),!this.cache[this.density]&&b.at(-1).index+1<f)this.drawFunction(a,b,c,e);else{const g=Math.floor((b.at(-1).index+1)/f)-1;a.putImageData(d[g],0,0);b=b.slice(-(b.at(-1).index+1-(g+1)*f));this.drawFunction(a,b,c,e)}else this.drawFunction(a,b,c,e)}}drawFunction(a,
b,c=this.density,e=this.eraserAlpha,d=!1){GPUtils_.drawFunction(a,b,c,e,d)}handleDelimiters(a,b){const c=a.findLastIndex(e=>11===e[0]);if(~c){const e=a.slice(c+1);a=(b??[]).concat(a.slice(0,c).filter(d=>11!==d[0]));return[e,a,!0]}return[a,b,!1]}initCacheWorker(){let {width:a,height:b}=getComputedStyle(this.container);a=parseInt(a);b=parseInt(b);var {density:c}=this.getDensityByDimensions(a,b);let {width:e,height:d}=getComputedStyle(this.mainContainer);e=parseInt(e);d=parseInt(d);const {density:f}=
this.getDensityByDimensions(e,d),{density:g}=this.getDensityByDimensions(window.screen.width,window.screen.height),h=[...(new Set([c,f,g]))];this.worker||(c=URL.createObjectURL(new Blob([this.getFuncBody(this.cacheWorkerBody)])),this.worker=new Worker(c),URL.revokeObjectURL(c),this.worker.addEventListener("message",({data:k})=>{"worker-ready"===k.type?h.forEach(l=>{this.worker.postMessage({type:"get-cache",density:l})}):"cache-updated"===k.type&&(this.cache=k.cache,this.dispatchEvent(new CustomEvent("cache-updated",
{detail:{density:k.density}})))}));this.worker.postMessage({type:"init",data:this.data,background:this.background,eraserAlpha:this.eraserAlpha,drawFunctionString:GPUtils_.drawFunctionString,fi:this.fi,CACHE_INTERVAL:GPTimelapsePlayer_.CACHE_INTERVAL,ORIGINAL_WIDTH:GPTimelapsePlayer_.ORIGINAL_WIDTH,ORIGINAL_HEIGHT:GPTimelapsePlayer_.ORIGINAL_HEIGHT,BACKGROUND_COLOR:GPTimelapsePlayer_.BACKGROUND_COLOR})}cacheWorkerBody(){function a(f){var g=b*f,h=c*f;if(!this.cache[f]){this.cache[f]=[];const l=d,p=
Math.floor(self.data.length/l);g=new OffscreenCanvas(g,h);h=g.getContext("2d",{willReadFrequently:!0});let n;self.background&&(h.fillStyle=e,h.fillRect(0,0,g.width,g.height),self.draw(h,this.background,f,!1),n=h.getImageData(0,0,g.width,g.height),h.clearRect(0,0,g.width,g.height));for(let m=0;m<p;m++){var k=m*l;k=self.data.slice(k,k+l);self.draw(h,k,f,self.eraserAlpha);k=h.getImageData(0,0,g.width,g.height);this.cache[f].push(k)}self.background&&this.cache[f].push(n)}}let b,c,e,d;self.data;self.draw;
self.cache=[];self.addEventListener("message",({data:f})=>{"init"===f.type?(self.data=f.data,self.background=f.background,self.eraserAlpha=f.eraserAlpha,self.fi=f.fi,self.draw=(new Function(`return ${f.drawFunctionString}`))(),d=f.CACHE_INTERVAL,b=f.ORIGINAL_WIDTH,c=f.ORIGINAL_HEIGHT,e=f.BACKGROUND_COLOR,self.postMessage({type:"worker-ready"})):"get-cache"===f.type&&(self.cache[f.density]||a(f.density),self.postMessage({type:"cache-updated",cache:self.cache,density:f.density}))})}getFuncBody(a){a=
a.toString();return a.substring(a.indexOf("{")+1,a.lastIndexOf("}"))}}window.GPTimelapsePlayer_=GPTimelapsePlayer_;const GP_IMAGE_PROTOCOL="web+gpimg",GP_FILE_FORMAT="gpimg",URL_PATTERN=new RegExp(`^https?:\\/\\/.+\\.${GP_FILE_FORMAT}\\b\\??`,"i"),L10N={ru:{DROP_ZONE_MSG:["\u041f\u0435\u0440\u0435\u043d\u0435\u0441\u0438\u0442\u0435 \u0438\u0441\u0445\u043e\u0434\u043d\u0438\u043a \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f \u043d\u0430 \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443 \u0438\u043b\u0438","\u0432\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0444\u0430\u0439\u043b","\u0441 \u043a\u043e\u043c\u043f\u044c\u044e\u0442\u0435\u0440\u0430"]},
en:{DROP_ZONE_MSG:["Drag the Process File here or","select a file","from your device"]},es:{DROP_ZONE_MSG:["Arrastre el Archivo de Proceso aqu\u00ed o","seleccione un archivo","de su dispositivo"]}},DISPLAY_MODE={NORMAL:"normal",EXPANDED:"expanded"},STORAGE="gp_player",DEFAULT_SETTINGS={displayMode:DISPLAY_MODE.NORMAL},DEFAULT_LANGUAGE="en",LANGUAGE=navigator.language.split("-")[0],L=L10N[LANGUAGE]??L10N[DEFAULT_LANGUAGE],settings=Object.assign({},DEFAULT_SETTINGS,JSON.parse(localStorage.getItem(STORAGE))??
{});let playerWrapper,mainContainer,playerContainer,player,playerTitle;window.addEventListener("resize",handleResize);document.addEventListener("mousedown",a=>{1===a.button&&a.preventDefault()});document.addEventListener("source_request_complete",async({detail:{success:a,blob:b}})=>{a?(a=await GPUtils_.decompressFile(b),a=parseImageData(a),renderPlayer(a)):hideLoadingSpinner()});document.addEventListener("download_source",({detail:{url:a}})=>{URL_PATTERN.test(a)&&downloadSource(a)});
"launchQueue"in window&&"files"in LaunchParams.prototype&&launchQueue.setConsumer(async a=>{a.files.length&&(a=await a.files[0].getFile(),a=new File([a],a.name||"",{type:a.type}),isGPFile(a))&&(a=await GPUtils_.decompressFile(a),a=parseImageData(a),renderPlayer(a),history.replaceState({},document.title,location.pathname))});
document.addEventListener("paste",async a=>{if(("INPUT"!==document.activeElement.tagName||"text"!==document.activeElement.type&&"search"!==document.activeElement.type)&&"TEXTAREA"!==document.activeElement.tagName&&(a.preventDefault(),a.clipboardData.items.length)){var b=Array.from(a.clipboardData.files).find(c=>isGPFile(c));b?(a=await GPUtils_.decompressFile(b),a=parseImageData(a),renderPlayer(a)):(a=Array.from(a.clipboardData.items).find(c=>"text/plain"===c.type))&&a.getAsString(c=>{URL_PATTERN.test(c)&&
downloadSource(c)})}});document.addEventListener("force_resize",a=>{forceResize()});document.addEventListener("gp:player.display_mode_changed",({detail:{displayMode:a}})=>{Object.assign(settings,{displayMode:a});saveSettings()});removeNoModMsg();render();handleResize();handleQuery();
function handleQuery(){if(location.search){const a=new Map;location.search.slice(1).split("&").forEach(c=>{const [e,d]=c.split("=");a.set(decodeURIComponent(e),decodeURIComponent(d))});let b=a.get("url");b.startsWith(`${GP_IMAGE_PROTOCOL}://`)&&(b=b.slice(GP_IMAGE_PROTOCOL.length+3));URL_PATTERN.test(b)&&downloadSource(b)}}
function render(){playerWrapper=document.createElement("div");playerWrapper.className="player-wrapper";mainContainer=document.createElement("div");mainContainer.className="main-container";playerWrapper.appendChild(mainContainer);playerContainer=document.createElement("div");playerContainer.innerHTML='<div class="placeholder"></div>';playerContainer.className="player-container";mainContainer.appendChild(playerContainer);var a=document.createElement("div");a.className="drop-zone";a.dataset.lang=L10N[LANGUAGE]?
LANGUAGE:DEFAULT_LANGUAGE;a.innerHTML=`<span class="label">${L.DROP_ZONE_MSG[0]} <input type="file" id="select-file" accept=".${GP_FILE_FORMAT}"><label class="select-file-label" for="select-file">${L.DROP_ZONE_MSG[1]}</label> ${L.DROP_ZONE_MSG[2]}</span>`;mainContainer.appendChild(a);a.querySelector("#select-file").addEventListener("change",async b=>{var c=b.target.files?.[0];c&&isGPFile(c)&&(c=await GPUtils_.decompressFile(c),c=parseImageData(c),renderPlayer(c),history.replaceState({},document.title,
location.pathname));b.target.value=""});a=document.documentElement;a.addEventListener("dropenter",b=>{},!0);a.addEventListener("dropleave",b=>{},!0);a.addEventListener("drop",async b=>{b.preventDefault();if(b.dataTransfer.items.length){var c=Array.from(b.dataTransfer.files).find(e=>isGPFile(e));c?(b=await GPUtils_.decompressFile(c),b=parseImageData(b),renderPlayer(b),history.replaceState({},document.title,location.pathname)):(b=Array.from(b.dataTransfer.items).find(e=>"text/uri-list"===e.type))&&
b.getAsString(e=>{URL_PATTERN.test(e)&&downloadSource(e)})}},!0);a.addEventListener("dragover",b=>{b.preventDefault();b.dataTransfer.dropEffect="move"},!0);playerTitle=document.createElement("div");playerTitle.className="title";mainContainer.appendChild(playerTitle);document.body.appendChild(playerWrapper)}
function renderPlayer({background:a,data:b,auth:c,meta:{author:e,title:d,date:f}}){GPTimelapsePlayer_.closeAll();mainContainer.classList.add("player");clearTitle();showLoadingSpinner();player=new GPTimelapsePlayer_({image:{data:b,background:a,auth:c,meta:{author:e,title:d,date:f}},container:playerContainer,mainContainer},settings.displayMode);player.addEventListener("data-loaded",({detail:{author:g,title:h,date:k}})=>{setTitle(g,h,k)});player.addEventListener("image-rendered",g=>{hideLoadingSpinner()},
{once:!0});player.addEventListener("terminated",g=>{mainContainer.classList.remove("player");clearTitle()},{once:!0})}function handleResize(a){mainContainer.style.transform=`scale(${getScale()})`}function getScale(){let a=(playerWrapper.clientWidth-180)/1150;766*a>playerWrapper.clientHeight&&(a=playerWrapper.clientHeight/766);return Math.min(1,a)}function isGPFile(a){return a.name.toLowerCase().endsWith(`.${GP_FILE_FORMAT}`)}
function downloadSource(a){document.dispatchEvent(new CustomEvent("source_request",{detail:{url:a}}));showLoadingSpinner()}function parseImageData(a){const {b,d:c,a:e,m:{a:d,t:f,d:g}}=a;return{background:b,data:c,auth:e,meta:{author:d,title:f,date:g}}}function showLoadingSpinner(){document.documentElement.classList.add("loading")}function hideLoadingSpinner(){document.documentElement.classList.remove("loading")}function removeNoModMsg(){const a=document.getElementById("no-mod");a&&a.remove()}
function setTitle(a,b,c){c=(new Date(c)).toLocaleDateString("default",{year:"numeric",month:"long",day:"numeric"});a=`${a} - ${b} (${c})`;playerTitle.textContent=a;playerTitle.title=a}function clearTitle(){playerTitle.textContent="";playerTitle.title=""}function forceResize(){player?.resizeHandler()}function saveSettings(){localStorage.setItem(STORAGE,JSON.stringify(settings))};
}).call(this)
